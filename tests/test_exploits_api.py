"""
Unit tests for Exploits API
"""

import pytest
from flask import Flask
from extensions import db
from models import ExploitExecutionLog
from routes.exploits import bp as exploits_bp

@pytest.fixture
def app():
    """Create test Flask application"""
    app = Flask(__name__)
    app.config['TESTING'] = True
    app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///:memory:'
    app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
    
    db.init_app(app)
    app.register_blueprint(exploits_bp)
    
    with app.app_context():
        db.create_all()
        yield app
        db.drop_all()

@pytest.fixture
def client(app):
    """Create test client"""
    return app.test_client()

def test_list_exploits(client):
    """Test listing available exploits"""
    response = client.get('/exploits/list')
    assert response.status_code == 200
    data = response.get_json()
    assert 'exploits' in data
    assert 'total' in data

def test_list_chains(client):
    """Test listing attack chains"""
    response = client.get('/exploits/chains')
    assert response.status_code == 200
    data = response.get_json()
    assert 'chains' in data
    assert 'total' in data

def test_get_execution_status(client):
    """Test getting execution status"""
    # Create test execution
    with client.application.app_context():
        execution = ExploitExecutionLog(
            execution_id='test-execution-123',
            scenario_id='test-scenario',
            user_id='test-user',
            status='running'
        )
        db.session.add(execution)
        db.session.commit()
    
    response = client.get('/exploits/status/test-execution-123')
    assert response.status_code == 200
    data = response.get_json()
    assert data['execution_id'] == 'test-execution-123'
    assert data['status'] == 'running'

def test_execute_exploit_missing_script(client):
    """Test executing exploit with missing script"""
    response = client.post('/exploits/execute/test-scenario', json={
        'user_id': 'test-user',
        'script_path': 'nonexistent/script.py'
    })
    assert response.status_code == 404
