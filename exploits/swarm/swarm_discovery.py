#!/usr/bin/env python3
"""
Swarm Discovery
Discover and map drone swarm topology and communication patterns

Discovers multiple drones operating as a swarm, identifies the swarm
controller, and maps communication patterns between swarm members.

CVSS Score: 5.5 (Medium)
Affected: Drone swarms (multiple manufacturers)
"""

import sys
import socket
import struct
import time
from typing import List, Dict, Tuple

# Common MAVLink ports
MAVLINK_PORTS = [14550, 14540, 14560, 14580, 5760, 5762, 5763]

def scan_network_for_swarm(network_base: str = "10.13.0") -> List[Dict]:
    """
    Scan network for multiple drones (swarm)
    
    Args:
        network_base: Network base (e.g., "10.13.0")
    
    Returns:
        List of discovered drone information
    """
    discovered_drones = []
    
    print(f"[*] Scanning {network_base}.0/24 for drone swarm...")
    
    for host in range(1, 255):
        ip = f"{network_base}.{host}"
        for port in MAVLINK_PORTS:
            if check_mavlink_port(ip, port):
                print(f"[+] Found MAVLink service at {ip}:{port}")
                
                # Try to identify device
                device_info = identify_device(ip, port)
                if device_info:
                    device_info['ip'] = ip
                    device_info['port'] = port
                    discovered_drones.append(device_info)
                    print(f"    Type: {device_info.get('type', 'Unknown')}")
                    print(f"    Autopilot: {device_info.get('autopilot', 'Unknown')}")
    
    return discovered_drones

def check_mavlink_port(ip: str, port: int, timeout: float = 1.0) -> bool:
    """Check if a port is running MAVLink service"""
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        sock.settimeout(timeout)
        sock.connect((ip, port))
        sock.close()
        return True
    except:
        return False

def identify_device(ip: str, port: int) -> Dict:
    """Identify device type and characteristics"""
    try:
        from pymavlink import mavutil
        
        # Use helper function for connection
        from pathlib import Path
        import sys
        sys.path.insert(0, str(Path(__file__).parent.parent / 'utils'))
        from mavlink_helper import connect_to_drone
        
        connection = connect_to_drone(f'udp:{ip}:{port}', timeout=2)
        if connection is None:
            return None
        
        msg = connection.recv_match(type='HEARTBEAT', blocking=True, timeout=1)
        if msg:
            autopilot_map = {
                1: 'Generic',
                3: 'ArduPilot',
                4: 'PX4',
                8: 'OpenPilot',
                12: 'PX4'
            }
            
            return {
                'type': 'Flight Controller',
                'autopilot': autopilot_map.get(msg.autopilot, 'Unknown'),
                'system_id': msg.get_srcSystem(),
                'mavlink_version': msg.mavlink_version
            }
    except:
        pass
    
    return None

def analyze_swarm_topology(drones: List[Dict]) -> Dict:
    """
    Analyze swarm topology and identify controller
    
    Args:
        drones: List of discovered drones
    
    Returns:
        Swarm topology information
    """
    print()
    print("[*] Analyzing swarm topology...")
    
    topology = {
        'total_drones': len(drones),
        'drones': drones,
        'controller': None,
        'communication_patterns': []
    }
    
    # Identify potential controller (usually first discovered or has specific characteristics)
    if drones:
        # Controller often has system_id = 1 or is first in network
        for drone in drones:
            if drone.get('system_id') == 1:
                topology['controller'] = drone
                print(f"[+] Swarm controller identified: {drone.get('ip')}:{drone.get('port')}")
                break
        
        if not topology['controller']:
            topology['controller'] = drones[0]
            print(f"[*] Assuming first drone as controller: {drones[0].get('ip')}:{drones[0].get('port')}")
    
    # Analyze communication patterns
    print(f"[*] Swarm size: {len(drones)} drones")
    print(f"[*] Communication ports: {set(d['port'] for d in drones)}")
    
    # Group by autopilot type
    autopilot_groups = {}
    for drone in drones:
        autopilot = drone.get('autopilot', 'Unknown')
        if autopilot not in autopilot_groups:
            autopilot_groups[autopilot] = []
        autopilot_groups[autopilot].append(drone)
    
    print(f"[*] Autopilot distribution:")
    for autopilot, group in autopilot_groups.items():
        print(f"    {autopilot}: {len(group)} drones")
    
    return topology

def discover_swarm(network: str = "10.13.0.0/24"):
    """
    Main swarm discovery function
    
    Args:
        network: Network to scan (CIDR notation or network base)
    """
    try:
        print("="*70)
        print("SWARM DISCOVERY")
        print("="*70)
        print()
        
        # Extract network base
        if '/' in network:
            network_base = network.split('/')[0].rsplit('.', 1)[0]
        else:
            network_base = network.rsplit('.', 1)[0] if '.' in network else network
        
        # Scan for drones
        drones = scan_network_for_swarm(network_base)
        
        if not drones:
            print("[-] No drones discovered on network")
            return None
        
        print(f"[+] Discovered {len(drones)} drone(s)")
        
        # Analyze topology
        topology = analyze_swarm_topology(drones)
        
        print()
        print("[+] Swarm discovery completed")
        print(f"    Total drones: {topology['total_drones']}")
        if topology['controller']:
            print(f"    Controller: {topology['controller'].get('ip')}:{topology['controller'].get('port')}")
        
        return topology
        
    except Exception as e:
        print(f"[-] Swarm discovery failed: {e}")
        return None

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 swarm_discovery.py <network>")
        print("\nArguments:")
        print("  network      Network to scan (e.g., 10.13.0.0/24 or 10.13.0)")
        print("\nExamples:")
        print("  python3 swarm_discovery.py 10.13.0.0/24")
        print("  python3 swarm_discovery.py 10.13.0")
        print("\nSwarm Discovery")
        print("CVSS Score: 5.5 (Medium)")
        print("Affected: Drone swarms (multiple manufacturers)")
        sys.exit(1)
    
    network = sys.argv[1]
    discover_swarm(network)

if __name__ == "__main__":
    main()
