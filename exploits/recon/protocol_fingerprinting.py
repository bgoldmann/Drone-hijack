#!/usr/bin/env python3
"""
Protocol Fingerprinting Exploit Script
Analyzes MAVLink heartbeat messages to identify system capabilities
"""

import sys
import time
from pymavlink import mavutil

def fingerprint_system(connection):
    """
    Fingerprint MAVLink system from heartbeat messages
    
    Args:
        connection: MAVLink connection object
    
    Returns:
        Dictionary with system information
    """
    print("[*] Fingerprinting MAVLink system...")
    
    info = {
        'system_id': None,
        'component_id': None,
        'vehicle_type': None,
        'autopilot': None,
        'base_mode': None,
        'custom_mode': None,
        'system_status': None,
        'mavlink_version': None,
        'capabilities': {}
    }
    
    # Collect multiple heartbeats for comprehensive info
    heartbeats = []
    timeout = time.time() + 10
    
    while time.time() < timeout and len(heartbeats) < 5:
        msg = connection.recv_match(type='HEARTBEAT', blocking=True, timeout=2)
        if msg:
            heartbeats.append(msg)
            if not info['system_id']:
                info['system_id'] = msg.get_srcSystem()
                info['component_id'] = msg.get_srcComponent()
                info['vehicle_type'] = msg.type
                info['autopilot'] = msg.autopilot
                info['base_mode'] = msg.base_mode
                info['custom_mode'] = msg.custom_mode
                info['system_status'] = msg.system_status
                info['mavlink_version'] = msg.mavlink_version
    
    if not heartbeats:
        print("[-] No heartbeat messages received")
        return None
    
    # Analyze capabilities from base_mode
    base_mode = info['base_mode']
    info['capabilities'] = {
        'armed': bool(base_mode & mavutil.mavlink.MAV_MODE_FLAG_ARMED),
        'guided': bool(base_mode & mavutil.mavlink.MAV_MODE_FLAG_GUIDED_ENABLED),
        'stabilize': bool(base_mode & mavutil.mavlink.MAV_MODE_FLAG_STABILIZE_ENABLED),
        'hil': bool(base_mode & mavutil.mavlink.MAV_MODE_FLAG_HIL_ENABLED),
        'manual': bool(base_mode & mavutil.mavlink.MAV_MODE_FLAG_MANUAL_INPUT_ENABLED),
        'safety': bool(base_mode & mavutil.mavlink.MAV_MODE_FLAG_SAFETY_ARMED),
        'test': bool(base_mode & mavutil.mavlink.MAV_MODE_FLAG_TEST_ENABLED),
        'custom': bool(base_mode & mavutil.mavlink.MAV_MODE_FLAG_CUSTOM_MODE_ENABLED)
    }
    
    # Get flight mode name
    try:
        flight_mode = mavutil.mode_string_v10(heartbeats[0])
        info['flight_mode'] = flight_mode
    except:
        info['flight_mode'] = 'Unknown'
    
    # Map autopilot types
    autopilot_names = {
        mavutil.mavlink.MAV_AUTOPILOT_GENERIC: 'Generic',
        mavutil.mavlink.MAV_AUTOPILOT_PIXHAWK: 'Pixhawk',
        mavutil.mavlink.MAV_AUTOPILOT_SLUGS: 'SLUGS',
        mavutil.mavlink.MAV_AUTOPILOT_ARDUPILOTMEGA: 'ArduPilot',
        mavutil.mavlink.MAV_AUTOPILOT_OPENPILOT: 'OpenPilot',
        mavutil.mavlink.MAV_AUTOPILOT_GENERIC_MISSION_ONLY: 'Generic Mission',
        mavutil.mavlink.MAV_AUTOPILOT_GENERIC_WAYPOINTS_ONLY: 'Generic Waypoints',
        mavutil.mavlink.MAV_AUTOPILOT_GENERIC_WAYPOINTS_AND_SIMPLE_NAVIGATION_ONLY: 'Generic Simple Nav',
        mavutil.mavlink.MAV_AUTOPILOT_GENERIC_MISSION_FULL: 'Generic Mission Full',
        mavutil.mavlink.MAV_AUTOPILOT_INVALID: 'Invalid',
        mavutil.mavlink.MAV_AUTOPILOT_PPZ: 'PPZ',
        mavutil.mavlink.MAV_AUTOPILOT_UDB: 'UDB',
        mavutil.mavlink.MAV_AUTOPILOT_FP: 'FP',
        mavutil.mavlink.MAV_AUTOPILOT_PX4: 'PX4',
        mavutil.mavlink.MAV_AUTOPILOT_SMACCMPILOT: 'SMACCMPilot',
        mavutil.mavlink.MAV_AUTOPILOT_AUTOQUAD: 'AutoQuad',
        mavutil.mavlink.MAV_AUTOPILOT_ARMAZILA: 'Armazila',
        mavutil.mavlink.MAV_AUTOPILOT_AEROB: 'Aerob',
        mavutil.mavlink.MAV_AUTOPILOT_ASLUAV: 'ASLUAV',
        mavutil.mavlink.MAV_AUTOPILOT_SMARTAP: 'SmartAP',
        mavutil.mavlink.MAV_AUTOPILOT_AIRRAILS: 'AirRails'
    }
    
    info['autopilot_name'] = autopilot_names.get(info['autopilot'], 'Unknown')
    
    # Map vehicle types
    vehicle_type_names = {
        mavutil.mavlink.MAV_TYPE_GENERIC: 'Generic',
        mavutil.mavlink.MAV_TYPE_FIXED_WING: 'Fixed Wing',
        mavutil.mavlink.MAV_TYPE_QUADROTOR: 'Quadrotor',
        mavutil.mavlink.MAV_TYPE_COAXIAL: 'Coaxial',
        mavutil.mavlink.MAV_TYPE_HELICOPTER: 'Helicopter',
        mavutil.mavlink.MAV_TYPE_ANTENNA_TRACKER: 'Antenna Tracker',
        mavutil.mavlink.MAV_TYPE_GCS: 'Ground Control Station',
        mavutil.mavlink.MAV_TYPE_AIRSHIP: 'Airship',
        mavutil.mavlink.MAV_TYPE_FREE_BALLOON: 'Free Balloon',
        mavutil.mavlink.MAV_TYPE_ROCKET: 'Rocket',
        mavutil.mavlink.MAV_TYPE_GROUND_ROVER: 'Ground Rover',
        mavutil.mavlink.MAV_TYPE_SURFACE_BOAT: 'Surface Boat',
        mavutil.mavlink.MAV_TYPE_SUBMARINE: 'Submarine',
        mavutil.mavlink.MAV_TYPE_HEXAROTOR: 'Hexarotor',
        mavutil.mavlink.MAV_TYPE_OCTOROTOR: 'Octorotor',
        mavutil.mavlink.MAV_TYPE_TRICOPTER: 'Tricopter',
        mavutil.mavlink.MAV_TYPE_FLAPPING_WING: 'Flapping Wing',
        mavutil.mavlink.MAV_TYPE_KITE: 'Kite',
        mavutil.mavlink.MAV_TYPE_ONBOARD_CONTROLLER: 'Onboard Controller',
        mavutil.mavlink.MAV_TYPE_VTOL_DUOROTOR: 'VTOL Duorotor',
        mavutil.mavlink.MAV_TYPE_VTOL_QUADROTOR: 'VTOL Quadrotor',
        mavutil.mavlink.MAV_TYPE_VTOL_TILTROTOR: 'VTOL Tiltrotor',
        mavutil.mavlink.MAV_TYPE_VTOL_FIXEDROTOR: 'VTOL Fixedrotor',
        mavutil.mavlink.MAV_TYPE_VTOL_TAILSITTER: 'VTOL Tailsitter',
        mavutil.mavlink.MAV_TYPE_VTOL_RESERVED4: 'VTOL Reserved4',
        mavutil.mavlink.MAV_TYPE_VTOL_RESERVED5: 'VTOL Reserved5',
        mavutil.mavlink.MAV_TYPE_GIMBAL: 'Gimbal',
        mavutil.mavlink.MAV_TYPE_ADSB: 'ADSB',
        mavutil.mavlink.MAV_TYPE_PARAFOIL: 'Parafoil',
        mavutil.mavlink.MAV_TYPE_DODECAROTOR: 'Dodecarotor',
        mavutil.mavlink.MAV_TYPE_CAMERA: 'Camera',
        mavutil.mavlink.MAV_TYPE_CHARGING_STATION: 'Charging Station',
        mavutil.mavlink.MAV_TYPE_FLARM: 'FLARM',
        mavutil.mavlink.MAV_TYPE_SERVO: 'Servo',
        mavutil.mavlink.MAV_TYPE_ODID: 'ODID',
        mavutil.mavlink.MAV_TYPE_DECAROTOR: 'Decarotor'
    }
    
    info['vehicle_type_name'] = vehicle_type_names.get(info['vehicle_type'], 'Unknown')
    
    return info

def display_fingerprint(info):
    """Display fingerprint information"""
    print("\n" + "=" * 60)
    print("MAVLink System Fingerprint")
    print("=" * 60)
    print(f"System ID: {info['system_id']}")
    print(f"Component ID: {info['component_id']}")
    print(f"Vehicle Type: {info['vehicle_type']} ({info['vehicle_type_name']})")
    print(f"Autopilot: {info['autopilot']} ({info['autopilot_name']})")
    print(f"MAVLink Version: {info['mavlink_version']}")
    print(f"Flight Mode: {info['flight_mode']}")
    print(f"System Status: {info['system_status']}")
    print(f"Base Mode: {info['base_mode']} (0x{info['base_mode']:02x})")
    print(f"Custom Mode: {info['custom_mode']}")
    
    print("\nCapabilities:")
    for capability, enabled in info['capabilities'].items():
        status = "✓" if enabled else "✗"
        print(f"  {status} {capability}")
    
    print("\nSecurity Assessment:")
    if info['mavlink_version'] == 1:
        print("  [!] MAVLink 1.0: No authentication or encryption")
    elif info['mavlink_version'] == 2:
        print("  [!] MAVLink 2.0: Authentication/encryption optional")
    
    if not info['capabilities'].get('safety'):
        print("  [!] Safety not armed (may be vulnerable)")
    
    print("=" * 60)

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 protocol_fingerprinting.py <connection>")
        print("Example: python3 protocol_fingerprinting.py udp:127.0.0.1:14550")
        sys.exit(1)
    
    connection_string = sys.argv[1]
    
    # Use helper function for connection
    import sys
    from pathlib import Path
    sys.path.insert(0, str(Path(__file__).parent.parent / 'utils'))
    from mavlink_helper import connect_to_drone
    
    print(f"[*] Connecting to {connection_string}...")
    connection = connect_to_drone(connection_string, timeout=5)
    if connection is None:
        sys.exit(1)
    print("[+] Connected to vehicle")
    
    # Fingerprint system
    info = fingerprint_system(connection)
    
    if info:
        display_fingerprint(info)
    else:
        print("[-] Failed to fingerprint system")
        sys.exit(1)

if __name__ == "__main__":
    main()
