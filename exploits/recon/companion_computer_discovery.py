#!/usr/bin/env python3
"""
Companion Computer Discovery Script
Scans companion computer for exposed services and vulnerabilities
"""

import sys
import socket
import requests
from typing import List, Tuple, Dict

# Common companion computer ports
COMPANION_PORTS = {
    'SSH': 22,
    'HTTP': 80,
    'HTTPS': 443,
    'FTP': 21,
    'RTSP': 554,
    'MAVLink': 14550,
    'ROS': 11311,
    'Companion Web': 3000,
    'VNC': 5900,
    'Telnet': 23,
}

def scan_companion_computer(host: str, ports: List[int] = None) -> List[Tuple[int, str, Dict]]:
    """
    Scan companion computer for open ports and services
    
    Args:
        host: Companion computer IP or hostname
        ports: List of ports to scan (default: all companion ports)
    
    Returns:
        List of (port, service, info) tuples
    """
    if ports is None:
        ports = list(COMPANION_PORTS.values())
    
    discovered = []
    
    print(f"[*] Scanning companion computer: {host}")
    print(f"[*] Checking {len(ports)} ports...")
    print()
    
    for port in ports:
        if check_port(host, port):
            service_name = None
            for name, p in COMPANION_PORTS.items():
                if p == port:
                    service_name = name
                    break
            
            if service_name is None:
                service_name = 'Unknown'
            
            print(f"[+] Port {port} ({service_name}) is open")
            
            # Get service information
            info = get_service_info(host, port, service_name)
            discovered.append((port, service_name, info))
    
    return discovered

def check_port(host: str, port: int, timeout: float = 1.0) -> bool:
    """Check if a port is open"""
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(timeout)
        result = sock.connect_ex((host, port))
        sock.close()
        return result == 0
    except Exception:
        return False

def get_service_info(host: str, port: int, service: str) -> Dict:
    """
    Get information about a service
    
    Args:
        host: Host IP
        port: Port number
        service: Service name
    
    Returns:
        Dictionary with service information
    """
    info = {
        'port': port,
        'service': service,
        'version': None,
        'banner': None,
        'vulnerabilities': []
    }
    
    # HTTP/HTTPS services
    if service in ['HTTP', 'HTTPS', 'Companion Web']:
        try:
            protocol = 'https' if port in [443, 8443] else 'http'
            response = requests.get(f"{protocol}://{host}:{port}", timeout=2)
            info['banner'] = response.headers.get('Server', 'Unknown')
            info['status_code'] = response.status_code
            
            # Check for common vulnerabilities
            if response.status_code == 200:
                if 'admin' in response.text.lower():
                    info['vulnerabilities'].append('Admin panel accessible')
                if '.env' in response.text or 'config.json' in response.text:
                    info['vulnerabilities'].append('Exposed configuration files')
        except:
            pass
    
    # SSH
    elif service == 'SSH':
        try:
            import paramiko
            ssh = paramiko.SSHClient()
            ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
            ssh.connect(host, port=port, username='test', password='test', timeout=2)
            ssh.close()
        except paramiko.AuthenticationException:
            info['vulnerabilities'].append('SSH accessible (weak auth possible)')
        except:
            pass
    
    # FTP
    elif service == 'FTP':
        try:
            import ftplib
            ftp = ftplib.FTP()
            ftp.connect(host, port, timeout=2)
            ftp.login()  # Try anonymous
            info['vulnerabilities'].append('Anonymous FTP login enabled')
            ftp.quit()
        except:
            pass
    
    # RTSP
    elif service == 'RTSP':
        info['vulnerabilities'].append('RTSP camera stream accessible')
    
    # ROS
    elif service == 'ROS':
        info['vulnerabilities'].append('ROS master accessible')
    
    return info

def map_vulnerabilities(discovered: List[Tuple[int, str, Dict]]) -> Dict:
    """
    Map vulnerabilities from discovered services
    
    Args:
        discovered: List of discovered services
    
    Returns:
        Dictionary of vulnerabilities by category
    """
    vulnerabilities = {
        'critical': [],
        'high': [],
        'medium': [],
        'low': []
    }
    
    for port, service, info in discovered:
        for vuln in info.get('vulnerabilities', []):
            # Categorize vulnerabilities
            if 'anonymous' in vuln.lower() or 'admin' in vuln.lower():
                vulnerabilities['high'].append(f"{service} ({port}): {vuln}")
            elif 'exposed' in vuln.lower():
                vulnerabilities['medium'].append(f"{service} ({port}): {vuln}")
            else:
                vulnerabilities['low'].append(f"{service} ({port}): {vuln}")
    
    return vulnerabilities

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 companion_computer_discovery.py <host> [port]")
        print("\nArguments:")
        print("  host    IP address or hostname of companion computer")
        print("  port    Specific port to check (optional, scans all if not specified)")
        print("\nExamples:")
        print("  python3 companion_computer_discovery.py 192.168.13.1")
        print("  python3 companion_computer_discovery.py 192.168.13.1 3000")
        sys.exit(1)
    
    host = sys.argv[1]
    specific_port = int(sys.argv[2]) if len(sys.argv) > 2 and sys.argv[2].isdigit() else None
    
    print("[*] Companion Computer Discovery Tool")
    print(f"[*] Target: {host}")
    print()
    
    # Scan ports
    if specific_port:
        discovered = scan_companion_computer(host, [specific_port])
    else:
        discovered = scan_companion_computer(host)
    
    if not discovered:
        print("\n[-] No open ports found")
        sys.exit(1)
    
    print(f"\n[+] Found {len(discovered)} open service(s)")
    
    # Map vulnerabilities
    vulnerabilities = map_vulnerabilities(discovered)
    
    # Summary
    print("\n" + "="*50)
    print("VULNERABILITY SUMMARY")
    print("="*50)
    
    total_vulns = sum(len(v) for v in vulnerabilities.values())
    if total_vulns > 0:
        for severity, vulns in vulnerabilities.items():
            if vulns:
                print(f"\n[{severity.upper()}] {len(vulns)} vulnerability(ies):")
                for vuln in vulns:
                    print(f"  - {vuln}")
    else:
        print("\n[*] No obvious vulnerabilities found")
    
    # Service details
    print("\n" + "="*50)
    print("SERVICE DETAILS")
    print("="*50)
    for port, service, info in discovered:
        print(f"\n[{service}] Port {port}")
        if info.get('banner'):
            print(f"  Banner: {info['banner']}")
        if info.get('version'):
            print(f"  Version: {info['version']}")
        if info.get('vulnerabilities'):
            print(f"  Vulnerabilities: {', '.join(info['vulnerabilities'])}")

if __name__ == "__main__":
    main()
