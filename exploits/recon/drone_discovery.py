#!/usr/bin/env python3
"""
Drone Discovery Exploit Script
Scans network for MAVLink-compatible devices
"""

import socket
import struct
import sys
import time
from typing import List, Tuple

# Common MAVLink ports
MAVLINK_PORTS = [14550, 14540, 14560, 14580, 5760, 5762, 5763]

def scan_network(network_base: str = "10.13.0", port_range: List[int] = None) -> List[Tuple[str, int]]:
    """
    Scan network for MAVLink services
    
    Args:
        network_base: Network base (e.g., "10.13.0")
        port_range: List of ports to scan (default: MAVLINK_PORTS)
    
    Returns:
        List of (ip, port) tuples where MAVLink services are found
    """
    if port_range is None:
        port_range = MAVLINK_PORTS
    
    discovered = []
    
    print(f"[*] Scanning {network_base}.0/24 for MAVLink services...")
    
    for host in range(1, 255):
        ip = f"{network_base}.{host}"
        for port in port_range:
            if check_mavlink_port(ip, port):
                print(f"[+] Found MAVLink service at {ip}:{port}")
                discovered.append((ip, port))
    
    return discovered

def check_mavlink_port(ip: str, port: int, timeout: float = 1.0) -> bool:
    """
    Check if a port is running MAVLink service
    
    Args:
        ip: IP address to check
        port: Port to check
        timeout: Connection timeout
    
    Returns:
        True if MAVLink service detected
    """
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        sock.settimeout(timeout)
        
        # Send a heartbeat request (MAVLink 2.0)
        # Magic byte + payload length + incompat flags + compat flags + seq + sysid + compid + msgid
        heartbeat = bytes([0xfd, 9, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0])
        sock.sendto(heartbeat, (ip, port))
        
        # Try to receive response
        try:
            data, addr = sock.recvfrom(1024)
            # Check if it looks like MAVLink (starts with magic byte)
            if len(data) > 0 and (data[0] == 0xfd or data[0] == 0xfe):
                return True
        except socket.timeout:
            pass
        
        sock.close()
    except Exception:
        pass
    
    return False

def identify_device(ip: str, port: int) -> dict:
    """
    Identify device type from MAVLink heartbeat
    
    Args:
        ip: Device IP
        port: Device port
    
    Returns:
        Dictionary with device information
    """
    try:
        from pymavlink import mavutil
        
        connection = mavutil.mavlink_connection(f'udp:{ip}:{port}', timeout=2)
        msg = connection.recv_match(type='HEARTBEAT', blocking=True, timeout=2)
        
        if msg:
            return {
                'ip': ip,
                'port': port,
                'type': msg.type,
                'autopilot': msg.autopilot,
                'system_status': msg.system_status
            }
    except ImportError:
        print("[!] pymavlink not installed. Install with: pip install pymavlink")
    except Exception as e:
        print(f"[-] Error identifying {ip}:{port}: {e}")
    
    return None

def main():
    network = sys.argv[1] if len(sys.argv) > 1 else "10.13.0"
    
    print("[*] Drone Discovery Tool")
    print(f"[*] Scanning network: {network}.0/24")
    print()
    
    discovered = scan_network(network)
    
    if discovered:
        print(f"\n[+] Found {len(discovered)} MAVLink service(s)")
        print("\n[*] Attempting to identify devices...")
        
        for ip, port in discovered:
            info = identify_device(ip, port)
            if info:
                print(f"\n[+] Device at {ip}:{port}")
                print(f"    Type: {info.get('type', 'Unknown')}")
                print(f"    Autopilot: {info.get('autopilot', 'Unknown')}")
    else:
        print("\n[-] No MAVLink services found")

if __name__ == "__main__":
    main()
