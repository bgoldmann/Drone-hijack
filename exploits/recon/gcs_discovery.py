#!/usr/bin/env python3
"""
Ground Control Station Discovery Script
Scans for and maps GCS network footprint and services
"""

import sys
import socket
import requests
from typing import List, Tuple, Dict

# Common GCS ports
GCS_PORTS = {
    'MAVLink': [14550, 14540, 14560, 14580],
    'QGroundControl': [5760, 5762, 5763],
    'HTTP': [80, 8080],
    'HTTPS': [443, 8443],
    'SSH': [22],
    'VNC': [5900, 5901],
    'Mission Planner': [14550],
}

def scan_network(network_base: str = "192.168.13", port_list: List[int] = None) -> List[Tuple[str, int, str]]:
    """
    Scan network for GCS services
    
    Args:
        network_base: Network base (e.g., "192.168.13")
        port_list: List of ports to scan
    
    Returns:
        List of (ip, port, service) tuples
    """
    if port_list is None:
        # Flatten all GCS ports
        port_list = []
        for ports in GCS_PORTS.values():
            port_list.extend(ports)
        port_list = list(set(port_list))  # Remove duplicates
    
    discovered = []
    
    print(f"[*] Scanning {network_base}.0/24 for GCS services...")
    print(f"[*] Checking {len(port_list)} ports...")
    
    for host in range(1, 255):
        ip = f"{network_base}.{host}"
        for port in port_list:
            if check_port(ip, port):
                service = identify_service(ip, port)
                print(f"[+] Found {service} at {ip}:{port}")
                discovered.append((ip, port, service))
    
    return discovered

def check_port(ip: str, port: int, timeout: float = 1.0) -> bool:
    """
    Check if a port is open
    
    Args:
        ip: IP address
        port: Port number
        timeout: Connection timeout
    
    Returns:
        True if port is open
    """
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(timeout)
        result = sock.connect_ex((ip, port))
        sock.close()
        return result == 0
    except Exception:
        return False

def identify_service(ip: str, port: int) -> str:
    """
    Identify service running on port
    
    Args:
        ip: IP address
        port: Port number
    
    Returns:
        Service name
    """
    # Check MAVLink
    if port in [14550, 14540, 14560, 14580]:
        if check_mavlink(ip, port):
            return "MAVLink"
    
    # Check HTTP
    if port in [80, 8080, 443, 8443]:
        try:
            protocol = 'https' if port in [443, 8443] else 'http'
            response = requests.get(f"{protocol}://{ip}:{port}", timeout=2)
            if response.status_code == 200:
                # Try to identify from response
                if 'qgroundcontrol' in response.text.lower():
                    return "QGroundControl Web"
                elif 'mission planner' in response.text.lower():
                    return "Mission Planner Web"
                return "HTTP Service"
        except:
            pass
    
    # Check SSH
    if port == 22:
        if check_port(ip, port):
            return "SSH"
    
    # Check VNC
    if port in [5900, 5901]:
        if check_port(ip, port):
            return "VNC"
    
    # Generic identification
    for service, ports in GCS_PORTS.items():
        if port in ports:
            return f"{service} (possible)"
    
    return "Unknown Service"

def check_mavlink(ip: str, port: int) -> bool:
    """
    Check if MAVLink service is running
    
    Args:
        ip: IP address
        port: Port number
    
    Returns:
        True if MAVLink detected
    """
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        sock.settimeout(1)
        
        # Send heartbeat
        heartbeat = bytes([0xfd, 9, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0])
        sock.sendto(heartbeat, (ip, port))
        
        try:
            data, addr = sock.recvfrom(1024)
            if len(data) > 0 and (data[0] == 0xfd or data[0] == 0xfe):
                return True
        except socket.timeout:
            pass
        
        sock.close()
    except Exception:
        pass
    
    return False

def map_gcs_infrastructure(discovered: List[Tuple[str, int, str]]) -> Dict:
    """
    Map GCS infrastructure from discovered services
    
    Args:
        discovered: List of discovered services
    
    Returns:
        Dictionary mapping IPs to services
    """
    infrastructure = {}
    
    for ip, port, service in discovered:
        if ip not in infrastructure:
            infrastructure[ip] = {
                'services': [],
                'ports': []
            }
        infrastructure[ip]['services'].append(service)
        infrastructure[ip]['ports'].append(port)
    
    return infrastructure

def main():
    network = sys.argv[1] if len(sys.argv) > 1 else "192.168.13"
    
    # Validate network format (basic check)
    if network and '.' in network:
        parts = network.split('.')
        if len(parts) > 3:
            print(f"[-] Invalid network format: {network}")
            print("[*] Expected format: X.X.X or X.X.X.X")
            sys.exit(1)
    
    print("[*] Ground Control Station Discovery Tool")
    print(f"[*] Scanning network: {network}.0/24")
    print()
    
    discovered = scan_network(network)
    
    if discovered:
        print(f"\n[+] Found {len(discovered)} GCS service(s)")
        print("\n[*] Mapping GCS infrastructure...")
        
        infrastructure = map_gcs_infrastructure(discovered)
        
        print("\n" + "="*50)
        print("GCS INFRASTRUCTURE MAP")
        print("="*50)
        
        for ip, info in infrastructure.items():
            print(f"\n[+] {ip}")
            print(f"    Services: {', '.join(set(info['services']))}")
            print(f"    Ports: {', '.join(map(str, info['ports']))}")
        
        print(f"\n[+] Total GCS hosts discovered: {len(infrastructure)}")
    else:
        print("\n[-] No GCS services found")

if __name__ == "__main__":
    main()
