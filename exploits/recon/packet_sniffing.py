#!/usr/bin/env python3
"""
Packet Sniffing Exploit Script
Captures and analyzes MAVLink traffic in real-time
"""

import sys
import time
from pymavlink import mavutil
from collections import defaultdict

def sniff_mavlink_traffic(connection, duration=60, filter_types=None):
    """
    Sniff MAVLink traffic and display messages
    
    Args:
        connection: MAVLink connection object
        duration: Sniffing duration in seconds (0 = infinite)
        filter_types: List of message types to filter (None = all)
    """
    print(f"[*] Starting MAVLink packet sniffing...")
    if duration > 0:
        print(f"[*] Duration: {duration} seconds")
    else:
        print("[*] Duration: infinite (Press Ctrl+C to stop)")
    
    if filter_types:
        print(f"[*] Filtering for: {', '.join(filter_types)}")
    
    message_counts = defaultdict(int)
    start_time = time.time()
    
    try:
        while True:
            if duration > 0 and (time.time() - start_time) >= duration:
                break
            
            msg = connection.recv_match(blocking=True, timeout=1)
            if msg is None:
                continue
            
            msg_type = msg.get_type()
            
            # Apply filter
            if filter_types and msg_type not in filter_types:
                continue
            
            message_counts[msg_type] += 1
            
            # Display message
            print(f"[{time.time() - start_time:.1f}s] {msg_type}: {msg}")
            
            # Special handling for sensitive messages
            if msg_type == 'HEARTBEAT':
                print(f"    System: {msg.get_srcSystem()}, Component: {msg.get_srcComponent()}")
                print(f"    Type: {msg.type}, Autopilot: {msg.autopilot}, Mode: {msg.base_mode}")
            
            elif msg_type in ['GLOBAL_POSITION_INT', 'GPS_RAW_INT']:
                if hasattr(msg, 'lat') and hasattr(msg, 'lon'):
                    lat = msg.lat / 1e7 if msg_type == 'GLOBAL_POSITION_INT' else msg.lat / 1e7
                    lon = msg.lon / 1e7 if msg_type == 'GLOBAL_POSITION_INT' else msg.lon / 1e7
                    print(f"    GPS: lat={lat:.6f}, lon={lon:.6f}")
            
            elif msg_type == 'COMMAND_LONG':
                print(f"    Command: {msg.command}, Params: {msg.param1}, {msg.param2}, ...")
            
            elif msg_type == 'MISSION_ITEM':
                print(f"    Waypoint: seq={msg.seq}, lat={msg.x}, lon={msg.y}, alt={msg.z}")
            
    except KeyboardInterrupt:
        print("\n[*] Stopping packet sniffing...")
    
    # Display summary
    print("\n" + "=" * 60)
    print("Packet Sniffing Summary")
    print("=" * 60)
    print(f"Total messages captured: {sum(message_counts.values())}")
    print(f"Unique message types: {len(message_counts)}")
    print("\nMessage Type Counts:")
    for msg_type, count in sorted(message_counts.items(), key=lambda x: x[1], reverse=True):
        print(f"  {msg_type}: {count}")

def save_to_file(connection, output_file, duration=60, filter_types=None):
    """
    Sniff traffic and save to file
    
    Args:
        connection: MAVLink connection object
        output_file: Output file path
        duration: Sniffing duration
        filter_types: Message types to filter
    """
    import json
    from pathlib import Path
    
    output_path = Path(output_file)
    output_path.parent.mkdir(parents=True, exist_ok=True)
    
    print(f"[*] Sniffing and saving to {output_file}...")
    
    messages = []
    start_time = time.time()
    
    try:
        while True:
            if duration > 0 and (time.time() - start_time) >= duration:
                break
            
            msg = connection.recv_match(blocking=True, timeout=1)
            if msg is None:
                continue
            
            msg_type = msg.get_type()
            
            if filter_types and msg_type not in filter_types:
                continue
            
            # Convert message to dict
            msg_dict = {
                'timestamp': time.time(),
                'type': msg_type,
                'data': msg.to_dict()
            }
            messages.append(msg_dict)
            
            if len(messages) % 100 == 0:
                print(f"\r[*] Captured {len(messages)} messages...", end='', flush=True)
            
    except KeyboardInterrupt:
        print("\n[*] Stopping capture...")
    
    # Save to file
    with open(output_path, 'w') as f:
        json.dump(messages, f, indent=2, default=str)
    
    print(f"\n[+] Saved {len(messages)} messages to {output_file}")

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 packet_sniffing.py <connection> [options]")
        print("Example: python3 packet_sniffing.py udp:127.0.0.1:14550")
        print("Example: python3 packet_sniffing.py udp:127.0.0.1:14550 --filter HEARTBEAT GPS_RAW_INT")
        print("Example: python3 packet_sniffing.py udp:127.0.0.1:14550 --save capture.json --duration 30")
        print("\nOptions:")
        print("  --filter <types>    Filter by message types (comma-separated)")
        print("  --save <file>       Save captured packets to JSON file")
        print("  --duration <sec>    Sniffing duration in seconds (default: 60, 0 = infinite)")
        sys.exit(1)
    
    connection_string = sys.argv[1]
    
    # Parse options
    filter_types = None
    output_file = None
    duration = 60
    
    i = 2
    while i < len(sys.argv):
        if sys.argv[i] == '--filter' and i + 1 < len(sys.argv):
            filter_types = sys.argv[i + 1].split(',')
            filter_types = [t.strip().upper() for t in filter_types]  # Normalize
            i += 2
        elif sys.argv[i] == '--save' and i + 1 < len(sys.argv):
            output_file = sys.argv[i + 1]
            # Validate output file path
            output_path = Path(output_file)
            try:
                output_path.parent.mkdir(parents=True, exist_ok=True)
            except (OSError, PermissionError) as e:
                print(f"[-] Cannot create output file directory: {e}")
                sys.exit(1)
            i += 2
        elif sys.argv[i] == '--duration' and i + 1 < len(sys.argv):
            try:
                duration = int(sys.argv[i + 1])
                if duration < 0:
                    raise ValueError("Duration cannot be negative")
            except (ValueError, TypeError) as e:
                print(f"[-] Invalid duration: {e}")
                sys.exit(1)
            i += 2
        else:
            i += 1
    
    # Use helper function for connection
    import sys
    from pathlib import Path
    sys.path.insert(0, str(Path(__file__).parent.parent / 'utils'))
    from mavlink_helper import connect_to_drone
    
    print(f"[*] Connecting to {connection_string}...")
    connection = connect_to_drone(connection_string, timeout=5)
    if connection is None:
        sys.exit(1)
    print("[+] Connected to vehicle")
    
    # Start sniffing
    if output_file:
        save_to_file(connection, output_file, duration, filter_types)
    else:
        sniff_mavlink_traffic(connection, duration, filter_types)

if __name__ == "__main__":
    main()
