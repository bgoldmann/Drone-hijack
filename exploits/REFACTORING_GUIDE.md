# Exploit Scripts Refactoring Guide

This guide helps refactor remaining exploit scripts to use standardized patterns and improve code quality.

## Quick Refactoring Checklist

### 1. Connection Handling

**Before:**
```python
print(f"[*] Connecting to {connection_string}...")
try:
    connection = mavutil.mavlink_connection(connection_string)
    connection.wait_heartbeat(timeout=5)
    print("[+] Connected to vehicle")
except Exception as e:
    print(f"[-] Failed to connect: {e}")
    sys.exit(1)
```

**After:**
```python
import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).parent.parent / 'utils'))
from mavlink_helper import connect_to_drone

print(f"[*] Connecting to {connection_string}...")
connection = connect_to_drone(connection_string, timeout=5)
if connection is None:
    sys.exit(1)
print("[+] Connected to vehicle")
```

### 2. Input Validation

**Add validation for:**
- Numeric ranges (GPS: -90 to 90 for lat, -180 to 180 for lon)
- Altitude: -500 to 50000 meters
- Payload sizes: 1 to 10000 bytes
- Rates: 1 to 10000 msg/s
- Durations: non-negative, warn if > 3600 seconds
- File paths: check write permissions
- Log IDs: non-negative integers

**Example:**
```python
try:
    lat = float(sys.argv[2])
    if not -90 <= lat <= 90:
        raise ValueError("Latitude must be between -90 and 90 degrees")
except (ValueError, IndexError) as e:
    print(f"[-] Invalid latitude: {e}")
    sys.exit(1)
```

### 3. Error Handling

**Before:**
```python
except Exception as e:
    print(f"[-] Error: {e}")
    sys.exit(1)
```

**After:**
```python
except (ConnectionError, OSError) as e:
    print(f"[-] Connection error: {e}")
    sys.exit(1)
except TimeoutError as e:
    print(f"[-] Timeout: {e}")
    sys.exit(1)
except ValueError as e:
    print(f"[-] Invalid input: {e}")
    sys.exit(1)
except Exception as e:
    print(f"[-] Unexpected error: {e}")
    sys.exit(1)
```

### 4. File Path Validation

**Example:**
```python
output_path = Path(output_dir)
try:
    output_path.mkdir(parents=True, exist_ok=True)
    # Test write permissions
    test_file = output_path / ".write_test"
    test_file.touch()
    test_file.unlink()
except (OSError, PermissionError) as e:
    print(f"[-] Cannot write to output directory '{output_dir}': {e}")
    sys.exit(1)
```

## Scripts Already Fixed

✅ `gps_spoofing.py` - GPS bug fix, validation, helper usage  
✅ `communication_flooding.py` - Rate limiting, validation, helper usage  
✅ `buffer_overflow_cve_2024_40427.py` - Payload validation, helper usage  
✅ `mavlink_inject.py` - Error handling, validation, helper usage  
✅ `flight_log_extraction.py` - File validation, helper usage  
✅ `packet_sniffing.py` - File validation, helper usage  

## Remaining Scripts to Fix

### High Priority (Common Patterns)
- `injection/waypoint_override.py` - Missing timeout
- `injection/parameter_manipulation.py` - Needs validation
- `tampering/battery_spoofing.py` - Needs validation
- `tampering/attitude_spoofing.py` - Needs validation
- `dos/flight_termination.py` - Needs helper
- `dos/geofence_attack.py` - Needs helper
- `exfiltration/mission_extraction.py` - Needs file validation
- `exfiltration/parameter_extraction.py` - Needs file validation

### Medium Priority
- All scripts in `injection/` directory
- All scripts in `tampering/` directory
- All scripts in `dos/` directory (except fixed ones)
- All scripts in `exfiltration/` directory (except fixed ones)

## Automated Refactoring

Use this pattern to find and replace connection code:

```bash
# Find scripts with old connection pattern
grep -r "mavutil.mavlink_connection" exploits/ --include="*.py" | grep -v "__pycache__"

# Find scripts missing timeout
grep -r "wait_heartbeat()" exploits/ --include="*.py" | grep -v "__pycache__"
```

## Testing After Refactoring

1. Test connection handling with invalid connection strings
2. Test input validation with invalid values
3. Test error handling with network failures
4. Verify all scripts still work with valid inputs

## Notes

- Always preserve original functionality
- Add validation without breaking existing use cases
- Update docstrings if function signatures change
- Test each script after refactoring
