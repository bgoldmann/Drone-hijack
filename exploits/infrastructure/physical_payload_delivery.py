#!/usr/bin/env python3
"""
Physical Payload Delivery
Simulates physical device delivery to target locations for critical infrastructure attacks
"""

import sys
import time
import json
from datetime import datetime

def simulate_payload_delivery(target_lat, target_lon, target_alt, payload_type='device', 
                              delivery_method='drop', log_file=None):
    """
    Simulate physical payload delivery to target location
    
    Args:
        target_lat: Target latitude in degrees
        target_lon: Target longitude in degrees
        target_alt: Target altitude in meters
        payload_type: Type of payload ('device', 'sensor', 'explosive', 'data')
        delivery_method: Delivery method ('drop', 'land', 'attach')
        log_file: File to log delivery information
    """
    print(f"[*] Physical Payload Delivery Simulation")
    print(f"[*] Target Location: ({target_lat:.7f}, {target_lon:.7f}, {target_alt}m)")
    print(f"[*] Payload Type: {payload_type}")
    print(f"[*] Delivery Method: {delivery_method}")
    print()
    
    # Simulate flight to target
    print("[*] Calculating flight path to target...")
    time.sleep(1)
    
    print("[*] Approaching target location...")
    for i in range(5):
        progress = (i + 1) * 20
        print(f"    Progress: {progress}%")
        time.sleep(0.5)
    
    # Delivery
    print(f"[*] Executing {delivery_method} delivery...")
    time.sleep(1)
    
    delivery_info = {
        'timestamp': datetime.now().isoformat(),
        'target_location': {
            'latitude': target_lat,
            'longitude': target_lon,
            'altitude': target_alt
        },
        'payload_type': payload_type,
        'delivery_method': delivery_method,
        'status': 'delivered',
        'coordinates': {
            'lat': target_lat,
            'lon': target_lon,
            'alt': target_alt
        }
    }
    
    print(f"[+] Payload delivered successfully!")
    print(f"    Coordinates: ({target_lat:.7f}, {target_lon:.7f}, {target_alt}m)")
    print(f"    Time: {delivery_info['timestamp']}")
    
    # Log delivery
    if log_file:
        try:
            # Load existing deliveries
            try:
                with open(log_file, 'r') as f:
                    deliveries = json.load(f)
            except FileNotFoundError:
                deliveries = []
            
            deliveries.append(delivery_info)
            
            with open(log_file, 'w') as f:
                json.dump(deliveries, f, indent=2)
            
            print(f"[+] Delivery logged to {log_file}")
        except Exception as e:
            print(f"[-] Error logging delivery: {e}")
    
    return delivery_info

def plan_multi_target_delivery(targets, payload_type='device'):
    """
    Plan delivery to multiple targets
    
    Args:
        targets: List of (lat, lon, alt) tuples
        payload_type: Type of payload
    
    Returns:
        Delivery plan
    """
    print(f"[*] Planning multi-target payload delivery...")
    print(f"[*] Targets: {len(targets)}")
    print()
    
    plan = {
        'targets': [],
        'total_deliveries': len(targets),
        'estimated_time': len(targets) * 60  # 1 minute per target
    }
    
    for i, (lat, lon, alt) in enumerate(targets, 1):
        target_info = {
            'sequence': i,
            'latitude': lat,
            'longitude': lon,
            'altitude': alt,
            'payload_type': payload_type
        }
        plan['targets'].append(target_info)
        print(f"  Target {i}: ({lat:.7f}, {lon:.7f}, {alt}m)")
    
    return plan

def execute_delivery_plan(plan, log_file=None):
    """
    Execute delivery plan
    
    Args:
        plan: Delivery plan from plan_multi_target_delivery
        log_file: File to log deliveries
    """
    print(f"\n[*] Executing delivery plan...")
    print(f"[*] Total deliveries: {plan['total_deliveries']}")
    print()
    
    deliveries = []
    
    for target in plan['targets']:
        print(f"[*] Delivery {target['sequence']}/{plan['total_deliveries']}")
        delivery = simulate_payload_delivery(
            target['latitude'],
            target['longitude'],
            target['altitude'],
            target['payload_type'],
            log_file=log_file
        )
        deliveries.append(delivery)
        time.sleep(1)
    
    print(f"\n[+] All deliveries completed: {len(deliveries)}/{plan['total_deliveries']}")
    return deliveries

def main():
    if len(sys.argv) < 4:
        print("Usage: python3 physical_payload_delivery.py <lat> <lon> <alt> [options...]")
        print("\nArguments:")
        print("  lat            Target latitude in degrees")
        print("  lon            Target longitude in degrees")
        print("  alt            Target altitude in meters")
        print("\nOptions:")
        print("  --type <type>       Payload type: device, sensor, explosive, data (default: device)")
        print("  --method <method>   Delivery method: drop, land, attach (default: drop)")
        print("  --log <file>        Log file for deliveries")
        print("  --multi <file>      JSON file with multiple targets")
        print("\nExamples:")
        print("  python3 physical_payload_delivery.py 37.7749 -122.4194 100")
        print("  python3 physical_payload_delivery.py 37.7749 -122.4194 100 --type sensor --log deliveries.json")
        print("  python3 physical_payload_delivery.py 0 0 0 --multi targets.json")
        sys.exit(1)
    
    # Parse and validate arguments
    try:
        lat = float(sys.argv[1])
        if not -90 <= lat <= 90:
            raise ValueError("Latitude must be between -90 and 90 degrees")
    except (ValueError, TypeError) as e:
        print(f"[-] Invalid latitude: {e}")
        sys.exit(1)
    
    try:
        lon = float(sys.argv[2])
        if not -180 <= lon <= 180:
            raise ValueError("Longitude must be between -180 and 180 degrees")
    except (ValueError, TypeError) as e:
        print(f"[-] Invalid longitude: {e}")
        sys.exit(1)
    
    try:
        alt = float(sys.argv[3])
        if not -500 <= alt <= 50000:
            raise ValueError("Altitude must be between -500 and 50000 meters")
    except (ValueError, TypeError) as e:
        print(f"[-] Invalid altitude: {e}")
        sys.exit(1)
    
    # Parse options
    payload_type = 'device'
    delivery_method = 'drop'
    log_file = None
    multi_file = None
    
    i = 4
    while i < len(sys.argv):
        if sys.argv[i] == '--type' and i + 1 < len(sys.argv):
            payload_type = sys.argv[i + 1]
            i += 2
        elif sys.argv[i] == '--method' and i + 1 < len(sys.argv):
            delivery_method = sys.argv[i + 1]
            i += 2
        elif sys.argv[i] == '--log' and i + 1 < len(sys.argv):
            log_file = sys.argv[i + 1]
            # Validate log file path
            from pathlib import Path
            log_path = Path(log_file)
            try:
                log_path.parent.mkdir(parents=True, exist_ok=True)
                test_file = log_path.parent / ".write_test"
                test_file.touch()
                test_file.unlink()
            except (OSError, PermissionError) as e:
                print(f"[-] Cannot write to log file '{log_file}': {e}")
                sys.exit(1)
            i += 2
        elif sys.argv[i] == '--multi' and i + 1 < len(sys.argv):
            multi_file = sys.argv[i + 1]
            # Validate multi file exists
            from pathlib import Path
            multi_path = Path(multi_file)
            if not multi_path.exists():
                print(f"[-] File not found: {multi_file}")
                sys.exit(1)
            if not multi_path.is_file():
                print(f"[-] Path is not a file: {multi_file}")
                sys.exit(1)
            i += 2
        else:
            i += 1
    
    # Execute delivery
    if multi_file:
        # Load multiple targets
        try:
            with open(multi_file, 'r') as f:
                targets_data = json.load(f)
            
            if isinstance(targets_data, list):
                targets = [(t['lat'], t['lon'], t.get('alt', 0)) for t in targets_data]
            else:
                targets = [(targets_data['lat'], targets_data['lon'], targets_data.get('alt', 0))]
            
            plan = plan_multi_target_delivery(targets, payload_type)
            execute_delivery_plan(plan, log_file)
        except Exception as e:
            print(f"[-] Error loading targets file: {e}")
            sys.exit(1)
    else:
        simulate_payload_delivery(lat, lon, alt, payload_type, delivery_method, log_file)

if __name__ == "__main__":
    main()
