#!/usr/bin/env python3
"""
MAVLink Helper Utilities
Common functions for MAVLink exploitation
"""

from pymavlink import mavutil
from typing import Optional, Dict, Any

def connect_to_drone(connection_string: str, timeout: int = 5) -> Optional[Any]:
    """
    Connect to drone via MAVLink
    
    Args:
        connection_string: MAVLink connection string
        timeout: Connection timeout in seconds
    
    Returns:
        MAVLink connection object or None
    """
    try:
        master = mavutil.mavlink_connection(connection_string)
        master.wait_heartbeat(timeout=timeout)
        return master
    except Exception as e:
        print(f"[-] Failed to connect: {e}")
        return None

def get_vehicle_info(master) -> Dict[str, Any]:
    """
    Get vehicle information from heartbeat
    
    Args:
        master: MAVLink connection object
    
    Returns:
        Dictionary with vehicle information
    """
    info = {
        'system_id': master.target_system,
        'component_id': master.target_component,
        'type': None,
        'autopilot': None,
        'mode': None,
        'armed': False
    }
    
    try:
        msg = master.recv_match(type='HEARTBEAT', blocking=True, timeout=2)
        if msg:
            info['type'] = msg.type
            info['autopilot'] = msg.autopilot
            info['mode'] = mavutil.mode_string_v10(msg)
            info['armed'] = bool(msg.base_mode & mavutil.mavlink.MAV_MODE_FLAG_ARMED)
    except Exception:
        pass
    
    return info

def send_command_long(master, command, param1=0, param2=0, param3=0, param4=0, 
                     param5=0, param6=0, param7=0):
    """
    Send MAVLink command_long message
    
    Args:
        master: MAVLink connection object
        command: MAV_CMD command ID
        param1-7: Command parameters
    
    Returns:
        True if command sent successfully
    """
    try:
        master.mav.command_long_send(
            master.target_system,
            master.target_component,
            command,
            0,  # confirmation
            param1, param2, param3, param4, param5, param6, param7
        )
        return True
    except Exception as e:
        print(f"[-] Error sending command: {e}")
        return False

def wait_for_ack(master, timeout: int = 5) -> bool:
    """
    Wait for command acknowledgment
    
    Args:
        master: MAVLink connection object
        timeout: Timeout in seconds
    
    Returns:
        True if command accepted
    """
    try:
        msg = master.recv_match(type='COMMAND_ACK', blocking=True, timeout=timeout)
        if msg:
            return msg.result == mavutil.mavlink.MAV_RESULT_ACCEPTED
        return False
    except Exception:
        return False
