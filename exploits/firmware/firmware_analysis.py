#!/usr/bin/env python3
"""
Firmware Analysis Script
Analyzes firmware binaries to identify vulnerabilities and extract information
"""

import sys
import subprocess
from pathlib import Path

def extract_strings(firmware_file, output_file=None):
    """
    Extract readable strings from firmware
    
    Args:
        firmware_file: Path to firmware file
        output_file: Optional output file for strings
    """
    print(f"[*] Extracting strings from {firmware_file}...")
    
    firmware_path = Path(firmware_file)
    if not firmware_path.exists():
        print(f"[-] Firmware file not found: {firmware_file}")
        return False
    
    try:
        # Use strings command
        result = subprocess.run(
            ['strings', str(firmware_path)],
            capture_output=True,
            text=True,
            check=True
        )
        
        strings = result.stdout.split('\n')
        print(f"[+] Extracted {len(strings)} strings")
        
        # Look for interesting strings
        interesting = []
        keywords = ['password', 'secret', 'key', 'token', 'admin', 'root', 
                   'firmware', 'version', 'mavlink', 'ardupilot', 'px4']
        
        for s in strings:
            s_lower = s.lower()
            if any(kw in s_lower for kw in keywords):
                interesting.append(s)
        
        if interesting:
            print(f"\n[+] Found {len(interesting)} interesting strings:")
            for s in interesting[:20]:  # Show first 20
                print(f"    {s}")
            if len(interesting) > 20:
                print(f"    ... and {len(interesting) - 20} more")
        
        # Save to file
        if output_file:
            output_path = Path(output_file)
            output_path.parent.mkdir(parents=True, exist_ok=True)
            with open(output_path, 'w') as f:
                f.write(result.stdout)
            print(f"[+] Strings saved to {output_file}")
        
        return True
        
    except FileNotFoundError:
        print("[-] 'strings' command not found. Install with: sudo apt-get install binutils")
        return False
    except Exception as e:
        print(f"[-] Error extracting strings: {e}")
        return False

def analyze_with_binwalk(firmware_file):
    """
    Analyze firmware with binwalk
    
    Args:
        firmware_file: Path to firmware file
    """
    print(f"[*] Analyzing {firmware_file} with binwalk...")
    
    firmware_path = Path(firmware_file)
    if not firmware_path.exists():
        print(f"[-] Firmware file not found: {firmware_file}")
        return False
    
    try:
        # Run binwalk
        result = subprocess.run(
            ['binwalk', str(firmware_path)],
            capture_output=True,
            text=True,
            check=True
        )
        
        print(result.stdout)
        
        # Extract embedded files
        print("[*] Attempting to extract embedded filesystems...")
        extract_result = subprocess.run(
            ['binwalk', '-e', str(firmware_path)],
            capture_output=True,
            text=True
        )
        
        if extract_result.returncode == 0:
            print("[+] Extracted embedded filesystems")
            print("[*] Check _firmware_file.extracted/ directory")
        
        return True
        
    except FileNotFoundError:
        print("[-] binwalk not found. Install with: sudo apt-get install binwalk")
        return False
    except Exception as e:
        print(f"[-] Error running binwalk: {e}")
        return False

def identify_firmware_type(firmware_file):
    """
    Identify firmware type and architecture
    
    Args:
        firmware_file: Path to firmware file
    """
    print(f"[*] Identifying firmware type...")
    
    firmware_path = Path(firmware_file)
    if not firmware_path.exists():
        print(f"[-] Firmware file not found: {firmware_file}")
        return False
    
    try:
        # Use file command
        result = subprocess.run(
            ['file', str(firmware_path)],
            capture_output=True,
            text=True,
            check=True
        )
        
        print(f"[+] File type: {result.stdout.strip()}")
        
        # Check for ELF
        if 'ELF' in result.stdout:
            # Get architecture
            arch_result = subprocess.run(
                ['readelf', '-h', str(firmware_path)],
                capture_output=True,
                text=True
            )
            
            if arch_result.returncode == 0:
                for line in arch_result.stdout.split('\n'):
                    if 'Machine:' in line or 'Class:' in line:
                        print(f"    {line.strip()}")
        
        return True
        
    except FileNotFoundError:
        print("[-] 'file' command not found")
        return False
    except Exception as e:
        print(f"[-] Error identifying firmware: {e}")
        return False

def search_vulnerabilities(firmware_file):
    """
    Search for known vulnerability patterns
    
    Args:
        firmware_file: Path to firmware file
    """
    print(f"[*] Searching for vulnerability patterns...")
    
    firmware_path = Path(firmware_file)
    if not firmware_path.exists():
        return False
    
    # Read firmware
    with open(firmware_path, 'rb') as f:
        firmware_data = f.read()
    
    # Search for common vulnerable patterns
    patterns = {
        'Hardcoded passwords': [b'password', b'admin', b'root', b'1234', b'default'],
        'Debug strings': [b'DEBUG', b'TEST', b'DEVELOPMENT'],
        'Version strings': [b'version', b'VERSION', b'firmware'],
        'MAVLink references': [b'MAVLink', b'mavlink', b'MAVLINK'],
        'ArduPilot references': [b'ArduPilot', b'ardupilot', b'ArduCopter'],
        'PX4 references': [b'PX4', b'px4']
    }
    
    found_patterns = {}
    
    for pattern_name, pattern_list in patterns.items():
        matches = []
        for pattern in pattern_list:
            if pattern in firmware_data:
                # Find all occurrences
                start = 0
                while True:
                    pos = firmware_data.find(pattern, start)
                    if pos == -1:
                        break
                    matches.append((pos, pattern))
                    start = pos + 1
        
        if matches:
            found_patterns[pattern_name] = matches[:10]  # Limit to first 10
    
    if found_patterns:
        print(f"[+] Found potential vulnerability indicators:")
        for pattern_name, matches in found_patterns.items():
            print(f"    {pattern_name}: {len(matches)} occurrence(s)")
    else:
        print("[-] No obvious vulnerability patterns found")
    
    return True

def main():
    if len(sys.argv) < 3:
        print("Usage: python3 firmware_analysis.py <firmware_file> <action> [options]")
        print("\nActions:")
        print("  strings [output]        Extract readable strings")
        print("  binwalk                 Analyze with binwalk")
        print("  identify                Identify firmware type")
        print("  search                  Search for vulnerability patterns")
        print("  all                     Run all analysis methods")
        print("\nExample: python3 firmware_analysis.py firmware.bin strings strings.txt")
        print("Example: python3 firmware_analysis.py firmware.bin binwalk")
        print("Example: python3 firmware_analysis.py firmware.bin all")
        sys.exit(1)
    
    firmware_file = sys.argv[1]
    action = sys.argv[2]
    
    if not Path(firmware_file).exists():
        print(f"[-] Firmware file not found: {firmware_file}")
        sys.exit(1)
    
    if action == 'strings':
        output_file = sys.argv[3] if len(sys.argv) > 3 else None
        extract_strings(firmware_file, output_file)
    
    elif action == 'binwalk':
        analyze_with_binwalk(firmware_file)
    
    elif action == 'identify':
        identify_firmware_type(firmware_file)
    
    elif action == 'search':
        search_vulnerabilities(firmware_file)
    
    elif action == 'all':
        print("[*] Running all analysis methods...\n")
        identify_firmware_type(firmware_file)
        print()
        extract_strings(firmware_file)
        print()
        analyze_with_binwalk(firmware_file)
        print()
        search_vulnerabilities(firmware_file)
    
    else:
        print(f"[-] Unknown action: {action}")
        sys.exit(1)

if __name__ == "__main__":
    main()
