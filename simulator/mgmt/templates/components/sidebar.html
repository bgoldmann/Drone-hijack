{% block sidebar %}
<div id="layoutDrawer_nav">
    <!-- Drawer navigation-->
    <nav class="drawer accordion drawer-dark bg-dark" id="drawerAccordion">
        <div style="text-align: center;">
            <a href="/">
                <img src="{{ url_for('static', filename='images/logo-small.png') }}" style="width: 50%; display: inline-block;">
            </a>
            <div style="display: inline-block; text-align: center; width: 100%;">
                <a href="/" class="navbar-brand" style="display: inline-block;">
                    <h6 class="text-uppercase font-monospace text-white">
                        DAMN VULNERABLE DRONE
                    </h6>
                </a>
            </div>
        </div>
        <div class="drawer-menu">
            <div class="nav">
                <div class="drawer-menu-divider"></div>
                <!-- Drawer link (Dashboards)-->
                <a class="nav-link {% if current_page == 'home' %}active{% endif %}" href="/">
                    <div class="nav-link-icon"><i class="material-icons">play_arrow</i></div>
                    Simulator
                </a>
                <!-- Drawer link (Components)-->
                <a class="nav-link {% if current_page == 'getting-started' %}active{% endif %}" href="/getting-started">
                    <div class="nav-link-icon"><i class="material-icons">flag</i></div>
                    Getting Started
                </a>
                <a class="nav-link {% if section != 'guide' %}collapsed{% else %}active{% endif %}" href="javascript:void(0);" data-bs-toggle="collapse" data-bs-target="#collapseSimulatorGuide" aria-expanded="false" aria-controls="collapseForms">
                    <div class="nav-link-icon"><i class="material-icons">help_center</i></div>
                    Simulator User Guide
                    <div class="drawer-collapse-arrow"><i class="material-icons">expand_more</i></div>
                </a>
                <!-- Nested drawer nav (Forms)-->
                <div class="collapse {% if section == 'guide' %}show{% endif %}" id="collapseSimulatorGuide" aria-labelledby="headingOne" data-bs-parent="#drawerAccordion">
                    <nav class="drawer-menu-nested nav">
                        <a class="nav-link {% if current_page == 'basic-operations' %}active{% endif %}" href="/guide/basic-operations">Basic Operations</a>
                        <a class="nav-link {% if current_page == 'system-architecture' %}active{% endif %}" href="/guide/system-architecture">System Architecture</a>
                        <!-- <a class="nav-link {% if current_page == 'system-health-check' %}active{% endif %}" href="/guide/system-health-check">System Health Check</a>
                        <a class="nav-link {% if current_page == 'manual-testing' %}active{% endif %}" href="/guide/manual-testing">Manual Testing Containers</a>
                        <a class="nav-link {% if current_page == 'troubleshooting' %}active{% endif %}" href="/guide/troubleshooting">Troubleshooting</a> -->
                    </nav>
                </div>
                <a class="nav-link {% if section == 'attacks' %}active{% endif %}" href="/attacks">
                    <div class="nav-link-icon"><i class="material-icons">warning</i></div>
                    Attack Scenarios
                </a>
                <a class="nav-link {% if section != 'learning' %}collapsed{% else %}active{% endif %}" href="javascript:void(0);" data-bs-toggle="collapse" data-bs-target="#collapseLearning" aria-expanded="false" aria-controls="collapseLearning">
                    <div class="nav-link-icon"><i class="material-icons">support</i></div>
                    Learning Resources
                    <div class="drawer-collapse-arrow"><i class="material-icons">expand_more</i></div>
                </a>
                <!-- Nested drawer nav (Forms)-->
                <div class="collapse {% if section == 'learning' %}show{% endif %}" id="collapseLearning" aria-labelledby="headingOne" data-bs-parent="#drawerAccordion">
                    <nav class="drawer-menu-nested nav">
                        <a class="nav-link {% if current_page == 'aircrack-ng' %}active{% endif %}" target="_blank" href="https://www.aircrack-ng.org/doku.php#documentation">Aircrack-ng</a>
                        <a class="nav-link {% if current_page == 'wireshark' %}active{% endif %}" target="_blank" href="https://www.wireshark.org/docs/wsug_html_chunked/index.html">Wireshark</a>
                        <a class="nav-link {% if current_page == 'mavlink' %}active{% endif %}" target="_blank" href="https://mavlink.io/en/">MAVLink</a>
                        <a class="nav-link {% if current_page == 'mavproxy' %}active{% endif %}" target="_blank" href="https://ardupilot.org/mavproxy/">MAVProxy</a>
                        <a class="nav-link {% if current_page == 'ardupilot' %}active{% endif %}" target="_blank" href="https://ardupilot.org/ardupilot/">ArduPilot</a>
                        <a class="nav-link {% if current_page == 'arducopter' %}active{% endif %}" target="_blank" href="https://ardupilot.org/copter/index.html">ArduCopter</a>
                        <a class="nav-link {% if current_page == 'arducopter' %}active{% endif %}" target="_blank" href="https://docs.px4.io/main/en/index.html">PX4</a>
                        <a class="nav-link {% if current_page == 'arducopter' %}active{% endif %}" target="_blank" href="https://www.ros.org/">ROS</a>
                        <a class="nav-link {% if current_page == 'arducopter' %}active{% endif %}" target="_blank" href="https://dronecode.org/">Dronecode</a>
                        <a class="nav-link {% if current_page == 'arducopter' %}active{% endif %}" target="_blank" href="https://dronecode.org/">QGroundControl</a>
                        <a class="nav-link {% if current_page == 'arducopter' %}active{% endif %}" target="_blank" href="https://nmap.org/">Nmap</a>
                        <a class="nav-link {% if current_page == 'arducopter' %}active{% endif %}" target="_blank" href="https://www.gnuradio.org/">GNURadio</a>
                    </nav>
                </div>
            </div>
        </div>
        <button id="open_qgc" class="btn btn-info">Launch QGroundControl</button>
    </nav>    
</div>

<div class="modal fade" id="qgcModal" tabindex="-1" aria-labelledby="qgcModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title" id="qgcModalLabel">Launching QGroundControlâ€¦</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="qgcModalCloseX"></button>
        </div>
        <div class="modal-body d-flex align-items-center gap-3">
          <div class="spinner-border" role="status" aria-hidden="true"></div>
          <div>
            <div class="fw-semibold">Please wait</div>
            <small class="text-muted">This can take a moment. You can cancel anytime.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button id="qgcCancel" type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // keep sidebar scroll behavior
      const activeNavLink = document.querySelector('.nav-link.active');
      if (activeNavLink) {
        const drawerMenu = document.querySelector('.drawer-menu');
        if (drawerMenu) {
          const activeLinkTop = activeNavLink.getBoundingClientRect().top;
          const drawerMenuTop = drawerMenu.getBoundingClientRect().top;
          const scrollPosition = activeLinkTop - drawerMenuTop;
          drawerMenu.scrollTop = scrollPosition + 200;
        }
      }
  
      // QGC modal + launch logic
      const launchBtn = document.getElementById('open_qgc');
      const modalEl = document.getElementById('qgcModal');
      const modal = new bootstrap.Modal(modalEl);
      const cancelBtn = document.getElementById('qgcCancel');
      const closeXBtn = document.getElementById('qgcModalCloseX');
  
      let controller = null;   // AbortController
      let inFlight = false;
  
      function setBusy(busy) {
        inFlight = busy;
        launchBtn.disabled = busy;
        cancelBtn.disabled = !busy; // allow cancel only if busy
      }
  
      function abortIfNeeded() {
        if (controller) {
          controller.abort();
          controller = null;
        }
        setBusy(false);
      }
  
      async function launchQGC() {
        // show modal and start request
        controller = new AbortController();
        setBusy(true);
        modal.show();
  
        try {
          const resp = await fetch('/qgc', {
            method: 'POST',
            signal: controller.signal
          });
  
          // done: hide modal and report
          modal.hide();
          setBusy(false);
  
          if (resp.ok) {
            // Optional: toast/success
            if (typeof Swal !== 'undefined') {
              Swal.fire({
                title: "QGroundControl launched",
                icon: "success",
                timer: 1600,
                showConfirmButton: false
              });
            } else {
              console.log('QGroundControl launched:', resp);
            }
          } else {
            if (typeof Swal !== 'undefined') {
              Swal.fire({
                title: "Failed to Launch QGroundControl",
                html: "Your system's architecture may not be supported by QGroundControl. To deploy a local instance, follow <a href='https://github.com/nicholasaleks/Damn-Vulnerable-Drone/wiki/Running-QGround-Control-from-Apple-Silicon-(arm64)-hosts' target='_blank'>this guide</a>.",
                icon: "error",
                confirmButtonColor: '#d33',
                confirmButtonText: "OK"
              });
            } else {
              console.error('Error launching QGroundControl');
            }
          }
        } catch (err) {
          // aborted vs real error
          setBusy(false);
          modal.hide();
  
          if (err.name === 'AbortError') {
            if (typeof Swal !== 'undefined') {
              Swal.fire({
                title: "Launch canceled",
                icon: "info",
                timer: 1200,
                showConfirmButton: false
              });
            } else {
              console.log('QGC launch canceled');
            }
          } else {
            if (typeof Swal !== 'undefined') {
              Swal.fire({
                title: "Unexpected error",
                text: String(err),
                icon: "error"
              });
            } else {
              console.error('Error:', err);
            }
          }
        } finally {
          controller = null;
        }
      }
  
      launchBtn.addEventListener('click', launchQGC);
  
      // Cancel via button or the X
      cancelBtn.addEventListener('click', abortIfNeeded);
      closeXBtn.addEventListener('click', abortIfNeeded);
  
      // If user dismisses modal any other way, still abort
      modalEl.addEventListener('hidden.bs.modal', () => {
        if (inFlight) abortIfNeeded();
      });
    });
  </script>
{% endblock %}